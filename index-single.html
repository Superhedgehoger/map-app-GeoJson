<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoJSON 地图编辑器</title>
    <!-- FontAwesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <!-- Leaflet.draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"
        crossorigin="" />
    <!-- Tabulator CSS (dark theme) -->
    <link href="https://unpkg.com/tabulator-tables@5.5/dist/css/tabulator_midnight.min.css" rel="stylesheet">
    <!-- Custom Styles -->
    
    
    <!-- html2canvas for screenshot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
/* === style.css === */
/* ==== 全局变量 ==== */
:root {
    --primary-color: #1677FF;
    --primary-hover: #4096ff;
    --primary-active: #0958d9;
    /* 毛玻璃背景 - 更透明以确保 blur 可见 */
    --bg-glass: rgba(30, 30, 30, 0.65);
    --bg-glass-light: rgba(40, 40, 40, 0.55);
    --border-glass: rgba(255, 255, 255, 0.08);
    --border-glass-highlight: rgba(255, 255, 255, 0.12);
    --text-primary: #e0e0e0;
    --text-secondary: #888;
    --shadow-float: 0 10px 40px rgba(0, 0, 0, 0.35);
    --shadow-inset: inset 0 1px 0 rgba(255, 255, 255, 0.05);
    --radius-lg: 12px;
    --radius-md: 8px;
    --radius-sm: 6px;
    --gap-md: 16px;
    --gap-sm: 8px;
    --control-height: 36px;
    --font-mono: 'SF Mono', 'Consolas', 'Monaco', 'Courier New', monospace;
}

/* ==== 统一悬浮面板基类 ==== */
.floating-panel {
    /* 毛玻璃效果 */
    background: var(--bg-glass) !important;
    backdrop-filter: blur(14px) !important;
    -webkit-backdrop-filter: blur(14px) !important;

    /* 圆角与边框 */
    border-radius: var(--radius-lg) !important;
    border: 1px solid var(--border-glass) !important;

    /* 阴影：外阴影 + 内高光 */
    box-shadow:
        var(--shadow-float),
        var(--shadow-inset) !important;

    /* 文字颜色 */
    color: var(--text-primary) !important;
}

body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
    background-color: #121212;
    color: var(--text-primary);
    height: 100vh;
    overflow: hidden;
    position: relative;
}

/* ==== 地图全屏 ==== */
#map {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
}

/* ==== 左侧悬浮控制面板 ==== */
#controls {
    position: fixed;
    top: 16px;
    left: 16px;
    width: 280px;
    max-height: calc(100vh - 32px);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: width 0.3s ease, opacity 0.2s ease;
}

/* 应用悬浮面板基类样式 */
#controls:not(.collapsed) {
    background: var(--bg-glass);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    border: 1px solid var(--border-glass);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-float), var(--shadow-inset);
}

#controls .panel-content {
    flex: 1;
    overflow-y: auto;
    padding: 0 var(--gap-md) var(--gap-md);
}

/* ==== Dock 折叠模式 ==== */
#controls.collapsed {
    width: 56px;
    background: var(--bg-glass);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    border: 1px solid var(--border-glass);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-float);
}

/* 折叠时完全隐藏内容区域 */
#controls.collapsed .panel-header h2,
#controls.collapsed .panel-content {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
}

#controls.collapsed .panel-header {
    justify-content: center;
    padding: var(--gap-sm);
    border-bottom: none;
}

#controls.collapsed .btn-toggle-toolbar i {
    transform: rotate(180deg);
}

/* ==== Dock 图标列表 ==== */
/* 仅在折叠状态显示 */
#controls.collapsed .dock-icons {
    display: flex !important;
    flex-direction: column;
    gap: var(--gap-sm);
    padding: var(--gap-sm);
}

/* 展开时完全隐藏 Dock 图标 */
#controls:not(.collapsed) .dock-icons {
    display: none !important;
}

.dock-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-md);
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-glass);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.dock-icon:hover {
    background: var(--primary-color);
    color: white;
}

.dock-icon[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    left: 52px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.85);
    color: white;
    padding: 6px 12px;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    white-space: nowrap;
    z-index: 1001;
}

/* Dock 图标 FontAwesome 显示确保 */
.dock-icon i,
.dock-icon i.fa-solid,
.dock-icon i.fa-regular {
    font-size: 18px !important;
    color: inherit !important;
    opacity: 1 !important;
    display: inline-block !important;
    visibility: visible !important;
    line-height: 1 !important;
}

.dock-icon:hover i {
    color: white !important;
}

/* ==== 面板头部 ==== */
.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--gap-md);
    border-bottom: 1px solid var(--border-glass);
    flex-shrink: 0;
}

.panel-header h2 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: white;
}

.btn-toggle-toolbar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 255, 255, 0.08);
    color: var(--text-primary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-toggle-toolbar:hover {
    background: var(--primary-color);
    color: white;
}

.btn-toggle-toolbar i {
    transition: transform 0.3s ease;
}

/* ==== 右侧图层面板（悬浮卡片） ==== */
#layerPanel {
    position: fixed;
    top: 16px;
    right: 16px;
    width: 320px;
    max-height: calc(100vh - 32px);
    z-index: 1000;
    display: none;
    flex-direction: column;
    overflow: hidden;
}

#layerPanel.open {
    display: flex;
}

/* 图层面板固定头部 */
.layer-panel-header {
    flex-shrink: 0;
    padding: var(--gap-md);
    border-bottom: 1px solid var(--border-glass);
}

.layer-panel-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.layer-panel-title h2 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: white;
    display: flex;
    align-items: center;
    gap: 8px;
}

.layer-panel-title h2 i {
    color: var(--primary-color);
}

/* 图层搜索框 */
.layer-search-box {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-glass);
    border-radius: var(--radius-sm);
    padding: 0 12px;
    height: var(--control-height);
}

.layer-search-box i {
    color: var(--text-secondary);
    font-size: 0.85rem;
}

.layer-search-box input {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text-primary);
    font-size: 0.85rem;
    outline: none;
}

.layer-search-box input::placeholder {
    color: var(--text-secondary);
}

.btn-clear-search {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px;
}

.btn-clear-search:hover {
    color: var(--text-primary);
}

/* 图层面板可滚动内容区域 */
.layer-panel-content {
    flex: 1;
    overflow-y: auto;
    padding: 0;
}

/* 图层分组（可折叠） */
.layer-section {
    border-bottom: 1px solid var(--border-glass);
}

.layer-section:last-child {
    border-bottom: none;
}

.layer-section-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px var(--gap-md);
    cursor: pointer;
    transition: background 0.2s;
    user-select: none;
}

.layer-section-header:hover {
    background: rgba(255, 255, 255, 0.03);
}

.layer-section-header h3 {
    margin: 0;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-primary);
    flex: 1;
    display: flex;
    align-items: center;
    gap: 8px;
}

.layer-section-header h3 i {
    color: var(--primary-color);
    width: 16px;
    text-align: center;
}

.layer-section-count {
    background: var(--primary-color);
    color: white;
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
}

.section-toggle {
    color: var(--text-secondary);
    transition: transform 0.2s;
    font-size: 0.75rem;
}

.layer-section.collapsed .section-toggle {
    transform: rotate(-90deg);
}

.layer-section-content {
    padding: 0 var(--gap-md) var(--gap-md);
}

.layer-section.collapsed .layer-section-content {
    display: none;
}

/* 图层列表滚动区域 */
.layer-list-scroll {
    max-height: 40vh;
    overflow-y: auto;
}

/* ==== Accordion 手风琴 ==== */
.accordion-section {
    border-bottom: 1px solid var(--border-glass);
}

.accordion-section:last-child {
    border-bottom: none;
}

.accordion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px var(--gap-md);
    cursor: pointer;
    transition: background 0.2s;
    user-select: none;
}

.accordion-header:hover {
    background: rgba(255, 255, 255, 0.03);
}

.accordion-header h3 {
    margin: 0;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--gap-sm);
}

.accordion-header h3 i {
    color: var(--primary-color);
    width: 18px;
    text-align: center;
}

.accordion-header .collapse-icon {
    color: var(--text-secondary);
    transition: transform 0.2s;
}

.accordion-section.collapsed .accordion-header .collapse-icon {
    transform: rotate(-90deg);
}

.accordion-content {
    padding: 0 var(--gap-md) var(--gap-md);
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.accordion-section.collapsed .accordion-content {
    display: none;
}

.btn-toggle-toolbar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: none;
    background: #3d3d3d;
    color: #e0e0e0;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, transform 0.2s;
}

.btn-toggle-toolbar:hover {
    background: #4a9eff;
}

.btn-toggle-toolbar i {
    transition: transform 0.3s ease;
}

#layerPanel {
    border-left: 1px solid #333;
    display: none;
    /* Hidden by default, toggled by button */
}

/* Editor Panel Overlay */
#editorPanel {
    position: absolute;
    bottom: 20px;
    left: 340px;
    right: 20px;
    height: 400px;
    background: rgba(30, 30, 30, 0.98);
    backdrop-filter: blur(10px);
    border: 1px solid #444;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
    z-index: 1001;
    display: flex;
    flex-direction: column;
}

#geojsonEditor {
    width: 100%;
    height: 300px;
    background: #121212;
    color: #f0f0f0;
    border: 1px solid #444;
    border-radius: 6px;
    padding: 10px;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.9rem;
    resize: none;
    margin-bottom: 15px;
    flex-grow: 1;
    line-height: 1.5;
}

.panel h2 {
    margin-top: 0;
    font-size: 1rem;
    color: #fff;
    text-align: center;
    margin-bottom: var(--gap-md);
    font-weight: 600;
    letter-spacing: 0.5px;
}

/* ==== 控件组样式 ==== */
.control-group {
    display: flex;
    flex-direction: column;
    gap: var(--gap-sm);
}

.control-group label {
    font-size: 0.8rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.control-group select,
.control-group input[type="file"],
.control-group input[type="number"],
.control-group input[type="text"] {
    height: var(--control-height);
    padding: 0 12px;
    border: 1px solid var(--border-glass);
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    outline: none;
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-primary);
    transition: border-color 0.2s, background 0.2s;
}

.control-group select:focus,
.control-group input:focus {
    border-color: var(--primary-color);
    background: rgba(255, 255, 255, 0.08);
}

.control-group input[type="file"] {
    padding: 8px;
    height: auto;
}

/* ==== 按钮系统 ==== */
/* 主按钮（Primary） */
.control-group button,
.btn-primary {
    height: var(--control-height);
    padding: 0 16px;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    background: var(--primary-color);
    color: white;
}

.control-group button:hover,
.btn-primary:hover {
    background: var(--primary-hover);
    transform: translateY(-1px);
}

.control-group button:active,
.btn-primary:active {
    background: var(--primary-active);
    transform: translateY(0);
}

/* 次按钮（Secondary / Outline） */
.btn-secondary,
.btn-outline {
    height: var(--control-height);
    padding: 0 16px;
    border: 1px solid var(--border-glass);
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    background: transparent;
    color: var(--text-primary);
}

.btn-secondary:hover,
.btn-outline:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: var(--primary-color);
    color: var(--primary-color);
}

/* 文字按钮（Text） */
.btn-text {
    height: var(--control-height);
    padding: 0 12px;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    background: transparent;
    color: var(--text-secondary);
}

.btn-text:hover {
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-primary);
}

/* 按钮行 */
.btn-row {
    flex-direction: row !important;
    gap: var(--gap-sm);
}

.btn-row button {
    flex: 1;
}

/* Checkbox 样式 */
.control-group input[type="checkbox"] {
    margin-right: 8px;
    cursor: pointer;
    accent-color: var(--primary-color);
}

/* 等宽数字 */
.mono,
.coordinates,
.lat-lng {
    font-family: var(--font-mono);
}

/* ==== 输入框组合样式 ==== */
.input-with-btn {
    display: flex;
    gap: var(--gap-sm);
}

.input-with-btn input {
    flex: 1;
}

.input-with-btn button {
    width: var(--control-height);
    padding: 0;
    flex-shrink: 0;
}

.coord-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--gap-sm);
}

/* 图标按钮 */
.btn-icon {
    width: 28px;
    height: 28px;
    padding: 0;
    border: none;
    border-radius: var(--radius-sm);
    background: rgba(255, 255, 255, 0.08);
    color: var(--text-secondary);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-icon:hover {
    background: var(--primary-color);
    color: white;
}

/* 拾取的坐标显示 */
.picked-coords {
    font-size: 0.75rem;
    color: var(--text-secondary);
    padding: 8px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: var(--radius-sm);
    min-height: 20px;
}

/* Accordion header actions */
.accordion-header-actions {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Checkbox 行 */
.checkbox-row label {
    display: flex;
    align-items: center;
    cursor: pointer;
}

/* ==== 地图缩放控件（左下角） ==== */
.leaflet-control-zoom {
    border: none !important;
    box-shadow: var(--shadow-float) !important;
    margin-left: 16px !important;
    margin-bottom: 16px !important;
}

.leaflet-control-zoom a {
    background: var(--bg-glass) !important;
    backdrop-filter: blur(16px) !important;
    -webkit-backdrop-filter: blur(16px) !important;
    border: 1px solid var(--border-glass) !important;
    color: var(--text-primary) !important;
    /* 增大点击区域到 44x44px */
    width: 44px !important;
    height: 44px !important;
    line-height: 44px !important;
    font-size: 20px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

.leaflet-control-zoom a:hover {
    background: var(--primary-color) !important;
    color: white !important;
}

.leaflet-control-zoom-in {
    border-radius: var(--radius-md) var(--radius-md) 0 0 !important;
    border-bottom: none !important;
}

.leaflet-control-zoom-out {
    border-radius: 0 0 var(--radius-md) var(--radius-md) !important;
}

/* 隐藏分隔线 */
.divider,
hr.divider {
    display: none;
}

/* ==== 自定义滚动条 ==== */
.panel-content::-webkit-scrollbar,
#layerList::-webkit-scrollbar,
.accordion-content::-webkit-scrollbar {
    width: 6px;
}

.panel-content::-webkit-scrollbar-track,
#layerList::-webkit-scrollbar-track,
.accordion-content::-webkit-scrollbar-track {
    background: transparent;
}

.panel-content::-webkit-scrollbar-thumb,
#layerList::-webkit-scrollbar-thumb,
.accordion-content::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 3px;
}

.panel-content::-webkit-scrollbar-thumb:hover,
#layerList::-webkit-scrollbar-thumb:hover,
.accordion-content::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.25);
}

/* Layer list items */
#layerList {
    max-height: calc(100vh - 100px);
    overflow-y: auto;
}

.layer-item {
    background: rgba(255, 255, 255, 0.03);
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 6px;
    border-left: 3px solid #4a90e2;
    font-size: 0.85rem;
    transition: background 0.2s;
}

.layer-item:hover {
    background: rgba(255, 255, 255, 0.06);
}

.layer-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.layer-name {
    font-weight: 600;
    color: #f0f0f0;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-right: 8px;
}

.layer-type {
    font-size: 0.75rem;
    color: #888;
    background: rgba(0, 0, 0, 0.2);
    padding: 2px 6px;
    border-radius: 4px;
}

.layer-actions {
    display: flex;
    gap: 6px;
}

.layer-btn {
    padding: 4px 8px;
    font-size: 0.75rem;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 4px;
    color: #ccc;
    cursor: pointer;
    transition: all 0.2s;
}

.layer-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
}

.layer-btn.delete {
    background: rgba(231, 76, 60, 0.2);
    color: #e74c3c;
}

.layer-btn.delete:hover {
    background: #e74c3c;
    color: #fff;
}

/* Leaflet map container adjustments */
.leaflet-container {
    background: #0e0e0e;
}

/* Divider */
.divider {
    border: 0;
    height: 1px;
    background: linear-gradient(to right, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
    margin: 20px 0;
}

/* Scrollbar styling */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
}

::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.25);
}

/* Layer labels */
.layer-label {
    background: rgba(0, 0, 0, 0.8) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 4px !important;
    color: #fff !important;
    font-size: 0.85rem !important;
    padding: 4px 8px !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5) !important;
    font-family: 'Segoe UI', sans-serif !important;
}

.layer-label::before {
    border-top-color: rgba(0, 0, 0, 0.8) !important;
    line-height: 1.5;
}

.panel h2 {
    margin-top: 0;
    font-size: 1.1rem;
    color: #fff;
    text-align: center;
    margin-bottom: 15px;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.control-group {
    margin-bottom: 15px;
    display: flex;
    flex-direction: column;
}

.control-group label {
    font-size: 0.85rem;
    margin-bottom: 6px;
    color: #aaa;
}

.control-group select,
.control-group input[type="file"],
.control-group input[type="number"],
.control-group input[type="text"],
.control-group button {
    padding: 8px 10px;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    outline: none;
}

.control-group select,
.control-group input[type="number"],
.control-group input[type="text"] {
    background: #2c2c2c;
    color: #e0e0e0;
    border: 1px solid #444;
    transition: border-color 0.2s;
}

.control-group select:focus,
.control-group input:focus {
    border-color: #4a90e2;
}

.control-group button {
    background: #4a90e2;
    color: #fff;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
}

.control-group button:hover {
    background: #357ab8;
    transform: translateY(-1px);
}

.control-group button:active {
    transform: translateY(0);
}

.control-group input[type="checkbox"] {
    margin-right: 8px;
    cursor: pointer;
}

/* Layer list items */
#layerList {
    max-height: calc(100vh - 100px);
    overflow-y: auto;
}

.layer-item {
    background: rgba(255, 255, 255, 0.03);
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 6px;
    border-left: 3px solid #4a90e2;
    font-size: 0.85rem;
    transition: background 0.2s;
}

.layer-item:hover {
    background: rgba(255, 255, 255, 0.06);
}

.layer-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.layer-name {
    font-weight: 600;
    color: #f0f0f0;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-right: 8px;
}

.layer-type {
    font-size: 0.75rem;
    color: #888;
    background: rgba(0, 0, 0, 0.2);
    padding: 2px 6px;
    border-radius: 4px;
}

.layer-actions {
    display: flex;
    gap: 6px;
}

.layer-btn {
    padding: 4px 8px;
    font-size: 0.75rem;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 4px;
    color: #ccc;
    cursor: pointer;
    transition: all 0.2s;
}

.layer-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
}

.layer-btn.delete {
    background: rgba(231, 76, 60, 0.2);
    color: #e74c3c;
}

.layer-btn.delete:hover {
    background: #e74c3c;
    color: #fff;
}

/* Leaflet map container adjustments */
.leaflet-container {
    background: #0e0e0e;
}

/* Divider */
.divider {
    border: 0;
    height: 1px;
    background: linear-gradient(to right, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
    margin: 20px 0;
}

/* Scrollbar styling */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
}

::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.25);
}

/* Layer labels */
.layer-label {
    background: rgba(0, 0, 0, 0.8) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 4px !important;
    color: #fff !important;
    font-size: 0.85rem !important;
    padding: 4px 8px !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5) !important;
    font-family: 'Segoe UI', sans-serif !important;
}

.layer-label::before {
    border-top-color: rgba(0, 0, 0, 0.8) !important;
}

/* Context Menu */
.context-menu {
    position: absolute;
    background: rgba(35, 35, 35, 0.98);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 8px;
    padding: 6px 0;
    min-width: 160px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
    z-index: 10000;
}

.context-menu-item {
    padding: 10px 16px;
    cursor: pointer;
    color: #e0e0e0;
    font-size: 0.9rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
}

.context-menu-item:hover {
    background: rgba(74, 144, 226, 0.2);
    color: #fff;
}

/* ==== Leaflet Draw 工具栏 - 玻璃风格 ==== */
.leaflet-draw-section {
    background: var(--bg-glass) !important;
    backdrop-filter: blur(14px) !important;
    -webkit-backdrop-filter: blur(14px) !important;
    border-radius: var(--radius-md) !important;
    border: 1px solid var(--border-glass) !important;
    box-shadow: var(--shadow-float) !important;
    overflow: hidden;
}

.leaflet-draw-toolbar {
    background: transparent !important;
    border: none !important;
}

.leaflet-draw-toolbar a,
.leaflet-draw-actions a {
    /* 尺寸: 内容30px + padding 4px = 38px */
    width: 38px !important;
    height: 38px !important;
    padding: 4px !important;
    /* 用于居中 Sprite */

    /* 关键设置：让 Sprite 坐标相对于内容框计算 */
    background-origin: content-box !important;
    background-clip: content-box !important;
    background-color: rgba(255, 255, 255, 0.95) !important;
    background-repeat: no-repeat !important;

    /* 移除 background-position 和 background-size 的强制覆盖 */

    /* 布局 */
    display: block !important;
    position: relative !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    border-radius: 4px !important;
    margin-bottom: 3px !important;
    box-sizing: border-box !important;

    /* 隐藏文字 */
    font-size: 0 !important;
    color: transparent !important;
    text-indent: -9999px !important;
    overflow: hidden !important;
}

/* 隐藏按钮内部的所有子元素及伪元素 */
.leaflet-draw-toolbar a>*,
.leaflet-draw-actions a>*,
.leaflet-draw-toolbar a::before,
.leaflet-draw-actions a::before,
.leaflet-draw-toolbar a::after,
.leaflet-draw-actions a::after {
    display: none !important;
    content: none !important;
}

.leaflet-draw-toolbar a:hover,
.leaflet-draw-actions a:hover {
    background-color: var(--primary-color) !important;
    color: white !important;
}

/* Disabled state */
.leaflet-draw-toolbar .leaflet-disabled {
    background-color: rgba(200, 200, 200, 0.5) !important;
    border-color: rgba(100, 100, 100, 0.3) !important;
}

.leaflet-draw-toolbar .leaflet-disabled>* {
    opacity: 0.5 !important;
}

/* Leaflet Draw 工具栏定位 - 避免被左侧面板遮挡 */
.leaflet-draw {
    z-index: 999 !important;
}

/* 重置 Leaflet 默认的控件容器定位 */
.leaflet-top.leaflet-left {
    /* 默认状态：面板展开时 */
    /* 面板宽度 280px + 左偏移 16px + 间距 16px = 312px */
    left: 312px !important;
    top: 16px !important;
}

/* 折叠状态：使用 body 类选择器 */
/* 折叠后 Dock 宽度 56px + 左偏移 16px + 间距 16px = 88px */
body.ui-collapsed .leaflet-top.leaflet-left {
    left: 88px !important;
}

/* 确保工具栏本身没有额外偏移 */
.leaflet-left .leaflet-draw {
    margin-left: 0 !important;
    margin-top: 0 !important;
}

/* Custom Marker Icon Container */
.custom-marker-icon {
    background: transparent !important;
    border: none !important;
}

.custom-marker-wrapper {
    position: relative;
    width: 30px;
    height: 42px;
}

.custom-marker-circle {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
    border: 2px solid rgba(255, 255, 255, 0.9);
    position: relative;
    z-index: 2;
    transition: transform 0.2s;
}

.custom-marker-circle:hover {
    transform: scale(1.1);
}

.custom-marker-circle i {
    color: white;
    font-size: 14px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.custom-marker-tip {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 10px solid;
    z-index: 1;
    filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.3));
}

/* ===== Event Tracker Panel ===== */
#eventTrackerPanel {
    width: 320px;
    border-left: 1px solid #333;
    display: none;
}


.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.panel-header h2 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 600;
    letter-spacing: 0.5px;
    flex: 1;
}

#closeEventTrackerBtn {
    background: #e74c3c;
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    transition: all 0.2s;
    font-size: 0.9rem;
    cursor: pointer;
    font-weight: 500;
    z-index: 10;
    position: relative;
}

#closeEventTrackerBtn:hover {
    background: #c0392b;
    transform: translateY(-1px);
}


.tracker-section {
    margin-bottom: 25px;
}

.tracker-section h3 {
    font-size: 0.9rem;
    color: #4a90e2;
    margin: 0 0 12px 0;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Card-style Lists */
.todo-item,
.url-item,
.timeline-event {
    background: #252525;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.todo-item:hover,
.url-item:hover,
.timeline-event:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    border-color: #4a90e2;
}

/* Component Styles */
.todo-input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.url-input-group,
.timeline-input-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 15px;
}

.todo-input-group input {
    flex: 1;
    min-width: 0;
}

.url-input-group input[type="text"],
.url-input-group input[type="url"] {
    flex: 1 1 100%;
    min-width: 0;
}

.timeline-input-group input[type="datetime-local"] {
    flex: 1 1 45%;
    min-width: 120px;
}

.timeline-input-group input[type="text"] {
    flex: 1 1 45%;
    min-width: 80px;
}

.todo-input-group input,
.url-input-group input,
.timeline-input-group input {
    background: #1a1a1a;
    border: 1px solid #444;
    padding: 10px 12px;
    border-radius: 6px;
    color: #fff;
    font-size: 0.9rem;
    transition: border-color 0.2s;
}


.timeline-input-group input[type="datetime-local"] {
    font-family: 'Consolas', monospace;
    color-scheme: dark;
}

.todo-input-group input:focus,
.url-input-group input:focus,
.timeline-input-group input:focus {
    border-color: #4a90e2;
    outline: none;
}

.todo-input-group button,
.url-input-group button,
.timeline-input-group button {
    background: #4a90e2;
    color: white;
    border: none;
    width: 38px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    font-weight: normal;
    padding: 0;
}

.todo-input-group button:hover,
.url-input-group button:hover,
.timeline-input-group button:hover {
    background: #357ab8;
    transform: translateY(-1px);
}

/* Specific Item Tweaks */
.todo-item {
    display: flex;
    align-items: center;
    gap: 12px;
}

.todo-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #4a90e2;
}

.todo-item-text {
    flex: 1;
    font-size: 0.95rem;
    line-height: 1.4;
    color: #e0e0e0;
}

.todo-item-text.completed {
    color: #666;
    text-decoration: line-through;
}

.todo-item-time {
    font-size: 0.75rem;
    color: #666;
    margin-left: 8px;
    white-space: nowrap;
}

.todo-item-delete,
.url-item-delete,
.timeline-event-delete {
    background: transparent;
    color: #666;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    padding: 6px;
    border-radius: 4px;
    transition: all 0.2s;
}

.todo-item-delete:hover,
.url-item-delete:hover,
.timeline-event-delete:hover {
    background: rgba(231, 76, 60, 0.2);
    color: #e74c3c;
}

/* URL Items */
.url-item {
    display: flex;
    align-items: center;
    gap: 12px;
}

.url-item a {
    flex: 1;
    color: #4a90e2;
    text-decoration: none;
    font-size: 0.95rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.url-item a:hover {
    text-decoration: underline;
}

/* Timeline specific */
.timeline-event {
    border-left: 3px solid #4a90e2;
    padding-left: 15px;
    padding-right: 35px;
    /* Make room for delete button */
}

/* Remove old dot styles as we are using cards now */
.timeline-event::before {
    display: none;
}

#timelineDisplay {
    padding-left: 0;
}

.timeline-event-date {
    font-family: 'Consolas', monospace;
    font-size: 0.85rem;
    color: #4a90e2;
    margin-bottom: 6px;
    font-weight: bold;
}

.timeline-event-title {
    font-size: 1rem;
    font-weight: 500;
    color: #e0e0e0;
    margin-bottom: 4px;
}

.timeline-event-description {
    font-size: 0.85rem;
    color: #aaa;
    line-height: 1.4;
    margin-top: 4px;
}

.timeline-event-delete {
    position: absolute;
    top: 10px;
    right: 10px;
}

/* Notes Textarea */
#eventNotes {
    width: 100%;
    background: #1a1a1a;
    color: #e0e0e0;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 12px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 0.95rem;
    resize: vertical;
    outline: none;
    min-height: 100px;
    transition: border-color 0.2s;
}

#eventNotes:focus {
    border-color: #4a90e2;
}

/* Save Button */
#saveEventDataBtn {
    width: 100%;
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    color: white;
    border: none;
    padding: 12px;
    border-radius: 6px;
    font-weight: 600;
    margin-top: 10px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(46, 204, 113, 0.2);
    transition: all 0.2s;
    font-size: 1rem;
}

#saveEventDataBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(46, 204, 113, 0.3);
}

.timeline-input-group input[type="text"] {
    flex: 2;
}

.timeline-input-group input[type="datetime-local"] {
    flex: 1.5;
}

/* ==== Event List View Styles ==== */
#eventListView {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

#eventListContainer {
    flex: 1;
    overflow-y: auto;
    max-height: calc(100vh - 250px);
    padding-right: 5px;
}

.event-card {
    background: #252525;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 12px 15px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.event-card:hover {
    border-color: #4a90e2;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.event-card-info {
    flex: 1;
}

.event-card-date {
    font-size: 0.8rem;
    color: #4a90e2;
    margin-bottom: 4px;
    font-family: 'Consolas', monospace;
}

.event-card-name {
    font-size: 1rem;
    font-weight: 500;
    color: #e0e0e0;
}

.event-card-actions {
    display: flex;
    gap: 8px;
}

.event-card-actions button {
    padding: 6px 12px;
    font-size: 0.8rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-edit {
    background: #4a90e2;
    color: white;
}

.btn-edit:hover {
    background: #357ab8;
}

.btn-delete {
    background: transparent;
    color: #e74c3c;
    border: 1px solid #e74c3c !important;
}

.btn-delete:hover {
    background: #e74c3c;
    color: white;
}

.btn-add-event {
    width: 100%;
    padding: 12px;
    margin-top: 15px;
    background: linear-gradient(135deg, #4a90e2, #357ab8);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-add-event:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
}

/* Event Edit View */
#eventEditView {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.edit-view-header {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    align-items: center;
}

.btn-back {
    padding: 8px 12px;
    background: transparent;
    border: 1px solid #444;
    color: #aaa;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
}

.btn-back:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

#currentEventName {
    flex: 1;
    padding: 10px 12px;
    background: #1a1a1a;
    border: 1px solid #444;
    border-radius: 6px;
    color: #fff;
    font-size: 1rem;
    font-weight: 500;
}

#currentEventName:focus {
    border-color: #4a90e2;
    outline: none;
}

.scrollable-content {
    flex: 1;
    overflow-y: auto;
    padding-right: 5px;
    max-height: calc(100vh - 320px);
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 15px;
    color: #444;
}

.empty-state p {
    font-size: 0.95rem;
}

/* ==== Archive Section Styles ==== */
.archive-section {
    margin-top: 10px;
}

.archive-section h3 {
    font-size: 0.9rem;
    color: #aaa;
    margin-bottom: 10px;
}

.archive-controls {
    display: flex;
    gap: 8px;
    align-items: center;
}

.archive-controls select {
    flex: 1;
    padding: 8px;
    background: #1a1a1a;
    border: 1px solid #444;
    border-radius: 4px;
    color: #fff;
    font-size: 0.85rem;
}

.archive-controls button {
    padding: 8px 12px;
    font-size: 0.85rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.archive-controls button:first-of-type {
    background: #4a90e2;
    color: white;
}

.archive-controls button:last-of-type {
    background: #2ecc71;
    color: white;
}

.archive-controls button:hover {
    opacity: 0.85;
    transform: translateY(-1px);
}

.archive-hint {
    font-size: 0.75rem;
    color: #666;
    margin-top: 8px;
    font-style: italic;
}

/* ==== New Archive Management Styles ==== */
.archive-create {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
}

.archive-create input {
    flex: 1;
    padding: 8px 10px;
    background: #1a1a1a;
    border: 1px solid #444;
    border-radius: 4px;
    color: #fff;
    font-size: 0.85rem;
}

.archive-create button {
    padding: 8px 14px;
    background: #4a90e2;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.archive-create button:hover {
    background: #357ab8;
}

.archive-list {
    max-height: 200px;
    overflow-y: auto;
}

.archive-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    background: #252525;
    border-radius: 4px;
    margin-bottom: 6px;
    border: 1px solid #333;
}

.archive-item:hover {
    border-color: #4a90e2;
}

.archive-item-name {
    flex: 1;
    font-size: 0.85rem;
    color: #e0e0e0;
}

.archive-item-date {
    font-size: 0.7rem;
    color: #666;
    margin-right: 10px;
}

.archive-item-actions {
    display: flex;
    gap: 5px;
}

.archive-item-actions button {
    padding: 4px 8px;
    font-size: 0.75rem;
    border: none;
    border-radius: 3px;
    cursor: pointer;
}

.archive-item-actions .load-btn {
    background: #2ecc71;
    color: white;
}

.archive-item-actions .delete-btn {
    background: transparent;
    color: #e74c3c;
    border: 1px solid #e74c3c;
}

.current-archive {
    margin-top: 12px;
    padding: 10px;
    background: rgba(74, 144, 226, 0.15);
    border: 1px solid #4a90e2;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.current-archive span {
    font-size: 0.85rem;
    color: #4a90e2;
}

.current-archive button {
    padding: 6px 12px;
    background: #4a90e2;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

/* ==== Attachment Styles ==== */
.attachment-upload {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.attachment-upload input[type="file"] {
    display: none;
}

.upload-btn {
    padding: 8px 14px;
    background: #4a90e2;
    color: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
}

.upload-btn:hover {
    background: #357ab8;
}

.upload-hint {
    font-size: 0.75rem;
    color: #666;
}

.attachment-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.attachment-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    background: #252525;
    border-radius: 4px;
    border: 1px solid #333;
}

.attachment-item-info {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
}

.attachment-item-icon {
    font-size: 1.2rem;
}

.attachment-item-name {
    font-size: 0.85rem;
    color: #e0e0e0;
}

.attachment-item-size {
    font-size: 0.7rem;
    color: #666;
}

.attachment-item-actions {
    display: flex;
    gap: 5px;
}

.attachment-item-actions button {
    padding: 4px 8px;
    font-size: 0.75rem;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    background: #4a90e2;
    color: white;
}

.attachment-item-actions .delete-btn {
    background: transparent;
    color: #e74c3c;
    border: 1px solid #e74c3c;
}

/* ==== Icon Picker Modal ==== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 3000;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
}

.icon-picker-modal {
    background: #2a2a2a;
    border-radius: 12px;
    width: 420px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    border: 1px solid #444;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid #444;
}

.modal-header h3 {
    margin: 0;
    color: #fff;
    font-size: 1.1rem;
}

.btn-close-modal {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background: #444;
    color: #fff;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

.btn-close-modal:hover {
    background: #e74c3c;
}

.icon-preview-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    background: #222;
}

.icon-preview {
    transform: scale(2);
    margin: 10px 0 20px;
}

#selectedIconLabel {
    color: #aaa;
    font-size: 0.9rem;
}

.picker-section {
    padding: 16px 20px;
    border-top: 1px solid #333;
}

.picker-section label {
    display: block;
    color: #aaa;
    font-size: 0.85rem;
    margin-bottom: 10px;
}

.color-palette {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.color-swatch {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.2s, border-color 0.2s;
}

.color-swatch:hover {
    transform: scale(1.15);
}

.color-swatch.selected {
    border-color: #fff;
    box-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
}

.icon-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
    max-height: 200px;
    overflow-y: auto;
}

.icon-option {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #333;
    border-radius: 8px;
    cursor: pointer;
    color: #ccc;
    font-size: 1.1rem;
    border: 2px solid transparent;
    transition: background 0.2s, transform 0.2s, border-color 0.2s;
}

.icon-option:hover {
    background: #444;
    transform: scale(1.1);
}

.icon-option.selected {
    border-color: #4a90e2;
    background: #3a3a3a;
    color: #4a90e2;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 16px 20px;
    border-top: 1px solid #444;
}

.btn-cancel {
    padding: 8px 20px;
    border-radius: 6px;
    border: 1px solid #555;
    background: transparent;
    color: #ccc;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-cancel:hover {
    background: #333;
}

.btn-apply {
    padding: 8px 24px;
    border-radius: 6px;
    border: none;
    background: #4a90e2;
    color: #fff;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.2s;
}

.btn-apply:hover {
    background: #3a80d2;
}

/* ==== Import Modal ==== */
.import-modal {
    background: #2a2a2a;
    border-radius: 12px;
    width: 400px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    border: 1px solid #444;
}

.import-stats {
    padding: 16px 20px;
    background: #222;
}

.import-stats h4 {
    margin: 0 0 12px 0;
    color: #aaa;
    font-size: 0.9rem;
    font-weight: normal;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #333;
    border-radius: 6px;
}

.stat-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
}

.stat-icon.point {
    background: #4a90e2;
}

.stat-icon.line {
    background: #e2a04a;
}

.stat-icon.polygon {
    background: #4ae24a;
}

.stat-icon.other {
    background: #9b4ae2;
}

.stat-info {
    flex: 1;
}

.stat-count {
    font-size: 1.1rem;
    font-weight: 600;
    color: #fff;
}

.stat-label {
    font-size: 0.75rem;
    color: #888;
}

.import-mode-section {
    padding: 16px 20px;
    border-top: 1px solid #333;
}

.import-mode-section>label {
    display: block;
    color: #aaa;
    font-size: 0.85rem;
    margin-bottom: 10px;
}

.import-mode-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.radio-option {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    padding: 12px;
    background: #333;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
}

.radio-option:hover {
    background: #3a3a3a;
}

.radio-option input[type="radio"] {
    width: 18px;
    height: 18px;
    accent-color: #4a90e2;
}

.radio-label {
    font-weight: 500;
    color: #fff;
}

.radio-option small {
    width: 100%;
    margin-left: 26px;
    color: #888;
    font-size: 0.8rem;
}

/* ==== Enhanced Layer List ==== */
.layer-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 8px;
    background: #2a2a2a;
    border-radius: 8px;
    margin-bottom: 8px;
    border: 1px solid #333;
}

.layer-btn-main {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    padding: 8px 10px;
    border: none;
    border-radius: 6px;
    background: #333;
    color: #e0e0e0;
    cursor: pointer;
    text-align: left;
    transition: background 0.2s, transform 0.1s;
}

.layer-btn-main:hover {
    background: #3d3d3d;
    transform: translateX(2px);
}

.layer-icon {
    font-size: 1rem;
    width: 24px;
    text-align: center;
}

.layer-btn-main .layer-name {
    flex: 1;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.layer-btn-main .layer-type {
    font-size: 0.75rem;
    color: #888;
    background: #444;
    padding: 2px 6px;
    border-radius: 4px;
}

.event-badge {
    background: #4a90e2;
    color: white;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 600;
}

.layer-actions {
    display: flex;
    gap: 4px;
    justify-content: flex-end;
}

.layer-actions .layer-btn {
    width: 28px;
    height: 28px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    border-radius: 4px;
    background: #3a3a3a;
    color: #aaa;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}

.layer-actions .layer-btn:hover {
    background: #4a90e2;
    color: white;
}

.layer-actions .layer-btn.delete:hover {
    background: #e74c3c;
}

/* ==== Marker Popup Enhancements ==== */
.marker-popup h3 {
    margin: 0 0 8px 0;
    font-size: 1rem;
    color: #333;
}

.marker-popup p {
    margin: 0 0 10px 0;
    font-size: 0.85rem;
    color: #555;
    line-height: 1.5;
}

.btn-copy {
    padding: 2px 8px;
    font-size: 0.75rem;
    border: none;
    border-radius: 3px;
    background: #4a90e2;
    color: white;
    cursor: pointer;
    margin-left: 4px;
}

.btn-copy:hover {
    background: #3a80d2;
}

.popup-events {
    background: #f5f5f5;
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 10px;
}

.popup-events-header {
    font-weight: 600;
    color: #333;
    font-size: 0.85rem;
    margin-bottom: 8px;
    padding-bottom: 6px;
    border-bottom: 1px solid #ddd;
}

.popup-event-item {
    display: flex;
    gap: 8px;
    align-items: center;
    padding: 4px 0;
    font-size: 0.8rem;
}

.popup-event-date {
    color: #4a90e2;
    font-weight: 500;
    font-size: 0.75rem;
}

.popup-event-name {
    color: #333;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.popup-event-more {
    text-align: center;
    color: #888;
    font-size: 0.75rem;
    font-style: italic;
    margin-top: 6px;
}

.popup-actions {
    display: flex;
    gap: 6px;
}

.btn-popup-action {
    flex: 1;
    padding: 6px 10px;
    border: none;
    border-radius: 4px;
    background: #4a90e2;
    color: white;
    cursor: pointer;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    transition: background 0.2s;
}

.btn-popup-action:hover {
    background: #3a80d2;
}

/* ==== Share Modal ==== */
.btn-share {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: transform 0.2s, box-shadow 0.2s;
}

.btn-share:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-row {
    display: flex;
    gap: 8px;
}

.btn-row button {
    flex: 1;
}

.share-modal {
    background: #2a2a2a;
    border-radius: 12px;
    width: 420px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    border: 1px solid #444;
}

.share-preview-section {
    padding: 20px;
    background: #1a1a1a;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 200px;
}

.share-loading {
    color: #888;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.share-preview-image {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
}

.share-options {
    display: flex;
    gap: 10px;
    padding: 20px;
}

.share-option-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px 12px;
    border: 1px solid #444;
    border-radius: 10px;
    background: #333;
    color: #e0e0e0;
    cursor: pointer;
    transition: all 0.2s;
}

.share-option-btn:hover {
    background: #3d3d3d;
    border-color: #4a90e2;
    transform: translateY(-2px);
}

.share-option-btn i {
    font-size: 1.4rem;
    color: #4a90e2;
}

.share-option-btn span {
    font-size: 0.85rem;
}

.share-status {
    padding: 12px 20px;
    margin: 0 20px 20px;
    border-radius: 6px;
    font-size: 0.9rem;
    text-align: center;
}

.share-status.success {
    background: rgba(46, 204, 113, 0.2);
    color: #2ecc71;
    border: 1px solid rgba(46, 204, 113, 0.3);
}

.share-status.error {
    background: rgba(231, 76, 60, 0.2);
    color: #e74c3c;
    border: 1px solid rgba(231, 76, 60, 0.3);
}

/* ==== Property Drawer (Side Panel) ==== */
.property-drawer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    pointer-events: none;
}

.property-drawer.active {
    pointer-events: all;
}

.drawer-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0);
    transition: background 0.3s ease;
    pointer-events: none;
}

.property-drawer.active .drawer-overlay {
    background: rgba(0, 0, 0, 0.5);
    pointer-events: all;
}

.drawer-content {
    position: absolute;
    top: 0;
    right: -400px;
    width: 400px;
    max-width: 90vw;
    height: 100%;
    background: #2a2a2a;
    box-shadow: -4px 0 16px rgba(0, 0, 0, 0.3);
    transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.property-drawer.active .drawer-content {
    right: 0;
}

.drawer-header {
    padding: 20px;
    background: #333;
    border-bottom: 1px solid #444;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
}

.drawer-header h2 {
    margin: 0;
    font-size: 1.3rem;
    color: #fff;
}

.btn-close-drawer {
    width: 36px;
    height: 36px;
    border: none;
    border-radius: 50%;
    background: #444;
    color: #fff;
    font-size: 1.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-close-drawer:hover {
    background: #e74c3c;
    transform: rotate(90deg);
}

.drawer-body {
    height: calc(100vh - 200px);
    max-height: 800px;
    overflow-y: auto;
    padding: 20px;
}

.drawer-body::-webkit-scrollbar {
    width: 8px;
}

.drawer-body::-webkit-scrollbar-track {
    background: #222;
}

.drawer-body::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 4px;
}

.drawer-body::-webkit-scrollbar-thumb:hover {
    background: #666;
}

.property-section {
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 1px solid #333;
}

.property-section:last-child {
    border-bottom: none;
}

.property-section h3 {
    margin: 0 0 12px 0;
    font-size: 1rem;
    color: #4a90e2;
    font-weight: 600;
}

.form-group {
    margin-bottom: 12px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-size: 0.85rem;
    color: #aaa;
    font-weight: 500;
}

.form-group input[type="text"] {
    width: 100%;
    padding: 10px 12px;
    background: #1a1a1a;
    border: 1px solid #444;
    border-radius: 6px;
    color: #fff;
    font-size: 0.9rem;
    transition: border-color 0.2s;
}

.form-group input[type="text"]:focus {
    outline: none;
    border-color: #4a90e2;
}

/* Coordinate Display */
.coord-display {
    background: #1a1a1a;
    padding: 14px;
    border-radius: 8px;
    border: 1px solid #333;
}

.coord-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.coord-item:last-of-type {
    margin-bottom: 12px;
}

.coord-item label {
    font-size: 0.85rem;
    color: #888;
}

.coord-item span {
    font-family: 'Courier New', monospace;
    color: #4a90e2;
    font-weight: 600;
}

.btn-copy-coord {
    width: 100%;
    padding: 8px;
    background: #333;
    border: 1px solid #444;
    border-radius: 6px;
    color: #fff;
    cursor: pointer;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.2s;
}

.btn-copy-coord:hover {
    background: #4a90e2;
    border-color: #4a90e2;
}

/* Icon Preview */
.icon-preview-row {
    display: flex;
    align-items: center;
    gap: 12px;
}

.current-icon-display {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    background: #1a1a1a;
    border: 2px solid #333;
    display: flex;
    align-items: center;
    justify-content: center;
}

.preview-marker {
    position: relative;
    width: 36px;
    height: 48px;
    background: #4a90e2;
    border-radius: 50% 50% 50% 0;
    transform: rotate(-45deg);
    display: flex;
    align-items: center;
    justify-content: center;
}

.preview-marker i {
    transform: rotate(45deg);
    font-size: 1.2rem;
    color: white;
}

.btn-change-icon {
    flex: 1;
    padding: 10px 14px;
    background: #333;
    border: 1px solid #444;
    border-radius: 6px;
    color: #fff;
    cursor: pointer;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
}

.btn-change-icon:hover {
    background: #4a90e2;
    border-color: #4a90e2;
}

/* Custom Properties */
.custom-props-list {
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 12px;
}

.custom-prop-item {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    padding: 8px;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 6px;
}

.custom-prop-item span {
    min-width: 80px;
    font-size: 0.85rem;
    color: #4a90e2;
    font-weight: 600;
}

.custom-prop-item input {
    flex: 1;
    padding: 6px 8px;
    background: #222;
    border: 1px solid #444;
    border-radius: 4px;
    color: #fff;
    font-size: 0.85rem;
}

.custom-prop-item button {
    padding: 6px 12px;
    background: #e74c3c;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    font-size: 0.8rem;
    transition: background 0.2s;
}

.custom-prop-item button:hover {
    background: #c0392b;
}

.add-property-form {
    display: flex;
    gap: 6px;
}

.add-property-form input {
    flex: 1;
    padding: 8px 10px;
    background: #1a1a1a;
    border: 1px solid #444;
    border-radius: 6px;
    color: #fff;
    font-size: 0.85rem;
}

.add-property-form button {
    padding: 8px 14px;
    background: #4a90e2;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    font-size: 0.85rem;
    white-space: nowrap;
    transition: background 0.2s;
}

.add-property-form button:hover {
    background: #357abd;
}

/* Quick Actions */
.quick-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.action-btn {
    width: 100%;
    padding: 12px;
    background: #333;
    border: 1px solid #444;
    border-radius: 6px;
    color: #fff;
    cursor: pointer;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
}

.action-btn:hover {
    background: #4a90e2;
    border-color: #4a90e2;
}

.action-btn.danger {
    background: #2a2020;
    border-color: #5a3030;
}

.action-btn.danger:hover {
    background: #e74c3c;
    border-color: #e74c3c;
}

/* Drawer Footer */
.drawer-footer {
    padding: 16px 20px;
    background: #222;
    border-top: 1px solid #333;
    display: flex;
    gap: 10px;
    flex-shrink: 0;
}

.drawer-footer .btn-cancel,
.drawer-footer .btn-save {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.drawer-footer .btn-cancel {
    background: #3a3a3a;
    color: #aaa;
}

.drawer-footer .btn-cancel:hover {
    background: #444;
    color: #fff;
}

.drawer-footer .btn-save {
    background: #4a90e2;
    color: white;
}

.drawer-footer .btn-save:hover {
    background: #357abd;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
}

/* ==== Marker Highlight Animation ==== */
.marker-pin.highlighted {
    animation: markerPulse 1.5s ease-in-out infinite;
    filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
}

@keyframes markerPulse {

    0%,
    100% {
        transform: scale(1);
        filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
    }

    50% {
        transform: scale(1.15);
        filter: drop-shadow(0 0 20px rgba(255, 215, 0, 1));
    }
}

/* ===== Property Editor Modal ===== */
.property-editor-modal {
    background: rgba(30, 30, 30, 0.98);
    backdrop-filter: blur(10px);
    border: 1px solid #444;
    border-radius: 12px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.property-section {
    margin-bottom: 20px;
}

.property-section label,
.property-section h4 {
    display: block;
    margin-bottom: 8px;
    color: #e0e0e0;
    font-size: 0.9rem;
    font-weight: 600;
}

.property-section h4 {
    font-size: 1rem;
    color: #4a90e2;
    margin-top: 5px;
}

.property-section input {
    width: 100%;
    padding: 10px;
    background: #2c2c2c;
    border: 1px solid #444;
    border-radius: 6px;
    color: #e0e0e0;
    font-size: 0.9rem;
    box-sizing: border-box;
}

.property-section input:focus {
    border-color: #4a90e2;
    outline: none;
}

#customPropertyList {
    margin-bottom: 15px;
    max-height: 300px;
    overflow-y: auto;
}

.custom-prop-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.2s;
}

.custom-prop-item:hover {
    background: rgba(0, 0, 0, 0.4);
    border-color: rgba(74, 144, 226, 0.3);
}

.custom-prop-item span {
    font-weight: 600;
    color: #4a90e2;
    min-width: 100px;
    font-size: 0.85rem;
}

.custom-prop-item input {
    flex: 1;
    padding: 6px 10px;
    font-size: 0.85rem;
}

.custom-prop-item button {
    padding: 6px 12px;
    background: rgba(231, 76, 60, 0.8);
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.2s;
    white-space: nowrap;
}

.custom-prop-item button:hover {
    background: #e74c3c;
    transform: translateY(-1px);
}

.add-property-row {
    display: flex;
    gap: 8px;
}

.add-property-row input {
    flex: 1;
}

.add-property-row button {
    padding: 10px 20px;
    background: #4a90e2;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
    font-weight: 500;
}

.add-property-row button:hover {
    background: #357ab8;
    transform: translateY(-1px);
}

/* ==== Group Marker & Spiderfy Styles ==== */
.group-marker-icon {
    background: transparent !important;
    border: none !important;
}

.group-marker-icon .marker-pin.group-marker {
    width: 36px;
    height: 36px;
    border-radius: 50% 50% 50% 0;
    background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
    transform: rotate(-45deg);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 3px 10px rgba(74, 144, 226, 0.4);
    border: 2px solid white;
    cursor: pointer;
    transition: all 0.2s ease;
}

.group-marker-icon .marker-pin.group-marker:hover {
    transform: rotate(-45deg) scale(1.1);
    box-shadow: 0 5px 15px rgba(74, 144, 226, 0.6);
}

.group-marker-icon .marker-pin.group-marker i {
    transform: rotate(45deg);
    color: white;
    font-size: 16px;
}

/* 数量徽标 */
.group-marker-badge {
    position: absolute;
    top: -10px;
    right: -10px;
    min-width: 22px;
    min-height: 22px;
    width: auto;
    height: auto;
    padding: 2px 5px;
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
    color: white;
    font-size: 12px;
    font-weight: bold;
    border-radius: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    line-height: 1;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    border: 2px solid white;
    z-index: 10;
    box-sizing: border-box;
    animation: badgePop 0.3s ease-out;
}

@keyframes badgePop {
    0% {
        transform: scale(0);
    }

    70% {
        transform: scale(1.2);
    }

    100% {
        transform: scale(1);
    }
}

/* 放射连接线 */
.spider-leg {
    stroke-dasharray: 4, 4;
    animation: legDash 0.5s linear infinite;
}

@keyframes legDash {
    to {
        stroke-dashoffset: -8;
    }
}

/* 展开状态的子标记 */
.spiderfied-marker .marker-pin {
    animation: spiderfyIn 0.2s ease-out;
}

@keyframes spiderfyIn {
    0% {
        opacity: 0;
        transform: rotate(-45deg) scale(0.5);
    }

    100% {
        opacity: 1;
        transform: rotate(-45deg) scale(1);
    }
}

/* ==== Layer Statistics Styles ==== */
.layer-stats {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
}

.stats-header {
    display: flex;
    align-items: baseline;
    gap: 6px;
    margin-bottom: 10px;
}

.stats-total {
    font-size: 28px;
    font-weight: bold;
    color: #4a90e2;
}

.stats-label {
    font-size: 14px;
    color: #888;
}

.stats-group-badge {
    background: #ff6b6b;
    color: white;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: auto;
}

.stats-breakdown {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.stats-row {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
}

.stats-type {
    width: 60px;
    color: #aaa;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.stats-bar {
    flex: 1;
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
    overflow: hidden;
}

.stats-bar-fill {
    display: block;
    height: 100%;
    background: linear-gradient(90deg, #4a90e2, #67b7dc);
    border-radius: 3px;
    transition: width 0.3s ease;
}

.stats-count {
    color: #ccc;
    min-width: 24px;
    text-align: right;
}

.stats-empty {
    color: #666;
    font-size: 12px;
    text-align: center;
    padding: 10px 0;
}

/* ==== Selection Highlight Styles ==== */
.layer-item.selected {
    background: rgba(74, 144, 226, 0.2);
    border-left: 3px solid #4a90e2;
}

.layer-item.selected .layer-btn-main {
    color: #4a90e2;
}

/* Table row selected */
.tabulator-row.tabulator-selected {
    background: rgba(74, 144, 226, 0.3) !important;
}

.tabulator-row.tabulator-selected:hover {
    background: rgba(74, 144, 226, 0.4) !important;
}

/* Layer disabled state */
.layer-item.hidden {
    opacity: 0.5;
}

.layer-item.hidden .layer-btn-main {
    text-decoration: line-through;
}

/* ==== Custom Group Management Styles ==== */

/* Selection Mode Body Class */
body.selection-mode #map {
    cursor: crosshair;
}

body.selection-mode .marker-pin {
    cursor: pointer;
}

/* Multi-select Mode Indicator */
body.selection-mode::before {
    content: "📦 选择模式 - 点击标记加入组";
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(74, 144, 226, 0.95);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    font-size: 14px;
    font-weight: 500;
    z-index: 9999;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    animation: fadeInDown 0.3s ease;
}

@keyframes fadeInDown {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
    }

    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

/* Selection Highlight for Markers */
.marker-pin.selection-highlight {
    box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.8), 0 0 20px rgba(255, 107, 107, 0.6) !important;
    animation: selectionPulse 1s infinite;
}

@keyframes selectionPulse {

    0%,
    100% {
        box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.8), 0 0 20px rgba(255, 107, 107, 0.6);
    }

    50% {
        box-shadow: 0 0 0 6px rgba(255, 107, 107, 0.6), 0 0 30px rgba(255, 107, 107, 0.4);
    }
}

/* Custom Group Section */
.custom-group-section {
    margin-top: 10px;
}

.custom-group-section h3 {
    font-size: 0.95rem;
    color: #fff;
    margin: 0 0 10px 0;
    font-weight: 600;
}

.group-selection-controls {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 12px;
}

.group-selection-controls button {
    background: linear-gradient(135deg, #4a90e2, #357ab8);
    color: white;
    border: none;
    padding: 10px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
}

.group-selection-controls button:hover {
    background: linear-gradient(135deg, #357ab8, #2968a3);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
}

#finishSelectionBtn {
    background: linear-gradient(135deg, #27ae60, #1e8449) !important;
}

#finishSelectionBtn:hover {
    background: linear-gradient(135deg, #1e8449, #196f3d) !important;
}

#selectionCount {
    font-size: 0.85rem;
    color: #ff6b6b;
    font-weight: 600;
    text-align: center;
    padding: 6px;
    background: rgba(255, 107, 107, 0.15);
    border-radius: 4px;
}

/* Custom Group List */
.custom-group-list {
    max-height: 200px;
    overflow-y: auto;
}

.empty-groups {
    color: #666;
    font-size: 0.85rem;
    text-align: center;
    padding: 15px;
    font-style: italic;
}

.custom-group-item {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s;
    border-left: 4px solid #ff6b6b;
}

.custom-group-item:hover {
    background: rgba(255, 255, 255, 0.08);
}

.group-info {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    flex: 1;
}

.group-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
}

.group-name {
    font-weight: 500;
    color: #f0f0f0;
    font-size: 0.9rem;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.group-count {
    background: rgba(255, 107, 107, 0.3);
    color: #ff6b6b;
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
}

.group-actions {
    display: flex;
    gap: 4px;
}

.group-actions button {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 4px;
    color: #aaa;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    transition: all 0.2s;
}

.group-actions button:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
}

.group-actions button.delete:hover {
    background: rgba(231, 76, 60, 0.3);
    color: #e74c3c;
}

/* ==== Timeline Section Styles (地图历史) ==== */

.timeline-section {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 0;
}

.timeline-section:not(.collapsed) .timeline-header {
    margin-bottom: 10px;
}

.timeline-header:hover {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 6px;
    margin: -6px;
    padding: 6px;
}

.timeline-header h3 {
    margin: 0;
    font-size: 0.95rem;
    color: #fff;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.timeline-header h3 i {
    color: #4a90e2;
}

.timeline-header-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.timeline-header-actions button {
    background: linear-gradient(135deg, #4a90e2, #357abd);
    color: white;
    border: none;
    width: 28px;
    height: 28px;
    padding: 0;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.timeline-header-actions button:hover {
    background: linear-gradient(135deg, #357abd, #2968a3);
    transform: scale(1.05);
}

.collapse-icon {
    color: #888;
    transition: transform 0.3s ease;
}

.timeline-section.collapsed .collapse-icon {
    transform: rotate(-90deg);
}

.timeline-list {
    max-height: 150px;
    overflow-y: auto;
    transition: all 0.3s ease;
}

/* 折叠状态 */
.timeline-section.collapsed .timeline-list {
    max-height: 0;
    overflow: hidden;
    margin: 0;
    padding: 0;
}

/* 左侧面板收起时隐藏历史地图 */
#controls.collapsed .timeline-section,
#controls.collapsed .timeline-section+.divider {
    display: none;
}

.timeline-empty {
    color: #666;
    font-size: 0.8rem;
    text-align: center;
    padding: 10px;
    font-style: italic;
}

.timeline-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px;
    margin-bottom: 6px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 6px;
    transition: all 0.2s;
    border-left: 3px solid transparent;
}

.timeline-item:hover {
    background: rgba(255, 255, 255, 0.06);
}

.timeline-item.active {
    background: rgba(74, 144, 226, 0.15);
    border-left-color: #4a90e2;
}

.timeline-marker {
    font-size: 0.8rem;
    color: #666;
    flex-shrink: 0;
}

.timeline-item.active .timeline-marker {
    color: #4a90e2;
}

.timeline-content {
    flex: 1;
    cursor: pointer;
    min-width: 0;
}

.timeline-name {
    font-weight: 500;
    color: #f0f0f0;
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.timeline-date {
    font-size: 0.75rem;
    color: #888;
}

.timeline-actions {
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.2s;
}

.timeline-item:hover .timeline-actions {
    opacity: 1;
}

.timeline-actions button {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    color: #aaa;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    transition: all 0.2s;
}

.timeline-actions button:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
}

.timeline-actions button.delete:hover {
    background: rgba(231, 76, 60, 0.3);
    color: #e74c3c;
}

/* ==== Dashboard Panel Styles ==== */

/* Dashboard button (right bottom, offset from table button) */
.dashboard-btn {
    right: 90px !important;
    background: linear-gradient(135deg, #9b59b6, #8e44ad) !important;
}

.dashboard-btn:hover {
    background: linear-gradient(135deg, #8e44ad, #7d3c98) !important;
}

/* Dashboard panel (right top) */
.dashboard-panel {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 320px;
    max-height: calc(100vh - 450px);
    background: rgba(30, 30, 30, 0.98);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: flex;
    flex-direction: column;

    /* Default: hidden */
    opacity: 0;
    transform: translateY(-20px);
    pointer-events: none;
    transition: all 0.3s ease;
}

.dashboard-panel.open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 16px;
    background: rgba(155, 89, 182, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px 12px 0 0;
}

.dashboard-header h3 {
    margin: 0;
    font-size: 1rem;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
}

.dashboard-header h3 i {
    color: #9b59b6;
}

.btn-close-dashboard {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    color: #ccc;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-close-dashboard:hover {
    background: rgba(231, 76, 60, 0.3);
    color: #e74c3c;
}

.dashboard-content {
    padding: 16px;
    overflow-y: auto;
    flex: 1;
}

.dashboard-empty {
    color: #666;
    font-size: 0.85rem;
    text-align: center;
    padding: 20px;
    font-style: italic;
}

/* Overview section */
.dashboard-overview {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.overview-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
}

.overview-icon {
    font-size: 1.2rem;
}

.overview-label {
    flex: 1;
    color: #888;
    font-size: 0.85rem;
}

.overview-value {
    font-weight: 600;
    color: #fff;
    font-size: 0.9rem;
}

/* Layer breakdown */
.dashboard-layer {
    margin-bottom: 16px;
}

.dashboard-layer .layer-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
}

.dashboard-layer .layer-name {
    font-weight: 600;
    color: #f0f0f0;
    font-size: 0.9rem;
}

.dashboard-layer .layer-status {
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 10px;
}

.dashboard-layer .layer-status.visible {
    background: rgba(39, 174, 96, 0.2);
    color: #27ae60;
}

.dashboard-layer .layer-status.hidden {
    background: rgba(127, 140, 141, 0.2);
    color: #7f8c8d;
}

.dashboard-layer .layer-count {
    margin-left: auto;
    font-size: 0.85rem;
    color: #aaa;
}

.layer-breakdown {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

/* Type statistics with color preview */
.type-stat-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 6px;
    transition: all 0.2s;
    cursor: pointer;
}

.type-stat-item:hover {
    background: rgba(255, 255, 255, 0.06);
}

.stat-preview {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
}

.color-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

.symbol-icon {
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 0.7rem;
}

.stat-type {
    flex: 1;
    color: #ccc;
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.stat-count {
    font-weight: 600;
    color: #9b59b6;
    font-size: 0.9rem;
    min-width: 24px;
    text-align: right;
}

.type-empty {
    color: #666;
    font-size: 0.8rem;
    text-align: center;
    padding: 10px;
    font-style: italic;
}

/* ==== Unified Tools FAB Menu ==== */

.tools-fab-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 999;
}

.tools-fab {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4a90e2, #357abd);
    border: none;
    color: white;
    font-size: 1.4rem;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(74, 144, 226, 0.4);
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.tools-fab:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(74, 144, 226, 0.5);
}

.tools-fab.active {
    transform: rotate(45deg);
    background: linear-gradient(135deg, #e74c3c, #c0392b);
}

.tools-menu {
    position: absolute;
    bottom: 70px;
    right: 0;
    /* 毛玻璃效果 - 半透明背景 */
    background: rgba(20, 20, 20, 0.55);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-radius: 12px;
    padding: 8px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.12);

    /* 横向排列 */
    display: flex;
    flex-direction: row;
    gap: 4px;

    /* Default: hidden */
    opacity: 0;
    transform: translateY(10px) scale(0.9);
    pointer-events: none;
    transition: all 0.2s ease;
}

.tools-menu.open {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
}

.tools-menu-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background: transparent;
    border: none;
    color: #e0e0e0;
    font-size: 0.9rem;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s;
    width: 100%;
    text-align: left;
}

.tools-menu-item:hover {
    background: rgba(74, 144, 226, 0.2);
    color: #fff;
}

.tools-menu-item i {
    width: 20px;
    text-align: center;
    color: #4a90e2;
}

/* Hide old floating buttons */
.floating-btn {
    display: none !important;
}

/* Dashboard button offset - deprecated */
.dashboard-btn {
    display: none !important;
}

/* ==== Layer Details Panel Styles ==== */

.layer-list-section h3,
.layer-details-panel h3,
.layer-actions-section h3 {
    margin: 0 0 10px 0;
    font-size: 0.9rem;
    color: #fff;
    font-weight: 600;
}

.layer-details-panel {
    max-height: 280px;
    overflow-y: auto;
}

.layer-details-content {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    padding: 12px;
}

.layer-details-content .no-selection {
    color: #666;
    font-size: 0.85rem;
    text-align: center;
    padding: 20px 10px;
    font-style: italic;
}

.layer-detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.layer-detail-row:last-child {
    border-bottom: none;
}

.detail-label {
    color: #888;
    font-size: 0.85rem;
}

.detail-value {
    color: #fff;
    font-size: 0.85rem;
    font-weight: 500;
}

.style-distribution {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.distribution-title {
    color: #888;
    font-size: 0.8rem;
    margin-bottom: 8px;
}

.style-stat-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 0;
}

.style-color {
    width: 12px;
    height: 12px;
    border-radius: 3px;
    flex-shrink: 0;
}

.style-icon {
    width: 18px;
    text-align: center;
    color: #888;
    font-size: 0.75rem;
}

.style-type {
    flex: 1;
    color: #ccc;
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.style-count {
    color: #4a90e2;
    font-weight: 600;
    font-size: 0.85rem;
    min-width: 30px;
    text-align: right;
}

.style-more {
    color: #666;
    font-size: 0.75rem;
    text-align: center;
    padding: 6px 0;
    font-style: italic;
}

.layer-quick-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.layer-quick-actions button {
    flex: 1;
    background: linear-gradient(135deg, #4a90e2, #357abd);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.2s;
}

.layer-quick-actions button:hover {
    background: linear-gradient(135deg, #357abd, #2968a3);
    transform: translateY(-1px);
}

.layer-action-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.layer-action-buttons .btn-danger {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    font-size: 0.85rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
}

.layer-action-buttons .btn-danger:hover {
    background: linear-gradient(135deg, #c0392b, #a93226);
    transform: translateY(-1px);
}

/* ==== Layer Search Bar ==== */
.layer-search-bar {
    display: flex;
    gap: 6px;
    margin-bottom: 12px;
}

.layer-search-bar input {
    flex: 1;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 6px;
    padding: 8px 12px;
    color: #fff;
    font-size: 0.85rem;
}

.layer-search-bar input::placeholder {
    color: #888;
}

.layer-search-bar input:focus {
    outline: none;
    border-color: #4a90e2;
    background: rgba(255, 255, 255, 0.12);
}

.layer-search-bar button {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 6px;
    padding: 8px 12px;
    color: #888;
    cursor: pointer;
    transition: all 0.2s;
}

.layer-search-bar button:hover {
    background: rgba(255, 255, 255, 0.15);
    color: #fff;
}

/* ==== Search Results ==== */
.search-results-container {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 6px;
    margin-bottom: 12px;
    max-height: 150px;
    overflow-y: auto;
}

.search-result-item {
    padding: 8px 12px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    transition: background 0.2s;
}

.search-result-item:hover {
    background: rgba(74, 144, 226, 0.2);
}

.search-result-item:last-child {
    border-bottom: none;
}

.result-name {
    color: #fff;
    font-size: 0.85rem;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.result-type {
    color: #888;
    font-size: 0.75rem;
    margin-left: 8px;
}

.result-more,
.no-results {
    padding: 8px 12px;
    color: #666;
    font-size: 0.75rem;
    text-align: center;
    font-style: italic;
}

/* ==== Scrollable Style Distribution ==== */
.style-distribution-scroll {
    max-height: 200px;
    overflow-y: auto;
    padding-right: 4px;
}

.style-distribution-scroll::-webkit-scrollbar {
    width: 6px;
}

.style-distribution-scroll::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
}

.style-distribution-scroll::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
}

.style-distribution-scroll::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* ==== Browse Mode Styles ==== */

/* 浏览按钮 */
.timeline-header-actions .browse-btn {
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
}

.timeline-header-actions .browse-btn:hover {
    background: linear-gradient(135deg, #8e44ad, #7d3c98);
}

/* 浏览模式状态条 */
.browse-mode-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: linear-gradient(135deg, rgba(155, 89, 182, 0.2), rgba(142, 68, 173, 0.2));
    border: 1px solid rgba(155, 89, 182, 0.4);
    border-radius: 8px;
    margin: 10px 0;
}

.browse-mode-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.browse-mode-label {
    color: #9b59b6;
    font-size: 0.75rem;
    font-weight: 600;
}

.browse-mode-snapshot {
    color: #fff;
    font-size: 0.9rem;
    font-weight: 500;
}

.browse-mode-actions {
    display: flex;
    gap: 8px;
}

.browse-mode-actions button {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #fff;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.browse-mode-actions button:hover {
    background: rgba(255, 255, 255, 0.2);
}

.browse-mode-actions button.exit {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    border-color: #e74c3c;
}

.browse-mode-actions button.exit:hover {
    background: linear-gradient(135deg, #c0392b, #a93226);
}

/* 浏览模式提示 */
.browse-mode-hint {
    background: rgba(155, 89, 182, 0.15);
    border: 1px dashed rgba(155, 89, 182, 0.4);
    border-radius: 6px;
    padding: 8px 12px;
    margin-bottom: 8px;
    color: #bb8fce;
    font-size: 0.8rem;
    text-align: center;
}

/* 浏览模式下的快照项 */
.timeline-item.browse-mode {
    border-left: 3px solid #9b59b6;
}

.timeline-item.browse-mode:hover {
    background: rgba(155, 89, 182, 0.15);
}

.timeline-item.browse-mode.active {
    background: rgba(155, 89, 182, 0.25);
    border-left-color: #e74c3c;
}

/* 时间线计数 */
.timeline-meta {
    display: flex;
    gap: 10px;
    align-items: center;
}

.timeline-count {
    color: #888;
    font-size: 0.7rem;
    background: rgba(255, 255, 255, 0.05);
    padding: 2px 6px;
    border-radius: 4px;
}

/* ==== 浏览模式专用样式 ==== */

/* 浏览模式地图遮罩提示 */
.browse-mode-map-overlay {
    position: fixed;
    top: 70px;
    right: 16px;
    z-index: 999;
    display: none;
    align-items: center;
    justify-content: center;
    pointer-events: none;
}

.browse-overlay-content {
    background: rgba(155, 89, 182, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(155, 89, 182, 0.3);
}

.browse-overlay-content i {
    font-size: 1rem;
}

/* 浏览模式下禁用右键菜单编辑操作 */
body.browse-mode-active #contextMenu .context-menu-item[onclick*="edit"],
body.browse-mode-active #contextMenu .context-menu-item[onclick*="delete"],
body.browse-mode-active #contextMenu .context-menu-item[onclick*="change"] {
    opacity: 0.4;
    pointer-events: none;
}

/* 浏览模式下禁用属性抽屉编辑 */
body.browse-mode-active #propertyDrawer input,
body.browse-mode-active #propertyDrawer textarea,
body.browse-mode-active #propertyDrawer select,
body.browse-mode-active #propertyDrawer button:not(.btn-close) {
    opacity: 0.5;
    pointer-events: none;
}

/* 浏览模式状态条 - 左上角悬浮小条 */
.browse-mode-bar {
    position: fixed;
    top: 16px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 16px;
    background: rgba(155, 89, 182, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 24px;
    box-shadow: 0 4px 16px rgba(155, 89, 182, 0.4);
    color: white;
    font-size: 0.85rem;
}

.browse-mode-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.browse-mode-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: white;
}

.browse-mode-snapshot {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.8);
    background: rgba(255, 255, 255, 0.15);
    padding: 2px 10px;
    border-radius: 12px;
}

/* 浏览模式按钮样式 */
.browse-mode-bar button {
    padding: 6px 10px;
    border: none;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

.browse-mode-bar button.exit {
    background: rgba(231, 76, 60, 0.9);
    padding: 6px 8px;
}

.browse-mode-bar button.apply {
    background: rgba(46, 204, 113, 0.9);
}

.browse-mode-bar button:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

/* 浏览模式提示 */
.browse-mode-hint {
    background: rgba(155, 89, 182, 0.1);
    border: 1px dashed rgba(155, 89, 182, 0.3);
    border-radius: 6px;
    padding: 8px 12px;
    margin-bottom: 10px;
    font-size: 0.8rem;
    color: #9b59b6;
    text-align: center;
}

/* ==== Leaflet.draw 工具栏修复 ==== */

/* 工具栏容器定位 - 避免与左侧面板重叠 */
.leaflet-top.leaflet-left {
    left: 310px !important;
    top: 16px !important;
    transition: left 0.3s ease;
}

/* 左侧面板折叠时调整位置 */
body.ui-collapsed .leaflet-top.leaflet-left {
    left: 80px !important;
}

/* 工具栏整体样式 */
.leaflet-draw.leaflet-control {
    background: var(--bg-glass) !important;
    backdrop-filter: blur(14px) !important;
    -webkit-backdrop-filter: blur(14px) !important;
    border-radius: var(--radius-md) !important;
    border: 1px solid var(--border-glass) !important;
    box-shadow: var(--shadow-float) !important;
    overflow: hidden;
    margin: 0 !important;
}

/* 工具栏按钮 - 修复图标显示 */
.leaflet-draw-toolbar a,
.leaflet-draw-actions a {
    width: 36px !important;
    height: 36px !important;
    line-height: 36px !important;

    /* 背景色 - 不使用 background shorthand 以保留 sprite */
    background-color: transparent !important;
    background-repeat: no-repeat !important;
    /* 让 Leaflet.draw 自行设置 background-position */

    /* 图标居中 */
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;

    border: none !important;
    border-radius: 0 !important;
    transition: background-color 0.2s !important;
}

.leaflet-draw-toolbar a:hover,
.leaflet-draw-actions a:hover {
    background-color: rgba(255, 255, 255, 0.1) !important;
}

/* 隐藏按钮内的子元素（防止双图标） */
.leaflet-draw-toolbar a>*,
.leaflet-draw-actions a>*,
.leaflet-draw-toolbar a::before,
.leaflet-draw-actions a::before,
.leaflet-draw-toolbar a::after,
.leaflet-draw-actions a::after {
    display: none !important;
    content: none !important;
}

/* 分隔线 */
.leaflet-draw-toolbar-top {
    border-bottom: 1px solid var(--border-glass) !important;
}

/* 动作按钮样式 */
.leaflet-draw-actions {
    background: var(--bg-glass) !important;
    border: 1px solid var(--border-glass) !important;
    border-radius: var(--radius-sm) !important;
}

.leaflet-draw-actions a {
    color: var(--text-primary) !important;
    font-size: 0.75rem !important;
    padding: 0 10px !important;
    width: auto !important;
}

/* ==== Zoom 控件样式 ==== */
.leaflet-control-zoom {
    background: var(--bg-glass) !important;
    backdrop-filter: blur(14px) !important;
    -webkit-backdrop-filter: blur(14px) !important;
    border-radius: var(--radius-md) !important;
    border: 1px solid var(--border-glass) !important;
    box-shadow: var(--shadow-float) !important;
    overflow: hidden;
}

.leaflet-control-zoom a {
    width: 36px !important;
    height: 36px !important;
    line-height: 36px !important;
    background: transparent !important;
    color: var(--text-primary) !important;
    border: none !important;
    font-size: 18px !important;
}

.leaflet-control-zoom a:hover {
    background: rgba(255, 255, 255, 0.1) !important;
    color: white !important;
}

.leaflet-control-zoom-in {
    border-bottom: 1px solid var(--border-glass) !important;
}

/* ==== 表格定位按钮样式 ==== */
.table-locate-btn {
    background: transparent;
    border: 1px solid var(--border-glass);
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px 8px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.table-locate-btn:hover {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

.table-locate-btn i {
    font-size: 14px;
}

/* 表格滚动条增强 */
#featureTable .tabulator-tableholder {
    overflow: auto !important;
}

#featureTable .tabulator-tableholder::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

#featureTable .tabulator-tableholder::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
}

#featureTable .tabulator-tableholder::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
}

#featureTable .tabulator-tableholder::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* ==== 右下角工具菜单毛玻璃 ==== */
.tools-fab-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}

.tools-fab {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--bg-glass) !important;
    backdrop-filter: blur(14px) !important;
    -webkit-backdrop-filter: blur(14px) !important;
    border: 1px solid var(--border-glass) !important;
    box-shadow: var(--shadow-float) !important;
    color: var(--text-primary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    transition: all 0.3s;
}

.tools-fab:hover {
    background: var(--primary-color) !important;
    color: white;
    transform: scale(1.05);
}

.tools-menu {
    position: absolute;
    bottom: 60px;
    right: 0;
    background: var(--bg-glass) !important;
    backdrop-filter: blur(14px) !important;
    -webkit-backdrop-filter: blur(14px) !important;
    border: 1px solid var(--border-glass) !important;
    border-radius: var(--radius-md) !important;
    box-shadow: var(--shadow-float) !important;
    padding: 8px;
    display: none;
    flex-direction: column;
    gap: 4px;
    min-width: 120px;
}

.tools-menu.open {
    display: flex;
}

.tools-menu-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
    text-align: left;
    white-space: nowrap;
}

.tools-menu-item:hover {
    background: rgba(255, 255, 255, 0.1);
}

.tools-menu-item i {
    width: 18px;
    text-align: center;
    color: var(--primary-color);
}

/* ==== 图层面板搜索框样式 ==== */
.layer-search-box {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: var(--radius-sm);
    margin: 0 var(--gap-md) var(--gap-sm);
}

.layer-search-box i {
    color: var(--text-secondary);
    font-size: 14px;
}

.layer-search-box input {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text-primary);
    font-size: 0.85rem;
    outline: none;
}

.layer-search-box input::placeholder {
    color: var(--text-secondary);
}

.btn-clear-search {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-clear-search:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
}

/* 图层列表滚动区域 */
.layer-list-scroll {
    max-height: 300px;
    overflow-y: auto;
    padding-right: 4px;
}

.layer-list-scroll::-webkit-scrollbar {
    width: 6px;
}

.layer-list-scroll::-webkit-scrollbar-track {
    background: transparent;
}

.layer-list-scroll::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 3px;
}

.layer-list-scroll::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.25);
}

/* ==== backdrop-filter 降级方案 ==== */
@supports not (backdrop-filter: blur(10px)) {

    .floating-panel,
    #controls,
    .leaflet-draw.leaflet-control,
    .leaflet-control-zoom,
    .tools-fab,
    .tools-menu,
    #layerPanel {
        background: rgba(30, 30, 40, 0.95) !important;
    }
}

/* ==== 图层面板显示/隐藏 ==== */
.layer-panel {
    position: fixed;
    top: 16px;
    right: 16px;
    width: 320px;
    max-height: calc(100vh - 32px);
    z-index: 1000;
    display: none;
    flex-direction: column;
    overflow: hidden;
    transition: transform 0.3s ease, opacity 0.2s ease;
    transform: translateX(100%);
    opacity: 0;
}

.layer-panel.open {
    display: flex;
    transform: translateX(0);
    opacity: 1;
}

/* === table-view-styles.css === */
/* ==== Table View Panel ==== */
.table-view-panel {
    /* 固定定位在底部 */
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;

    /* 默认收起状态 */
    height: 0;
    overflow: hidden;

    /* 毛玻璃效果 */
    background: rgba(20, 20, 20, 0.85);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 1001;
    display: flex;
    flex-direction: column;
    box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.4);

    /* 平滑过渡动画 */
    transition: height 0.3s ease;
}

/* 表格展开状态 */
.table-view-panel.open {
    height: 400px;
}

/* 拖拽手柄 */
.table-drag-handle {
    height: 8px;
    background: linear-gradient(to bottom, rgba(255, 255, 255, 0.1), transparent);
    cursor: ns-resize;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.table-drag-handle::before {
    content: '';
    width: 40px;
    height: 4px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
}

.table-drag-handle:hover::before {
    background: var(--primary-color);
}

.table-view-panel .table-header {
    padding: 10px 20px;
    background: rgba(30, 30, 30, 0.5);
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.table-view-panel .table-header h3 {
    margin: 0;
    color: #4a90e2;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.table-view-panel .table-controls {
    display: flex;
    gap: 8px;
}

.btn-table-control {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 4px;
    background: #333;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-table-control:hover {
    background: #4a90e2;
}

#featureTable {
    flex: 1;
    overflow: hidden;
}

/* Tabulator 自定义暗色主题 */
.tabulator {
    background: #1a1a1a;
    border: none;
    font-family: inherit;
}

.tabulator .tabulator-header {
    background: #252525;
    border-bottom: 2px solid #333;
}

.tabulator .tabulator-header .tabulator-col {
    background: #252525;
    border-right: 1px solid #333;
}

.tabulator .tabulator-header .tabulator-col .tabulator-col-content {
    color: #4a90e2;
    font-weight: 600;
    padding: 8px;
}

.tabulator .tabulator-tableholder .tabulator-table {
    background: #1a1a1a;
    color: #e0e0e0;
}

.tabulator .tabulator-row {
    background: #1a1a1a;
    border-bottom: 1px solid #2a2a2a;
}

.tabulator .tabulator-row.tabulator-row-even {
    background: #1e1e1e;
}

.tabulator .tabulator-row:hover {
    background: rgba(74, 144, 226, 0.1);
    cursor: pointer;
}

.tabulator .tabulator-row.tabulator-selected {
    background: rgba(74, 144, 226, 0.25);
}

.tabulator .tabulator-row .tabulator-cell {
    border-right: 1px solid #2a2a2a;
    padding: 8px;
}

.tabulator .tabulator-row .tabulator-cell.tabulator-editing input {
    background: #2a2a2a;
    color: #fff;
    border: 1px solid #4a90e2;
    padding: 4px 8px;
}

.tabulator .tabulator-footer {
    background: #252525;
    border-top: 1px solid #333;
}

/* 表格浮动按钮 */
.floating-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #4a90e2;
    border: none;
    color: white;
    font-size: 1.4rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
    transition: all 0.3s;
    z-index: 999;
}

.floating-btn:hover {
    transform: scale(1.1);
    background: #357abd;
    box-shadow: 0 6px 16px rgba(74, 144, 226, 0.6);
}

.floating-btn:active {
    transform: scale(0.95);
}

/* 当表格展开时，浮动按钮上移 */
body:has(.table-view-panel.open) .floating-btn {
    bottom: 420px;
}

/* ==== Table Locate Button ==== */
.table-locate-btn {
    background: linear-gradient(135deg, #4a90e2, #357abd);
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.75rem;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.table-locate-btn:hover {
    background: linear-gradient(135deg, #357abd, #2968a3);
    transform: scale(1.1);
}

.table-locate-btn i {
    font-size: 0.8rem;
}

/* ==== Table Scrollbars ==== */
.table-view-panel #featureTable {
    overflow: auto !important;
}

.tabulator {
    overflow: auto !important;
}

.tabulator-tableHolder {
    overflow: auto !important;
}

/* Custom scrollbar styling */
.tabulator-tableHolder::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

.tabulator-tableHolder::-webkit-scrollbar-track {
    background: #2a2a2a;
}

.tabulator-tableHolder::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 5px;
}

.tabulator-tableHolder::-webkit-scrollbar-thumb:hover {
    background: #777;
}
</style>
</head>

<body>
    <!-- 左侧悬浮控制面板 -->
    <div id="controls" class="panel">
        <div class="panel-header">
            <h2>地图控制</h2>
            <button id="toggleToolbarBtn" class="btn-toggle-toolbar" title="收起/展开">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
        </div>

        <!-- Dock 模式图标列表 -->
        <div class="dock-icons">
            <div class="dock-icon" data-tooltip="搜索定位" onclick="expandAccordion('search')">
                <i class="fa-solid fa-magnifying-glass"></i>
            </div>
            <div class="dock-icon" data-tooltip="数据导入导出" onclick="expandAccordion('data')">
                <i class="fa-solid fa-file-import"></i>
            </div>
            <div class="dock-icon" data-tooltip="图层面板" onclick="toggleLayerPanel()">
                <i class="fa-solid fa-layer-group"></i>
            </div>
            <div class="dock-icon" data-tooltip="历史地图" onclick="expandAccordion('history')">
                <i class="fa-solid fa-clock-rotate-left"></i>
            </div>
            <div class="dock-icon" data-tooltip="高级工具" onclick="expandAccordion('tools')">
                <i class="fa-solid fa-wrench"></i>
            </div>
        </div>

        <!-- 面板内容 -->
        <div class="panel-content">

            <!-- 搜索与定位（默认展开） -->
            <div class="accordion-section" id="accordion-search">
                <div class="accordion-header" onclick="toggleAccordion('search')">
                    <h3><i class="fa-solid fa-magnifying-glass"></i> 搜索与定位</h3>
                    <span class="collapse-icon"><i class="fa-solid fa-chevron-down"></i></span>
                </div>
                <div class="accordion-content">
                    <div class="control-group">
                        <label for="searchAddress">搜索地址</label>
                        <div class="input-with-btn">
                            <input type="text" id="searchAddress" placeholder="输入地址关键词..." />
                            <button id="searchBtn" class="btn-primary"><i class="fa-solid fa-search"></i></button>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>坐标定位</label>
                        <div class="coord-inputs">
                            <input type="number" id="gotoLat" placeholder="纬度" step="0.000001" class="mono" />
                            <input type="number" id="gotoLng" placeholder="经度" step="0.000001" class="mono" />
                        </div>
                        <button id="gotoCoordBtn" class="btn-primary">
                            <i class="fa-solid fa-location-crosshairs"></i> 跳转定位
                        </button>
                    </div>
                    <div class="control-group">
                        <label for="baseMapSelect">底图切换</label>
                        <select id="baseMapSelect">
                            <option value="osm">OpenStreetMap 标准</option>
                            <option value="satellite">卫星影像</option>
                            <option value="dark">暗色主题</option>
                            <option value="light">浅色主题</option>
                            <option value="terrain">地形图</option>
                            <option value="carto">CartoDB 简约</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 数据导入导出（默认折叠） -->
            <div class="accordion-section collapsed" id="accordion-data">
                <div class="accordion-header" onclick="toggleAccordion('data')">
                    <h3><i class="fa-solid fa-file-import"></i> 数据导入导出</h3>
                    <span class="collapse-icon"><i class="fa-solid fa-chevron-down"></i></span>
                </div>
                <div class="accordion-content">
                    <div class="control-group btn-row">
                        <button id="exportGeoJSONBtn" class="btn-primary">
                            <i class="fa-solid fa-download"></i> 导出 GeoJSON
                        </button>
                        <button id="shareBtn" class="btn-secondary">
                            <i class="fa-solid fa-share-nodes"></i> 分享
                        </button>
                    </div>
                    <div class="control-group">
                        <label for="geojsonFile">导入 GeoJSON</label>
                        <input type="file" id="geojsonFile" accept=".json,.geojson" />
                    </div>
                    <div class="control-group">
                        <label for="excelFile">导入 Excel</label>
                        <input type="file" id="excelFile" accept=".xlsx,.xls" />
                    </div>
                    <div class="control-group btn-row">
                        <button id="exportExcelBtn" class="btn-secondary">
                            <i class="fa-solid fa-file-excel"></i> 导出 Excel
                        </button>
                        <button id="downloadTemplateBtn" class="btn-text">
                            <i class="fa-solid fa-download"></i> 模板
                        </button>
                    </div>
                    <div class="control-group">
                        <label for="coordFile">导入 CSV</label>
                        <input type="file" id="coordFile" accept=".csv,.txt" />
                    </div>
                    <button id="exportBtn" class="btn-secondary">
                        <i class="fa-solid fa-file-csv"></i> 导出 CSV
                    </button>
                </div>
            </div>

            <!-- 历史地图（默认折叠） -->
            <div class="accordion-section collapsed" id="accordion-history">
                <div class="accordion-header" onclick="toggleAccordion('history')">
                    <h3><i class="fa-solid fa-clock-rotate-left"></i> 历史地图</h3>
                    <div class="accordion-header-actions">
                        <button onclick="event.stopPropagation(); timelineManager && timelineManager.enterBrowseMode()"
                            title="浏览模式" class="btn-icon">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                        <button
                            onclick="event.stopPropagation(); timelineManager && timelineManager.saveSnapshotPrompt()"
                            title="保存快照" class="btn-icon">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                        <span class="collapse-icon"><i class="fa-solid fa-chevron-down"></i></span>
                    </div>
                </div>
                <div class="accordion-content">
                    <div id="timelineList" class="timeline-list">
                        <div class="timeline-empty">暂无历史记录</div>
                    </div>
                </div>
            </div>

            <!-- 高级工具（默认折叠） -->
            <div class="accordion-section collapsed" id="accordion-tools">
                <div class="accordion-header" onclick="toggleAccordion('tools')">
                    <h3><i class="fa-solid fa-wrench"></i> 高级工具</h3>
                    <span class="collapse-icon"><i class="fa-solid fa-chevron-down"></i></span>
                </div>
                <div class="accordion-content">
                    <div class="control-group">
                        <button id="togglePickerBtn" class="btn-secondary">
                            <i class="fa-solid fa-crosshairs"></i> 启用坐标拾取
                        </button>
                        <div id="pickedCoords" class="picked-coords mono"></div>
                    </div>
                    <div class="control-group">
                        <label>手动添加标注</label>
                        <input type="text" id="manualNote" placeholder="输入备注信息" />
                        <button id="addManualMarkerBtn" class="btn-primary">
                            <i class="fa-solid fa-map-pin"></i> 点击地图添加
                        </button>
                    </div>
                    <div class="control-group">
                        <button id="toggleEditorBtn" class="btn-secondary">
                            <i class="fa-solid fa-code"></i> 显示代码编辑器
                        </button>
                    </div>
                    <div class="control-group">
                        <button id="toggleLayerPanelBtn" class="btn-secondary" onclick="toggleLayerPanel()">
                            <i class="fa-solid fa-layer-group"></i> 显示图层面板
                        </button>
                    </div>
                    <div class="control-group">
                        <label for="markerIconSelect">标记图标样式</label>
                        <select id="markerIconSelect">
                            <option value="blue">蓝色标记</option>
                            <option value="red">红色标记</option>
                            <option value="green">绿色标记</option>
                            <option value="orange">橙色标记</option>
                            <option value="violet">紫色标记</option>
                            <option value="grey">灰色标记</option>
                        </select>
                    </div>
                    <div class="control-group checkbox-row">
                        <label>
                            <input type="checkbox" id="showLabelsCheck" />
                            显示标注名称
                        </label>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- 右侧图层面板 -->
    <div id="layerPanel" class="floating-panel layer-panel">
        <!-- 固定头部 -->
        <div class="layer-panel-header">
            <div class="layer-panel-title">
                <h2><i class="fa-solid fa-layer-group"></i> 图层管理</h2>
                <button id="closeLayerPanelBtn" class="btn-icon" onclick="toggleLayerPanel()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <!-- 搜索栏 -->
            <div class="layer-search-box">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="layerSearchInput" placeholder="搜索图层..." oninput="filterLayers(this.value)" />
                <button class="btn-clear-search" onclick="clearLayerSearch()" style="display:none;">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>

        <!-- 可滚动内容区域 -->
        <div class="layer-panel-content">

            <!-- 图层列表（可折叠） -->
            <div class="layer-section" id="layerListSection">
                <div class="layer-section-header" onclick="toggleLayerSection('layerListSection')">
                    <h3><i class="fa-solid fa-list"></i> 图层列表</h3>
                    <span class="layer-section-count" id="layerCount">0</span>
                    <i class="fa-solid fa-chevron-down section-toggle"></i>
                </div>
                <div class="layer-section-content">
                    <div id="layerList" class="layer-list-scroll"></div>
                </div>
            </div>

            <!-- 图层详情（可折叠） -->
            <div class="layer-section collapsed" id="layerDetailsSection">
                <div class="layer-section-header" onclick="toggleLayerSection('layerDetailsSection')">
                    <h3><i class="fa-solid fa-info-circle"></i> 图层详情</h3>
                    <i class="fa-solid fa-chevron-down section-toggle"></i>
                </div>
                <div class="layer-section-content">
                    <div id="layerDetailsPanel" class="layer-details-panel">
                        <div id="layerDetailsContent" class="layer-details-content">
                            <div class="no-selection">点击图层查看详情</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 统计汇总（可折叠） -->
            <div class="layer-section collapsed" id="layerStatsSection">
                <div class="layer-section-header" onclick="toggleLayerSection('layerStatsSection')">
                    <h3><i class="fa-solid fa-chart-pie"></i> 统计汇总</h3>
                    <i class="fa-solid fa-chevron-down section-toggle"></i>
                </div>
                <div class="layer-section-content">
                    <div id="layerStats" class="layer-stats">
                        <div class="stats-empty">加载中...</div>
                    </div>
                </div>
            </div>

            <hr class="divider">

            <!-- 存档管理 -->
            <div class="archive-section">
                <h3>💾 存档管理</h3>
                <div class="archive-create">
                    <input type="text" id="newArchiveName" placeholder="输入存档名称..." />
                    <button onclick="createArchive()">新建</button>
                </div>
                <div id="archiveList" class="archive-list"></div>
                <div id="currentArchiveInfo" class="current-archive" style="display:none;">
                    <span>当前: <strong id="currentArchiveName"></strong></span>
                    <button onclick="saveCurrentArchive()">保存</button>
                </div>
            </div>

            <hr class="divider">

            <!-- 自定义组管理 -->
            <div class="custom-group-section">
                <h3>📦 自定义组</h3>
                <div class="group-selection-controls">
                    <button id="enterSelectionModeBtn"
                        onclick="customGroupManager && customGroupManager.enterSelectionMode()">
                        <i class="fa-solid fa-object-group"></i> 选择标记创建组
                    </button>
                    <button id="finishSelectionBtn" style="display:none;"
                        onclick="customGroupManager && customGroupManager.finishSelectionAndCreateGroup()">
                        <i class="fa-solid fa-check"></i> 完成选择
                    </button>
                    <span id="selectionCount" style="display:none;"></span>
                </div>
                <div id="customGroupList" class="custom-group-list">
                    <div class="empty-groups">暂无自定义组</div>
                </div>
            </div>
        </div>
    </div>
    <!-- 关闭 layer-panel-content 和 layerPanel -->
    </div>

    <!--地图容器 -->
    <div id="map"></div>

    <!-- 战略事件追踪器面板 -->
    <div id="eventTrackerPanel" class="panel" style="display:none;">
        <div class="panel-header">
            <h2>战略事件追踪器</h2>
            <button id="closeEventTrackerBtn" onclick="closeEventTracker()">关闭</button>
        </div>

        <p id="eventTrackerFeatureName" style="font-weight:600; margin-bottom:10px; color:#4a90e2;"></p>

        <!-- 事件列表视图 -->
        <div id="eventListView">
            <div id="eventListContainer"></div>
            <button class="btn-add-event" onclick="createNewEvent()">+ 新增事件</button>
        </div>

        <!-- 事件编辑视图 -->
        <div id="eventEditView" style="display:none;">
            <div class="edit-view-header">
                <button class="btn-back" onclick="showEventList()">◀ 返回列表</button>
                <input type="text" id="currentEventName" placeholder="事件名称" />
            </div>

            <div id="eventTrackerContent" class="scrollable-content">
                <!-- Todo List Section -->
                <div class="tracker-section">
                    <h3>任务清单</h3>
                    <div class="todo-input-group">
                        <input type="text" id="newTodoInput" placeholder="添加新任务..." />
                        <button id="addTodoBtn" onclick="addTodoItemClick()">+</button>
                    </div>
                    <div id="todoList"></div>
                </div>

                <!-- Notes Section -->
                <div class="tracker-section">
                    <h3>备注说明</h3>
                    <textarea id="eventNotes" placeholder="输入文本描述..." rows="4"></textarea>
                </div>

                <!-- URL Links Section -->
                <div class="tracker-section">
                    <h3>相关链接</h3>
                    <div class="url-input-group">
                        <input type="text" id="urlTitle" placeholder="链接标题" />
                        <input type="url" id="urlAddress" placeholder="URL地址" />
                        <button id="addUrlBtn" onclick="addUrlItemClick()">+</button>
                    </div>
                    <div id="urlList"></div>
                </div>

                <!-- Timeline Section -->
                <div class="tracker-section">
                    <h3>时间轴</h3>
                    <div class="timeline-input-group">
                        <input type="datetime-local" id="timelineDate" step="60" />
                        <input type="text" id="timelineTitle" placeholder="事件标题" />
                        <button id="addTimelineBtn" onclick="addTimelineEventClick()">+</button>
                    </div>
                    <div id="timelineDisplay"></div>
                </div>

                <!-- Attachments Section -->
                <div class="tracker-section">
                    <h3>📎 附件</h3>
                    <div class="attachment-upload">
                        <input type="file" id="attachmentInput" onchange="uploadAttachment()" />
                        <label for="attachmentInput" class="upload-btn">选择文件</label>
                        <span class="upload-hint">支持图片、PDF等 (最大500KB)</span>
                    </div>
                    <div id="attachmentList" class="attachment-list"></div>
                </div>
            </div>


            <!-- Save Button -->
            <button id="saveEventDataBtn" onclick="saveCurrentEvent()">保存事件</button>
        </div>
    </div>

    <!-- 右键菜单 -->
    <div id="contextMenu" class="context-menu" style="display:none;">
        <div class="context-menu-item" onclick="openEventTrackerFromMenu(event)">📋 事件追踪器</div>
        <div class="context-menu-item" onclick="openPropertyEditor()">📝 属性编辑器</div>
        <div class="context-menu-item" onclick="openIconPicker()">🎨 更改图标</div>
        <div class="context-menu-item" onclick="deleteSelectedMarker()">删除标记</div>
    </div>

    <!-- 图标选择器弹窗 -->
    <div id="iconPickerModal" class="modal-overlay" style="display:none;">
        <div class="icon-picker-modal">
            <div class="modal-header">
                <h3>选择标记图标</h3>
                <button class="btn-close-modal" onclick="closeIconPicker()">×</button>
            </div>

            <!-- 预览区 -->
            <div class="icon-preview-section">
                <div id="iconPreview" class="icon-preview">
                    <div class="custom-marker-wrapper">
                        <div class="custom-marker-circle" id="previewCircle" style="background-color:#4a90e2;">
                            <i class="fa-solid fa-location-dot" id="previewIcon"></i>
                        </div>
                        <div class="custom-marker-tip" id="previewTip" style="border-top-color:#4a90e2;"></div>
                    </div>
                </div>
                <span id="selectedIconLabel">定位点</span>
            </div>

            <!-- 颜色选择 -->
            <div class="picker-section">
                <label>选择颜色</label>
                <div id="colorPalette" class="color-palette"></div>
            </div>

            <!-- 图标选择 -->
            <div class="picker-section">
                <label>选择图标</label>
                <div id="iconGrid" class="icon-grid"></div>
            </div>

            <!-- 操作按钮 -->
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeIconPicker()">取消</button>
                <button class="btn-apply" onclick="applyIconSelection()">应用</button>
            </div>
        </div>
    </div>

    <!-- 分享弹窗 -->
    <div id="shareModal" class="modal-overlay" style="display:none;">
        <div class="share-modal">
            <div class="modal-header">
                <h3><i class="fa-solid fa-share-nodes"></i> 分享地图</h3>
                <button class="btn-close-modal" onclick="closeShareModal()">×</button>
            </div>

            <!-- 预览区 -->
            <div class="share-preview-section">
                <div id="sharePreviewLoading" class="share-loading">
                    <i class="fa-solid fa-spinner fa-spin"></i> 正在生成截图...
                </div>
                <img id="sharePreviewImage" class="share-preview-image" style="display:none;" />
            </div>

            <!-- 分享选项 -->
            <div class="share-options">
                <button class="share-option-btn" onclick="downloadMapImage()">
                    <i class="fa-solid fa-download"></i>
                    <span>下载图片</span>
                </button>
                <button class="share-option-btn" onclick="copyMapImage()">
                    <i class="fa-solid fa-copy"></i>
                    <span>复制图片</span>
                </button>
                <button class="share-option-btn" onclick="copyShareLink()">
                    <i class="fa-solid fa-link"></i>
                    <span>复制链接</span>
                </button>
            </div>

            <!-- 状态提示 -->
            <div id="shareStatus" class="share-status" style="display:none;"></div>
        </div>
    </div>

    <!-- GeoJSON 导入确认弹窗 -->
    <div id="importModal" class="modal-overlay" style="display:none;">
        <div class="import-modal">
            <div class="modal-header">
                <h3>导入 GeoJSON</h3>
                <button class="btn-close-modal" onclick="closeImportModal()">×</button>
            </div>

            <!-- 统计信息 -->
            <div class="import-stats">
                <h4>几何类型统计</h4>
                <div id="importStats" class="stats-grid"></div>
            </div>

            <!-- 导入模式选择 -->
            <div class="import-mode-section">
                <label>导入模式</label>
                <div class="import-mode-options">
                    <label class="radio-option">
                        <input type="radio" name="importMode" value="replace" checked>
                        <span class="radio-label">替换现有图层</span>
                        <small>清除当前所有图层，导入新数据</small>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="importMode" value="merge">
                        <span class="radio-label">合并到现有图层</span>
                        <small>保留当前图层，追加新数据</small>
                    </label>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeImportModal()">取消</button>
                <button class="btn-apply" onclick="confirmImport()">确认导入</button>
            </div>
        </div>
    </div>

    <!-- GeoJSON 代码编辑器（默认隐藏） -->
    <div id="editorPanel" style="display:none;">
        <h2>GeoJSON 编辑器</h2>

        <!-- Code Archive Management -->
        <div class="archive-section" style="margin-bottom:10px;">
            <div class="archive-create">
                <input type="text" id="newCodeArchiveName" placeholder="输入代码存档名称..." />
                <button onclick="createCodeArchive()">新建</button>
            </div>
            <div id="codeArchiveList" class="archive-list" style="max-height:120px;"></div>
            <div id="currentCodeArchiveInfo" class="current-archive" style="display:none;">
                <span>当前: <strong id="currentCodeArchiveName"></strong></span>
                <button onclick="saveCurrentCodeArchive()">保存</button>
            </div>
        </div>


        <textarea id="geojsonEditor" spellcheck="false"></textarea>

        <div style="display:flex; gap:10px;">
            <button id="applyEditorBtn" style="flex:1;">应用到地图</button>
            <button
                onclick="document.getElementById('editorPanel').style.display='none'; document.getElementById('toggleEditorBtn').textContent='显示代码编辑器'"
                style="flex:1; background:#e74c3c;">关闭</button>
        </div>
    </div>


    <!-- 表格视图面板 -->
    <div id="tableViewPanel" class="table-view-panel">
        <div class="table-drag-handle" id="tableDragHandle"></div>
        <div class="table-header">
            <h3><i class="fa-solid fa-table"></i> 数据表格</h3>
            <div class="table-controls">
                <button id="refreshTableBtn" class="btn-table-control" title="刷新表格">
                    <i class="fa-solid fa-rotate"></i>
                </button>
                <button id="closeTableBtn" class="btn-table-control" title="关闭表格">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>
        <div id="featureTable"></div>
    </div>

    <!-- 统一工具入口（右下角） -->
    <div class="tools-fab-container">
        <button id="toolsFabBtn" class="tools-fab" title="工具面板" onclick="toggleToolsMenu()">
            <i class="fa-solid fa-toolbox"></i>
        </button>
        <div id="toolsMenu" class="tools-menu">
            <button class="tools-menu-item" onclick="toggleTableView(); closeToolsMenu()" title="数据表格">
                <i class="fa-solid fa-table"></i>
                <span>表格</span>
            </button>
            <button class="tools-menu-item" onclick="dashboardPanel && dashboardPanel.open(); closeToolsMenu()"
                title="数据看板">
                <i class="fa-solid fa-chart-pie"></i>
                <span>看板</span>
            </button>
        </div>
    </div>

    <!-- 看板面板（右上角） -->
    <div id="dashboardPanel" class="dashboard-panel">
        <div class="dashboard-header">
            <h3><i class="fa-solid fa-chart-pie"></i> 数据看板</h3>
            <button id="closeDashboardBtn" class="btn-close-dashboard" title="关闭">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div id="dashboardContent" class="dashboard-content">
            <div class="dashboard-empty">暂无数据</div>
        </div>
    </div>

    <!-- 属性编辑器侧边抽屉 -->
    <div id="propertyDrawer" class="property-drawer" style="display:none;">
        <div class="drawer-overlay" onclick="closePropertyDrawer()"></div>
        <div class="drawer-content">
            <div class="drawer-header">
                <h2>📝 标记属性</h2>
                <button class="btn-close-drawer" onclick="closePropertyDrawer()">×</button>
            </div>

            <div class="drawer-body">
                <!-- 基础信息 -->
                <div class="property-section">
                    <h3>基础信息</h3>
                    <div class="form-group">
                        <label>名称 *</label>
                        <input type="text" id="propName" placeholder="标记名称" />
                    </div>
                    <div class="form-group">
                        <label>类型</label>
                        <input type="text" id="propType" placeholder="标记类型" />
                    </div>
                    <div class="form-group">
                        <label>地址</label>
                        <input type="text" id="propAddress" placeholder="详细地址" />
                    </div>
                </div>

                <!-- 坐标信息 -->
                <div class="property-section">
                    <h3>坐标信息</h3>
                    <div class="coord-display">
                        <div class="coord-item">
                            <label>经度</label>
                            <span id="propLng">-</span>
                        </div>
                        <div class="coord-item">
                            <label>纬度</label>
                            <span id="propLat">-</span>
                        </div>
                        <button class="btn-copy-coord" onclick="copyCurrentCoordinates()">
                            <i class="fa-solid fa-copy"></i> 复制坐标
                        </button>
                    </div>
                </div>

                <!-- 图标预览 -->
                <div class="property-section">
                    <h3>外观设置</h3>
                    <div class="icon-preview-row">
                        <div id="currentIconPreview" class="current-icon-display">
                            <div class="preview-marker">
                                <i class="fa-solid fa-location-dot"></i>
                            </div>
                        </div>
                        <button class="btn-change-icon" onclick="changeIconFromDrawer()">
                            <i class="fa-solid fa-palette"></i> 更换图标/颜色
                        </button>
                    </div>
                </div>

                <!-- 自定义属性 -->
                <div class="property-section">
                    <h3>自定义属性</h3>
                    <div id="customPropertyList" class="custom-props-list"></div>
                    <div class="add-property-form">
                        <input type="text" id="newPropKey" placeholder="属性名" />
                        <input type="text" id="newPropValue" placeholder="属性值" />
                        <button onclick="addCustomProperty()">+ 添加</button>
                    </div>
                </div>

                <!-- 快捷操作 -->
                <div class="property-section">
                    <h3>快捷操作</h3>
                    <div class="quick-actions">
                        <button class="action-btn" onclick="openEventTrackerFromDrawer()">
                            <i class="fa-solid fa-calendar-check"></i> 事件追踪器
                        </button>
                        <button class="action-btn danger" onclick="deleteMarkerFromDrawer()">
                            <i class="fa-solid fa-trash"></i> 删除标记
                        </button>
                    </div>
                </div>
            </div>

            <div class="drawer-footer">
                <button class="btn-cancel" onclick="closePropertyDrawer()">取消</button>
                <button class="btn-save" onclick="savePropertyChanges()">保存</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <!-- Leaflet.draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" crossorigin=""></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"
        crossorigin="anonymous"></script>
    <!-- SheetJS for Excel support -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Tabulator JS -->
    <script src="https://unpkg.com/tabulator-tables@5.5/dist/js/tabulator.min.js"></script>
    <!-- Marker Group Manager -->
    
    <!-- Selection Manager -->
    
    <!-- Layer Statistics -->
    
    <!-- Custom Group Manager -->
    
    <!-- Timeline Manager -->
    
    <!-- Dashboard Panel -->
    
    
    
    
<script>

// ============================================
// API 挂接点说明 (API Hooks Reference)
// ============================================
// 
// 以下函数是与后端 API 集成的关键入口点，
// 当前使用 localStorage 实现，后续可替换为真实 API 调用。
//
// 数据加载/保存:
// - loadGeoJSONFromStorage()  -> 可替换为 API.loadGeoJSON()
// - saveCurrentState()        -> 可替换为 API.saveGeoJSON()
// - loadArchive(name)         -> 可替换为 API.loadArchive(id)
// - saveArchive(name)         -> 可替换为 API.saveArchive(id, data)
//
// 快照操作 (timeline-manager.js):
// - TimelineManager._saveToStorage()   -> API.saveSnapshots()
// - TimelineManager._loadFromStorage() -> API.loadSnapshots()
//
// 搜索地址:
// - searchAddress() 内部调用 Nominatim，可替换为自有地理编码服务
//
// ============================================


// ========== marker-group.js ==========
// ==== Marker Group Manager - 组合标记管理模块 ==== //

// 坐标判定阈值（约 0.1 米精度）
const COORD_EPSILON = 1e-6;

// 放射展开配置
const SPIDERFY_CONFIG = {
    legWeight: 2,
    legColor: 'rgba(74, 144, 226, 0.6)',
    circleRadius: 40,           // 圆形布局半径（像素）
    spiralStartRadius: 30,      // 螺旋起始半径
    spiralIncrement: 12,        // 螺旋增量
    circleSwitchover: 8,        // 超过此数量使用螺旋布局
    animationDuration: 200      // 展开动画时长（毫秒）
};

// 生成坐标哈希键
function getCoordKey(latlng, epsilon = COORD_EPSILON) {
    const lat = Math.round(latlng.lat / epsilon) * epsilon;
    const lng = Math.round(latlng.lng / epsilon) * epsilon;
    return `${lat.toFixed(8)},${lng.toFixed(8)}`;
}

// 获取标记的原始坐标（考虑偏移）
function getOriginalCoord(marker) {
    const props = marker.feature?.properties || {};
    const latlng = marker.getLatLng();
    return L.latLng(
        props._originalLat !== undefined ? props._originalLat : latlng.lat,
        props._originalLng !== undefined ? props._originalLng : latlng.lng
    );
}

// ==== MarkerGroup 类 ==== //
class MarkerGroup {
    constructor(coordKey, centerLatLng) {
        this.coordKey = coordKey;
        this.center = centerLatLng;
        this.markers = [];
        this.groupMarker = null;
        this.isExpanded = false;
        this.spiderLegs = [];
        this.spiderfiedPositions = new Map(); // marker -> originalLatLng
    }

    getCount() {
        return this.markers.length;
    }

    addMarker(marker) {
        if (!this.markers.includes(marker)) {
            this.markers.push(marker);
            // 存储原始位置
            this.spiderfiedPositions.set(marker, marker.getLatLng());
        }
    }

    removeMarker(marker) {
        const idx = this.markers.indexOf(marker);
        if (idx > -1) {
            this.markers.splice(idx, 1);
            this.spiderfiedPositions.delete(marker);
        }
    }

    // 创建组合标记图标
    createGroupIcon() {
        const count = this.getCount();
        const color = '#4a90e2';

        return L.divIcon({
            className: 'group-marker-icon',
            html: `
                <div class="marker-pin group-marker" style="background:${color};">
                    <i class="fa-solid fa-layer-group"></i>
                </div>
                <div class="group-marker-badge">${count}</div>
            `,
            iconSize: [36, 42],
            iconAnchor: [18, 42],
            popupAnchor: [0, -36]
        });
    }

    // 创建或更新组合标记
    updateGroupMarker(map, drawnItems) {
        const count = this.getCount();

        console.log(`Updating group marker: ${count} markers, expanded: ${this.isExpanded}`);

        if (count <= 1) {
            // 单个标记不需要组合，移除组合标记
            this.removeGroupMarker(map);
            if (count === 1) {
                const marker = this.markers[0];
                // 确保单个标记可见并在正确位置
                if (marker._groupOriginalLatLng) {
                    marker.setLatLng(marker._groupOriginalLatLng);
                }
                if (!map.hasLayer(marker)) {
                    map.addLayer(marker);
                }
            }
            return;
        }

        // 多标记情况：收起状态时隐藏所有子标记
        if (!this.isExpanded) {
            for (let i = 0; i < this.markers.length; i++) {
                const m = this.markers[i];
                if (map.hasLayer(m)) {
                    map.removeLayer(m);
                }
            }
        }

        // 创建或更新组合标记
        if (!this.groupMarker) {
            this.groupMarker = L.marker(this.center, {
                icon: this.createGroupIcon(),
                zIndexOffset: 1000
            });
            this.groupMarker._isGroupMarker = true;
            this.groupMarker._group = this;
        } else {
            this.groupMarker.setIcon(this.createGroupIcon());
            this.groupMarker.setLatLng(this.center);
        }

        // 收起状态时显示组合标记
        if (!this.isExpanded && !map.hasLayer(this.groupMarker)) {
            map.addLayer(this.groupMarker);
        }
    }

    removeGroupMarker(map) {
        if (this.groupMarker && map.hasLayer(this.groupMarker)) {
            map.removeLayer(this.groupMarker);
        }
        // 清除连接线
        this.clearSpiderLegs(map);
    }

    // 计算放射展开位置
    calculateSpiderfyPositions() {
        const count = this.getCount();
        const positions = [];

        if (count <= SPIDERFY_CONFIG.circleSwitchover) {
            // 圆形布局
            const angleStep = (2 * Math.PI) / count;
            for (let i = 0; i < count; i++) {
                const angle = i * angleStep - Math.PI / 2; // 从顶部开始
                positions.push({
                    angle: angle,
                    legLength: SPIDERFY_CONFIG.circleRadius
                });
            }
        } else {
            // 螺旋布局
            let angle = 0;
            let legLength = SPIDERFY_CONFIG.spiralStartRadius;
            for (let i = 0; i < count; i++) {
                positions.push({
                    angle: angle,
                    legLength: legLength
                });
                angle += (2 * Math.PI) / 8; // 每圈8个点
                legLength += SPIDERFY_CONFIG.spiralIncrement;
            }
        }

        return positions;
    }

    // 像素偏移转换为经纬度偏移
    pixelOffsetToLatLng(map, centerLatLng, pixelX, pixelY) {
        const centerPoint = map.latLngToLayerPoint(centerLatLng);
        const offsetPoint = L.point(centerPoint.x + pixelX, centerPoint.y + pixelY);
        return map.layerPointToLatLng(offsetPoint);
    }

    // 展开组合标记
    expand(map, drawnItems) {
        if (this.isExpanded || this.getCount() <= 1) return;

        console.log(`Expanding group with ${this.getCount()} markers`);
        this.isExpanded = true;

        // 隐藏组合标记
        if (this.groupMarker && map.hasLayer(this.groupMarker)) {
            map.removeLayer(this.groupMarker);
        }

        // 清除之前的连接线
        this.clearSpiderLegs(map);

        // 计算展开位置
        const spiderfyPositions = this.calculateSpiderfyPositions();

        // 使用组中心的经纬度作为展开基准
        const centerLatLng = this.center;

        // 展开每个子标记
        for (let i = 0; i < this.markers.length; i++) {
            const marker = this.markers[i];
            const pos = spiderfyPositions[i];

            if (!pos) {
                console.warn(`No position for marker ${i}`);
                continue;
            }

            const offsetX = pos.legLength * Math.cos(pos.angle);
            const offsetY = pos.legLength * Math.sin(pos.angle);

            const newLatLng = this.pixelOffsetToLatLng(map, centerLatLng, offsetX, offsetY);

            // 首次展开时存储原始位置
            if (!marker._groupOriginalLatLng) {
                marker._groupOriginalLatLng = L.latLng(
                    marker.feature?.properties?._originalLat || marker.getLatLng().lat,
                    marker.feature?.properties?._originalLng || marker.getLatLng().lng
                );
            }

            // 移动到展开位置
            marker.setLatLng(newLatLng);

            // 直接添加到地图（不通过 drawnItems，避免图层管理冲突）
            if (!map.hasLayer(marker)) {
                map.addLayer(marker);
            }

            // 绘制连接线
            const leg = L.polyline([centerLatLng, newLatLng], {
                weight: SPIDERFY_CONFIG.legWeight,
                color: SPIDERFY_CONFIG.legColor,
                className: 'spider-leg',
                interactive: false
            });
            leg.addTo(map);
            this.spiderLegs.push(leg);
        }

        console.log(`Group expanded: ${this.getCount()} markers shown`);
    }

    // 收起组合标记
    collapse(map, drawnItems) {
        if (!this.isExpanded) return;

        console.log(`Collapsing group with ${this.getCount()} markers`);
        this.isExpanded = false;

        // 清除连接线
        this.clearSpiderLegs(map);

        // 恢复子标记原始位置并从地图移除（但不删除标记本身）
        for (let i = 0; i < this.markers.length; i++) {
            const marker = this.markers[i];

            // 恢复原始位置
            if (marker._groupOriginalLatLng) {
                marker.setLatLng(marker._groupOriginalLatLng);
            }

            // 从地图移除（视觉上隐藏，但标记对象保留）
            if (map.hasLayer(marker)) {
                map.removeLayer(marker);
            }
        }

        // 重新显示组合标记
        if (this.getCount() > 1) {
            if (!this.groupMarker) {
                this.groupMarker = L.marker(this.center, {
                    icon: this.createGroupIcon(),
                    zIndexOffset: 1000
                });
                this.groupMarker._isGroupMarker = true;
                this.groupMarker._group = this;
            } else {
                this.groupMarker.setIcon(this.createGroupIcon());
            }

            if (!map.hasLayer(this.groupMarker)) {
                map.addLayer(this.groupMarker);
            }
        }

        console.log(`Group collapsed: ${this.getCount()} markers hidden`);
    }

    clearSpiderLegs(map) {
        this.spiderLegs.forEach(leg => {
            if (map.hasLayer(leg)) {
                map.removeLayer(leg);
            }
        });
        this.spiderLegs = [];
    }
}

// ==== MarkerGroupManager 类 ==== //
class MarkerGroupManager {
    constructor(map, drawnItems) {
        this.map = map;
        this.drawnItems = drawnItems;
        this.groups = new Map(); // coordKey -> MarkerGroup
        this.markerToGroup = new Map(); // marker -> MarkerGroup
        this.enabled = true;

        this._bindEvents();
    }

    _bindEvents() {
        // 点击空白处收起所有展开的组
        this.map.on('click', () => {
            this.collapseAll();
        });

        // ESC 键收起
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.collapseAll();
            }
        });
    }

    // 添加标记到管理器
    addMarker(marker) {
        if (!this.enabled) return;

        // 防止重复添加
        if (this.markerToGroup.has(marker)) {
            console.log('Marker already in group, skipping');
            return;
        }

        const origCoord = getOriginalCoord(marker);
        const coordKey = getCoordKey(origCoord);

        let group = this.groups.get(coordKey);
        if (!group) {
            group = new MarkerGroup(coordKey, origCoord);
            this.groups.set(coordKey, group);
        }

        // 存储原始位置到标记上
        if (!marker._groupOriginalLatLng) {
            marker._groupOriginalLatLng = L.latLng(origCoord.lat, origCoord.lng);
        }

        group.addMarker(marker);
        this.markerToGroup.set(marker, group);

        // 更新组合标记显示
        group.updateGroupMarker(this.map, this.drawnItems);

        // 绑定组合标记点击事件（每次都检查）
        this._bindGroupMarkerClick(group);
    }

    // 绑定组合标记点击事件
    _bindGroupMarkerClick(group) {
        if (group.groupMarker && !group.groupMarker._bindedClick) {
            group.groupMarker.on('click', (e) => {
                L.DomEvent.stopPropagation(e);
                this.toggleGroup(group);
            });
            group.groupMarker._bindedClick = true;
        }
    }

    // 移除标记
    removeMarker(marker) {
        const group = this.markerToGroup.get(marker);
        if (!group) return;

        group.removeMarker(marker);
        this.markerToGroup.delete(marker);

        if (group.getCount() === 0) {
            group.removeGroupMarker(this.map);
            this.groups.delete(group.coordKey);
        } else {
            group.updateGroupMarker(this.map, this.drawnItems);
        }
    }

    // 获取标记所属的组
    getGroupForMarker(marker) {
        return this.markerToGroup.get(marker) || null;
    }

    // 切换组的展开/收起状态
    toggleGroup(group) {
        if (group.isExpanded) {
            group.collapse(this.map, this.drawnItems);
        } else {
            // 先收起其他所有组
            this.collapseAll();
            group.expand(this.map, this.drawnItems);
        }
    }

    // 展开指定组
    expandGroup(group) {
        if (!group.isExpanded) {
            this.collapseAll();
            group.expand(this.map, this.drawnItems);
        }
    }

    // 收起所有组
    collapseAll() {
        this.groups.forEach(group => {
            if (group.isExpanded) {
                group.collapse(this.map, this.drawnItems);
            }
        });
    }

    // 刷新所有组的显示
    refresh() {
        this.groups.forEach(group => {
            group.updateGroupMarker(this.map, this.drawnItems);
        });
    }

    // 清空所有数据
    clear() {
        this.groups.forEach(group => {
            group.removeGroupMarker(this.map);
            group.clearSpiderLegs(this.map);
        });
        this.groups.clear();
        this.markerToGroup.clear();
    }

    // 根据标记展开其所属的组
    expandGroupForMarker(marker) {
        const group = this.getGroupForMarker(marker);
        if (group && !group.isExpanded) {
            this.expandGroup(group);
        }
    }

    // 获取统计信息
    getStats() {
        let totalGroups = 0;
        let totalMarkers = 0;
        let groupedMarkers = 0;

        this.groups.forEach(group => {
            totalGroups++;
            totalMarkers += group.getCount();
            if (group.getCount() > 1) {
                groupedMarkers += group.getCount();
            }
        });

        return { totalGroups, totalMarkers, groupedMarkers };
    }
}

// 全局暴露
window.COORD_EPSILON = COORD_EPSILON;
window.SPIDERFY_CONFIG = SPIDERFY_CONFIG;
window.getCoordKey = getCoordKey;
window.getOriginalCoord = getOriginalCoord;
window.MarkerGroup = MarkerGroup;
window.MarkerGroupManager = MarkerGroupManager;

console.log('Marker Group Manager module loaded');


// ========== selection-manager.js ==========
// ==== Selection Manager - 选中状态管理器 ==== //
// 单例模式，统一管理 Table/Map/Layer Panel/Property Editor 的选中状态

const SelectionManager = (function () {
    let instance = null;

    function createInstance() {
        return {
            currentLayer: null,
            listeners: new Set(),

            // 选中一个图层
            select(layer) {
                if (this.currentLayer === layer) return;

                const previousLayer = this.currentLayer;
                this.currentLayer = layer;

                console.log('SelectionManager: Selected', layer ? (layer.options?.name || L.stamp(layer)) : 'null');

                // 通知所有监听器
                this.notifyListeners({
                    type: 'select',
                    current: layer,
                    previous: previousLayer
                });
            },

            // 取消选中
            deselect() {
                if (!this.currentLayer) return;

                const previousLayer = this.currentLayer;
                this.currentLayer = null;

                console.log('SelectionManager: Deselected');

                this.notifyListeners({
                    type: 'deselect',
                    current: null,
                    previous: previousLayer
                });
            },

            // 获取当前选中的图层
            getSelected() {
                return this.currentLayer;
            },

            // 注册选中变化监听器
            onSelectionChange(callback) {
                this.listeners.add(callback);
                // 返回取消订阅函数
                return () => this.listeners.delete(callback);
            },

            // 通知所有监听器
            notifyListeners(event) {
                this.listeners.forEach(callback => {
                    try {
                        callback(event);
                    } catch (e) {
                        console.error('SelectionManager listener error:', e);
                    }
                });
            },

            // 检查指定图层是否为当前选中
            isSelected(layer) {
                return this.currentLayer === layer;
            },

            // 通过 Leaflet ID 选中
            selectById(leafletId) {
                // 优先从 drawnItems 查找
                if (typeof drawnItems !== 'undefined') {
                    const layer = drawnItems.getLayer(leafletId);
                    if (layer) {
                        this.select(layer);
                        return true;
                    }
                }

                // 从 MarkerGroupManager 查找（包括收起状态的标记）
                if (typeof markerGroupManager !== 'undefined' && markerGroupManager) {
                    for (const [marker, group] of markerGroupManager.markerToGroup) {
                        if (L.stamp(marker) === leafletId) {
                            // 如果在收起的组中，先展开
                            if (!group.isExpanded && group.getCount() > 1) {
                                markerGroupManager.expandGroup(group);
                            }
                            this.select(marker);
                            return true;
                        }
                    }
                }

                return false;
            }
        };
    }

    return {
        getInstance() {
            if (!instance) {
                instance = createInstance();
            }
            return instance;
        }
    };
})();

// 全局快捷访问
window.selectionManager = SelectionManager.getInstance();

console.log('SelectionManager module loaded');


// ========== layer-stats.js ==========
// ==== Layer Statistics Module - 图层统计模块 ==== //

// 更新图层统计信息
function updateLayerStats() {
    const statsContainer = document.getElementById('layerStats');
    if (!statsContainer) return;

    // 收集所有标记（包括分组中的）
    const markers = [];
    const typeCount = {};

    // 从 drawnItems 收集
    if (typeof drawnItems !== 'undefined') {
        drawnItems.eachLayer(layer => {
            if (layer instanceof L.Marker && !layer._isGroupMarker) {
                markers.push(layer);
            }
        });
    }

    // 从 MarkerGroupManager 收集（包括收起状态的）
    if (typeof markerGroupManager !== 'undefined' && markerGroupManager) {
        markerGroupManager.groups.forEach(group => {
            group.markers.forEach(marker => {
                if (!markers.includes(marker)) {
                    markers.push(marker);
                }
            });
        });
    }

    // 统计类型分布
    markers.forEach(marker => {
        const props = marker.feature?.properties || {};
        const type = props.类型 || props.type || props.category || '未分类';
        typeCount[type] = (typeCount[type] || 0) + 1;
    });

    // 计算分组数量
    let groupCount = 0;
    if (typeof markerGroupManager !== 'undefined' && markerGroupManager) {
        markerGroupManager.groups.forEach(group => {
            if (group.getCount() > 1) {
                groupCount++;
            }
        });
    }

    // 计算自定义组数量
    let customGroupCount = 0;
    if (typeof customGroupManager !== 'undefined' && customGroupManager) {
        customGroupCount = customGroupManager.groups.size;
    }

    // 生成 HTML
    const total = markers.length;
    const typeEntries = Object.entries(typeCount).sort((a, b) => b[1] - a[1]);

    let html = `
        <div class="stats-header">
            <span class="stats-total">${total}</span>
            <span class="stats-label">个标记</span>
            ${groupCount > 0 ? `<span class="stats-group-badge">${groupCount} 个坐标组</span>` : ''}
            ${customGroupCount > 0 ? `<span class="stats-group-badge custom">${customGroupCount} 个自定义组</span>` : ''}
        </div>
    `;

    if (typeEntries.length > 0) {
        html += '<div class="stats-breakdown">';
        typeEntries.forEach(([type, count]) => {
            const percent = Math.round((count / total) * 100);
            html += `
                <div class="stats-row">
                    <span class="stats-type">${type}</span>
                    <span class="stats-bar">
                        <span class="stats-bar-fill" style="width: ${percent}%"></span>
                    </span>
                    <span class="stats-count">${count}</span>
                </div>
            `;
        });
        html += '</div>';
    } else {
        html += '<div class="stats-empty">暂无标记数据</div>';
    }

    statsContainer.innerHTML = html;
}

// 自动刷新统计（监听数据变化）
function initLayerStatsRefresh() {
    // 定期刷新（作为后备机制）
    setInterval(() => {
        updateLayerStats();
    }, 2000);

    // 初始刷新
    setTimeout(() => {
        updateLayerStats();
    }, 500);
}

// 全局暴露
window.updateLayerStats = updateLayerStats;
window.initLayerStatsRefresh = initLayerStatsRefresh;

console.log('Layer Stats module loaded');


// ========== custom-group-manager.js ==========
// ==== Custom Group Manager - 自定义组管理模块 ==== //
// 支持用户多选标记创建命名组，用于统计/筛选/导出

const CUSTOM_GROUPS_STORAGE_KEY = 'geomap_custom_groups';

// ==== CustomGroup 类 ==== //
class CustomGroup {
    constructor(groupId, groupName, color = '#ff6b6b') {
        this.groupId = groupId;
        this.groupName = groupName;
        this.memberIds = [];  // Leaflet stamp IDs
        this.color = color;
        this.rule = null;     // 预留自动规则
        this.created = new Date().toISOString();
        this.expanded = false;
    }

    addMember(leafletId) {
        if (!this.memberIds.includes(leafletId)) {
            this.memberIds.push(leafletId);
        }
    }

    removeMember(leafletId) {
        const idx = this.memberIds.indexOf(leafletId);
        if (idx > -1) {
            this.memberIds.splice(idx, 1);
        }
    }

    hasMember(leafletId) {
        return this.memberIds.includes(leafletId);
    }

    getCount() {
        return this.memberIds.length;
    }

    toJSON() {
        return {
            groupId: this.groupId,
            groupName: this.groupName,
            memberIds: this.memberIds,
            color: this.color,
            rule: this.rule,
            created: this.created
        };
    }

    static fromJSON(data) {
        const group = new CustomGroup(data.groupId, data.groupName, data.color);
        group.memberIds = data.memberIds || [];
        group.rule = data.rule || null;
        group.created = data.created || new Date().toISOString();
        return group;
    }
}

// ==== CustomGroupManager 类 ==== //
class CustomGroupManager {
    constructor() {
        this.groups = new Map();        // groupId -> CustomGroup
        this.markerToGroups = new Map(); // leafletId -> Set<groupId>
        this.selectionMode = false;
        this.selectedMarkers = new Set(); // 当前选中的标记（多选模式）

        this._loadFromStorage();
        this._renderGroupList();
    }

    // === 存储管理 === //
    _loadFromStorage() {
        try {
            const data = localStorage.getItem(CUSTOM_GROUPS_STORAGE_KEY);
            if (data) {
                const parsed = JSON.parse(data);
                Object.values(parsed).forEach(groupData => {
                    const group = CustomGroup.fromJSON(groupData);
                    this.groups.set(group.groupId, group);

                    // 重建 markerToGroups 索引
                    group.memberIds.forEach(id => {
                        if (!this.markerToGroups.has(id)) {
                            this.markerToGroups.set(id, new Set());
                        }
                        this.markerToGroups.get(id).add(group.groupId);
                    });
                });
                console.log(`Loaded ${this.groups.size} custom groups from storage`);
            }
        } catch (e) {
            console.error('Failed to load custom groups:', e);
        }
    }

    _saveToStorage() {
        try {
            const data = {};
            this.groups.forEach((group, groupId) => {
                data[groupId] = group.toJSON();
            });
            localStorage.setItem(CUSTOM_GROUPS_STORAGE_KEY, JSON.stringify(data));
        } catch (e) {
            console.error('Failed to save custom groups:', e);
        }
    }

    // === 多选模式 === //
    enterSelectionMode() {
        this.selectionMode = true;
        this.selectedMarkers.clear();
        document.body.classList.add('selection-mode');

        // 更新 UI
        const btn = document.getElementById('enterSelectionModeBtn');
        if (btn) {
            btn.textContent = '取消选择';
            btn.onclick = () => this.exitSelectionMode();
        }

        // 显示完成按钮
        const finishBtn = document.getElementById('finishSelectionBtn');
        if (finishBtn) finishBtn.style.display = 'block';

        this._updateSelectionCount();
        console.log('Entered selection mode');
    }

    exitSelectionMode() {
        this.selectionMode = false;
        this.selectedMarkers.clear();
        document.body.classList.remove('selection-mode');

        // 清除所有标记的选中态
        if (typeof drawnItems !== 'undefined') {
            drawnItems.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    this._removeSelectionHighlight(layer);
                }
            });
        }

        // 恢复 UI
        const btn = document.getElementById('enterSelectionModeBtn');
        if (btn) {
            btn.textContent = '选择标记创建组';
            btn.onclick = () => this.enterSelectionMode();
        }

        const finishBtn = document.getElementById('finishSelectionBtn');
        if (finishBtn) finishBtn.style.display = 'none';

        const countSpan = document.getElementById('selectionCount');
        if (countSpan) countSpan.style.display = 'none';

        console.log('Exited selection mode');
    }

    toggleMarkerSelection(marker) {
        if (!this.selectionMode) return;

        const leafletId = L.stamp(marker);

        if (this.selectedMarkers.has(marker)) {
            this.selectedMarkers.delete(marker);
            this._removeSelectionHighlight(marker);
        } else {
            this.selectedMarkers.add(marker);
            this._addSelectionHighlight(marker);
        }

        this._updateSelectionCount();
    }

    _addSelectionHighlight(marker) {
        const icon = marker.getIcon();
        if (icon && icon.options && icon.options.html) {
            if (!marker._originalIconHtml) {
                marker._originalIconHtml = icon.options.html;
            }
            const highlightedHtml = icon.options.html.replace(
                'class="marker-pin',
                'class="marker-pin selection-highlight'
            );
            marker.setIcon(L.divIcon({
                ...icon.options,
                html: highlightedHtml
            }));
        }
    }

    _removeSelectionHighlight(marker) {
        if (marker._originalIconHtml) {
            const icon = marker.getIcon();
            marker.setIcon(L.divIcon({
                ...icon.options,
                html: marker._originalIconHtml
            }));
            delete marker._originalIconHtml;
        }
    }

    _updateSelectionCount() {
        const countSpan = document.getElementById('selectionCount');
        if (countSpan) {
            countSpan.textContent = `已选择 ${this.selectedMarkers.size} 个标记`;
            countSpan.style.display = this.selectedMarkers.size > 0 ? 'block' : 'none';
        }
    }

    // === 组 CRUD === //
    createGroup(groupName) {
        if (this.selectedMarkers.size === 0) {
            alert('请先选择至少一个标记');
            return null;
        }

        const groupId = `grp_${Date.now()}`;
        const group = new CustomGroup(groupId, groupName);

        // 添加选中的标记
        this.selectedMarkers.forEach(marker => {
            const leafletId = L.stamp(marker);
            group.addMember(leafletId);

            // 更新标记属性
            if (!marker.feature) marker.feature = { properties: {} };
            if (!marker.feature.properties._customGroups) {
                marker.feature.properties._customGroups = [];
            }
            if (!marker.feature.properties._customGroups.includes(groupId)) {
                marker.feature.properties._customGroups.push(groupId);
            }

            // 更新索引
            if (!this.markerToGroups.has(leafletId)) {
                this.markerToGroups.set(leafletId, new Set());
            }
            this.markerToGroups.get(leafletId).add(groupId);
        });

        this.groups.set(groupId, group);
        this._saveToStorage();
        this._renderGroupList();
        this.exitSelectionMode();

        // 刷新统计
        if (typeof updateLayerStats === 'function') {
            updateLayerStats();
        }

        console.log(`Created group "${groupName}" with ${group.getCount()} members`);
        return group;
    }

    deleteGroup(groupId) {
        const group = this.groups.get(groupId);
        if (!group) return;

        // 从标记属性中移除组引用
        group.memberIds.forEach(leafletId => {
            const groupSet = this.markerToGroups.get(leafletId);
            if (groupSet) {
                groupSet.delete(groupId);
                if (groupSet.size === 0) {
                    this.markerToGroups.delete(leafletId);
                }
            }

            // 更新标记属性
            if (typeof drawnItems !== 'undefined') {
                drawnItems.eachLayer(layer => {
                    if (L.stamp(layer) === leafletId && layer.feature?.properties?._customGroups) {
                        const idx = layer.feature.properties._customGroups.indexOf(groupId);
                        if (idx > -1) {
                            layer.feature.properties._customGroups.splice(idx, 1);
                        }
                    }
                });
            }
        });

        this.groups.delete(groupId);
        this._saveToStorage();
        this._renderGroupList();

        // 刷新统计
        if (typeof updateLayerStats === 'function') {
            updateLayerStats();
        }

        console.log(`Deleted group "${group.groupName}"`);
    }

    renameGroup(groupId, newName) {
        const group = this.groups.get(groupId);
        if (group) {
            group.groupName = newName;
            this._saveToStorage();
            this._renderGroupList();
        }
    }

    // === 组操作 === //
    getGroupsForMarker(marker) {
        const leafletId = L.stamp(marker);
        const groupIds = this.markerToGroups.get(leafletId);
        if (!groupIds) return [];

        return Array.from(groupIds).map(id => this.groups.get(id)).filter(Boolean);
    }

    focusOnGroup(groupId) {
        const group = this.groups.get(groupId);
        if (!group || group.getCount() === 0) return;

        // 收集组内标记
        const markers = [];
        if (typeof drawnItems !== 'undefined') {
            drawnItems.eachLayer(layer => {
                if (group.hasMember(L.stamp(layer))) {
                    markers.push(layer);
                }
            });
        }

        // 也检查 markerGroupManager 中的标记
        if (typeof markerGroupManager !== 'undefined' && markerGroupManager) {
            markerGroupManager.groups.forEach(coordGroup => {
                coordGroup.markers.forEach(marker => {
                    if (group.hasMember(L.stamp(marker)) && !markers.includes(marker)) {
                        markers.push(marker);
                    }
                });
            });
        }

        if (markers.length === 0) return;

        // 创建 bounds
        const bounds = L.latLngBounds();
        markers.forEach(m => {
            const latlng = m._groupOriginalLatLng || m.getLatLng();
            bounds.extend(latlng);
        });

        if (typeof map !== 'undefined') {
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    }

    // === 导出 === //
    exportGroupGeoJSON(groupId) {
        const group = this.groups.get(groupId);
        if (!group) return null;

        const features = [];

        // 收集组内标记
        if (typeof drawnItems !== 'undefined') {
            drawnItems.eachLayer(layer => {
                if (group.hasMember(L.stamp(layer))) {
                    features.push(layer.toGeoJSON());
                }
            });
        }

        // 也检查 markerGroupManager 中的标记
        if (typeof markerGroupManager !== 'undefined' && markerGroupManager) {
            markerGroupManager.groups.forEach(coordGroup => {
                coordGroup.markers.forEach(marker => {
                    if (group.hasMember(L.stamp(marker))) {
                        const exists = features.some(f =>
                            f.geometry.coordinates[0] === marker.getLatLng().lng &&
                            f.geometry.coordinates[1] === marker.getLatLng().lat
                        );
                        if (!exists) {
                            features.push(marker.toGeoJSON());
                        }
                    }
                });
            });
        }

        return {
            type: 'FeatureCollection',
            properties: {
                groupId: group.groupId,
                groupName: group.groupName,
                exportedAt: new Date().toISOString()
            },
            features: features
        };
    }

    downloadGroupGeoJSON(groupId) {
        const group = this.groups.get(groupId);
        if (!group) return;

        const geojson = this.exportGroupGeoJSON(groupId);
        if (!geojson) return;

        const data = JSON.stringify(geojson, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `${group.groupName}.geojson`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // === UI 渲染 === //
    _renderGroupList() {
        const container = document.getElementById('customGroupList');
        if (!container) return;

        if (this.groups.size === 0) {
            container.innerHTML = '<div class="empty-groups">暂无自定义组</div>';
            return;
        }

        let html = '';
        this.groups.forEach((group, groupId) => {
            html += `
                <div class="custom-group-item" data-group-id="${groupId}">
                    <div class="group-info" onclick="customGroupManager.focusOnGroup('${groupId}')">
                        <span class="group-color" style="background:${group.color}"></span>
                        <span class="group-name">${group.groupName}</span>
                        <span class="group-count">${group.getCount()}</span>
                    </div>
                    <div class="group-actions">
                        <button onclick="customGroupManager.downloadGroupGeoJSON('${groupId}')" title="导出该组">
                            <i class="fa-solid fa-download"></i>
                        </button>
                        <button onclick="customGroupManager.renameGroupPrompt('${groupId}')" title="重命名">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button onclick="customGroupManager.deleteGroup('${groupId}')" title="删除" class="delete">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    renameGroupPrompt(groupId) {
        const group = this.groups.get(groupId);
        if (!group) return;

        const newName = prompt('输入新的组名：', group.groupName);
        if (newName && newName.trim()) {
            this.renameGroup(groupId, newName.trim());
        }
    }

    // === 获取统计 === //
    getStats() {
        return {
            totalGroups: this.groups.size,
            groups: Array.from(this.groups.values()).map(g => ({
                groupId: g.groupId,
                groupName: g.groupName,
                memberCount: g.getCount(),
                color: g.color
            }))
        };
    }

    // === 完成选择并创建组 === //
    finishSelectionAndCreateGroup() {
        if (this.selectedMarkers.size === 0) {
            alert('请先选择至少一个标记');
            return;
        }

        const groupName = prompt('请输入组名：');
        if (groupName && groupName.trim()) {
            this.createGroup(groupName.trim());
        }
    }
}

// 全局暴露
window.CustomGroup = CustomGroup;
window.CustomGroupManager = CustomGroupManager;

// 初始化（延迟到 DOM 加载后）
let customGroupManager = null;

document.addEventListener('DOMContentLoaded', () => {
    // 等待其他模块加载
    setTimeout(() => {
        customGroupManager = new CustomGroupManager();
        window.customGroupManager = customGroupManager;
        console.log('CustomGroupManager initialized');
    }, 500);
});

console.log('Custom Group Manager module loaded');


// ========== timeline-manager.js ==========
// ==== Timeline Manager - 时间轴快照管理模块 ==== //
// 支持保存/加载不同时间点的地图状态（图层、样式、视图）

const SNAPSHOTS_STORAGE_KEY = 'geomap_snapshots';

// ==== Snapshot 数据结构 ==== //
class Snapshot {
    constructor(name, timestamp = null) {
        this.snapshotId = `snap_${Date.now()}`;
        this.timestamp = timestamp || new Date().toISOString();
        this.name = name;
        this.layers = [];
        this.customGroups = {};
        this.viewState = null;
    }

    // 从当前地图状态创建快照
    static createFromCurrentState(name) {
        const snapshot = new Snapshot(name);

        // 保存视图状态
        if (typeof map !== 'undefined') {
            const center = map.getCenter();
            snapshot.viewState = {
                center: [center.lat, center.lng],
                zoom: map.getZoom()
            };
        }

        // 收集所有图层数据（包括样式信息）
        snapshot.layers = snapshot._collectLayerData();

        // 保存自定义组
        if (typeof customGroupManager !== 'undefined' && customGroupManager) {
            const groups = {};
            customGroupManager.groups.forEach((group, groupId) => {
                groups[groupId] = group.toJSON();
            });
            snapshot.customGroups = groups;
        }

        return snapshot;
    }

    _collectLayerData() {
        const layers = [];
        const processedMarkers = new Set();

        // 收集标记数据
        const features = [];

        // 从 drawnItems 收集
        if (typeof drawnItems !== 'undefined') {
            drawnItems.eachLayer(layer => {
                if (layer._isGroupMarker) return;
                if (processedMarkers.has(layer)) return;
                processedMarkers.add(layer);

                const feature = this._layerToGeoJSON(layer);
                if (feature) features.push(feature);
            });
        }

        // 从 MarkerGroupManager 收集（包括收起状态的）
        if (typeof markerGroupManager !== 'undefined' && markerGroupManager) {
            markerGroupManager.groups.forEach(group => {
                group.markers.forEach(marker => {
                    if (processedMarkers.has(marker)) return;
                    processedMarkers.add(marker);

                    const feature = this._layerToGeoJSON(marker);
                    if (feature) features.push(feature);
                });
            });
        }

        // 创建主图层
        layers.push({
            layerId: 'main_layer',
            layerName: '主图层',
            visible: true,
            geojson: {
                type: 'FeatureCollection',
                features: features
            }
        });

        return layers;
    }

    _layerToGeoJSON(layer) {
        if (!layer) return null;

        const geoJSON = layer.toGeoJSON();

        // 确保保存所有样式属性
        if (layer.feature && layer.feature.properties) {
            geoJSON.properties = { ...layer.feature.properties };
        }

        // 对于标记，保存原始坐标
        if (layer instanceof L.Marker) {
            const props = layer.feature?.properties || {};
            if (props._originalLat !== undefined && props._originalLng !== undefined) {
                geoJSON.geometry.coordinates = [props._originalLng, props._originalLat];
            }
        }

        return geoJSON;
    }

    toJSON() {
        return {
            snapshotId: this.snapshotId,
            timestamp: this.timestamp,
            name: this.name,
            layers: this.layers,
            customGroups: this.customGroups,
            viewState: this.viewState
        };
    }

    static fromJSON(data) {
        const snapshot = new Snapshot(data.name, data.timestamp);
        snapshot.snapshotId = data.snapshotId;
        snapshot.layers = data.layers || [];
        snapshot.customGroups = data.customGroups || {};
        snapshot.viewState = data.viewState || null;
        return snapshot;
    }
}

// ==== TimelineManager 类 ==== //
class TimelineManager {
    constructor() {
        this.snapshots = new Map();  // snapshotId -> Snapshot
        this.currentSnapshotId = null;

        // 浏览模式状态
        this.isBrowseMode = false;
        this.savedEditState = null;  // 进入浏览模式前保存的编辑态

        this._loadFromStorage();
        this._renderTimelineUI();
    }

    // === 存储管理 === //
    _loadFromStorage() {
        try {
            const data = localStorage.getItem(SNAPSHOTS_STORAGE_KEY);
            if (data) {
                const parsed = JSON.parse(data);
                this.currentSnapshotId = parsed.currentSnapshotId || null;

                if (parsed.snapshots) {
                    Object.values(parsed.snapshots).forEach(snapData => {
                        const snapshot = Snapshot.fromJSON(snapData);
                        this.snapshots.set(snapshot.snapshotId, snapshot);
                    });
                }
                console.log(`Loaded ${this.snapshots.size} snapshots from storage`);
            }
        } catch (e) {
            console.error('Failed to load snapshots:', e);
        }
    }

    _saveToStorage() {
        try {
            const snapshots = {};
            this.snapshots.forEach((snapshot, id) => {
                snapshots[id] = snapshot.toJSON();
            });

            localStorage.setItem(SNAPSHOTS_STORAGE_KEY, JSON.stringify({
                currentSnapshotId: this.currentSnapshotId,
                snapshots: snapshots
            }));
        } catch (e) {
            console.error('Failed to save snapshots:', e);
        }
    }

    // === 快照操作 === //
    saveSnapshot(name) {
        if (this.isBrowseMode) {
            alert('🚫 浏览模式下无法保存快照，请先退出或应用快照。');
            return null;
        }

        const snapshot = Snapshot.createFromCurrentState(name);
        this.snapshots.set(snapshot.snapshotId, snapshot);
        this.currentSnapshotId = snapshot.snapshotId;

        this._saveToStorage();
        this._renderTimelineUI();

        if (typeof showBriefMessage === 'function') {
            showBriefMessage(`✅ 已保存快照：${name}`);
        }

        // 刷新看板
        if (typeof updateDashboard === 'function') {
            updateDashboard();
        }

        console.log(`Snapshot saved: ${name} (${snapshot.snapshotId})`);
        return snapshot;
    }

    loadSnapshot(snapshotId) {
        const snapshot = this.snapshots.get(snapshotId);
        if (!snapshot) {
            console.warn('Snapshot not found:', snapshotId);
            return false;
        }

        console.log(`Loading snapshot: ${snapshot.name}`);

        // ⚠️ 完全重置所有运行时状态，确保快照隔离
        this._resetRuntimeState();

        // 恢复图层数据
        snapshot.layers.forEach(layerData => {
            if (layerData.geojson && layerData.geojson.features) {
                this._importGeoJSON(layerData.geojson);
            }
        });

        // 恢复视图状态
        if (snapshot.viewState && typeof map !== 'undefined') {
            map.setView(snapshot.viewState.center, snapshot.viewState.zoom);
        }

        // 恢复自定义组
        if (typeof customGroupManager !== 'undefined' && customGroupManager && snapshot.customGroups) {
            // 重建组（注意：需要在标记加载后执行）
            setTimeout(() => {
                Object.values(snapshot.customGroups).forEach(groupData => {
                    const group = CustomGroup.fromJSON(groupData);
                    customGroupManager.groups.set(group.groupId, group);

                    group.memberIds.forEach(id => {
                        if (!customGroupManager.markerToGroups.has(id)) {
                            customGroupManager.markerToGroups.set(id, new Set());
                        }
                        customGroupManager.markerToGroups.get(id).add(group.groupId);
                    });
                });
                customGroupManager._renderGroupList();
            }, 100);
        }

        this.currentSnapshotId = snapshotId;
        this._saveToStorage();
        this._renderTimelineUI();

        // 刷新所有视图
        this._refreshAllViews();

        if (typeof showBriefMessage === 'function') {
            showBriefMessage(`✅ 已加载快照：${snapshot.name}`);
        }

        return true;
    }

    // ⚠️ 完全重置所有运行时状态（快照加载前必须调用）
    _resetRuntimeState() {
        console.log('Resetting all runtime state...');

        // 1. 清空 MarkerGroupManager（必须在 drawnItems 之前）
        if (typeof markerGroupManager !== 'undefined' && markerGroupManager) {
            markerGroupManager.clear();
            // 清空内部索引
            if (markerGroupManager.coordIndex) {
                markerGroupManager.coordIndex.clear();
            }
            if (markerGroupManager.markerToGroup) {
                markerGroupManager.markerToGroup.clear();
            }
        }

        // 2. 清空 drawnItems
        if (typeof drawnItems !== 'undefined') {
            drawnItems.clearLayers();
        }

        // 3. 清空自定义组
        if (typeof customGroupManager !== 'undefined' && customGroupManager) {
            customGroupManager.groups.clear();
            customGroupManager.markerToGroups.clear();
            customGroupManager._renderGroupList();
        }

        // 4. 清空 SelectionManager 状态
        if (typeof selectionManager !== 'undefined' && selectionManager) {
            selectionManager.deselect();
        }

        // 5. 清空表格数据
        if (typeof featureTable !== 'undefined' && featureTable) {
            featureTable.clearData();
        }

        // 6. 重置统计缓存
        if (typeof updateLayerStats === 'function') {
            updateLayerStats();
        }

        // 7. 更新图层详情面板
        if (typeof updateLayerDetailsPanel === 'function') {
            updateLayerDetailsPanel(null);
        }

        console.log('Runtime state reset complete');
    }

    _importGeoJSON(geojson) {
        if (!geojson || !geojson.features) return;

        L.geoJSON(geojson, {
            pointToLayer: (feature, latlng) => {
                const props = feature.properties || {};
                const color = props['marker-color'] || '#4a90e2';
                const symbol = props['marker-symbol'] || 'default';

                const icon = typeof createCustomMarkerIcon === 'function'
                    ? createCustomMarkerIcon(color, symbol)
                    : L.divIcon({ className: 'custom-marker-icon' });

                const marker = L.marker(latlng, { icon });
                marker.feature = { properties: { ...props } };

                if (typeof bindMarkerPopup === 'function') {
                    bindMarkerPopup(marker);
                }
                if (typeof bindMarkerContextMenu === 'function') {
                    bindMarkerContextMenu(marker);
                }

                return marker;
            },
            style: feature => {
                const style = {};
                const props = feature.properties || {};
                if (props.stroke) style.color = props.stroke;
                if (props['stroke-width']) style.weight = props['stroke-width'];
                if (props.fill) style.fillColor = props.fill;
                if (props['fill-opacity']) style.fillOpacity = props['fill-opacity'];
                return style;
            },
            onEachFeature: (feature, layer) => {
                if (layer instanceof L.Marker) {
                    if (typeof markerGroupManager !== 'undefined' && markerGroupManager) {
                        markerGroupManager.addMarker(layer);
                    } else {
                        drawnItems.addLayer(layer);
                    }
                } else {
                    drawnItems.addLayer(layer);
                }
            }
        });
    }

    _refreshAllViews() {
        // 刷新图层列表
        if (typeof updateLayerList === 'function') {
            updateLayerList();
        }

        // 刷新表格
        if (typeof updateFeatureTable === 'function') {
            updateFeatureTable();
        }

        // 刷新看板
        if (typeof updateDashboard === 'function') {
            updateDashboard();
        }

        // 刷新统计
        if (typeof updateLayerStats === 'function') {
            updateLayerStats();
        }
    }

    deleteSnapshot(snapshotId) {
        if (!this.snapshots.has(snapshotId)) return false;

        const snapshot = this.snapshots.get(snapshotId);
        this.snapshots.delete(snapshotId);

        if (this.currentSnapshotId === snapshotId) {
            this.currentSnapshotId = null;
        }

        this._saveToStorage();
        this._renderTimelineUI();

        if (typeof showBriefMessage === 'function') {
            showBriefMessage(`🗑️ 已删除快照：${snapshot.name}`);
        }

        return true;
    }

    renameSnapshot(snapshotId, newName) {
        const snapshot = this.snapshots.get(snapshotId);
        if (!snapshot) return false;

        snapshot.name = newName;
        this._saveToStorage();
        this._renderTimelineUI();

        return true;
    }

    // === 获取当前快照信息 === //
    getCurrentSnapshot() {
        if (!this.currentSnapshotId) return null;
        return this.snapshots.get(this.currentSnapshotId) || null;
    }

    getCurrentSnapshotName() {
        const snapshot = this.getCurrentSnapshot();
        return snapshot ? snapshot.name : '未保存状态';
    }

    // === UI 渲染 === //
    _renderTimelineUI() {
        const container = document.getElementById('timelineList');
        if (!container) return;

        if (this.snapshots.size === 0) {
            container.innerHTML = '<div class="timeline-empty">暂无时间点，点击上方保存当前状态</div>';
            return;
        }

        // 按时间排序
        const sorted = Array.from(this.snapshots.values())
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        let html = '';

        // 浏览模式下添加提示
        if (this.isBrowseMode) {
            html += '<div class="browse-mode-hint">📖 浏览模式：点击快照切换查看</div>';
        }

        sorted.forEach(snapshot => {
            const isCurrent = snapshot.snapshotId === this.currentSnapshotId;
            const date = new Date(snapshot.timestamp);
            const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

            // 计算标记数量
            let featureCount = 0;
            if (snapshot.layers && snapshot.layers[0] && snapshot.layers[0].geojson) {
                featureCount = snapshot.layers[0].geojson.features?.length || 0;
            }

            html += `
                <div class="timeline-item ${isCurrent ? 'active' : ''} ${this.isBrowseMode ? 'browse-mode' : ''}" data-snapshot-id="${snapshot.snapshotId}">
                    <div class="timeline-marker">${isCurrent ? '●' : '○'}</div>
                    <div class="timeline-content" onclick="timelineManager.onSnapshotClick('${snapshot.snapshotId}')">
                        <div class="timeline-name">${snapshot.name}</div>
                        <div class="timeline-meta">
                            <span class="timeline-date">${dateStr}</span>
                            <span class="timeline-count">${featureCount} 个标记</span>
                        </div>
                    </div>
                    <div class="timeline-actions">
                        <button onclick="event.stopPropagation(); timelineManager.renameSnapshotPrompt('${snapshot.snapshotId}')" title="重命名">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button onclick="event.stopPropagation(); timelineManager.deleteSnapshot('${snapshot.snapshotId}')" title="删除" class="delete">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;

        // 浏览模式下更新状态条
        if (this.isBrowseMode) {
            this._renderBrowseModeBar();
        }
    }

    // 快照点击处理
    onSnapshotClick(snapshotId) {
        if (this.isBrowseMode) {
            // 浏览模式：直接加载
            this.loadSnapshot(snapshotId);
        } else {
            // 编辑模式：提示进入浏览模式
            if (confirm('要加载此快照吗？\n\n• 点击「确定」进入浏览模式查看\n• 点击「取消」保持当前编辑')) {
                this.enterBrowseMode();
                this.loadSnapshot(snapshotId);
            }
        }
    }

    renameSnapshotPrompt(snapshotId) {
        const snapshot = this.snapshots.get(snapshotId);
        if (!snapshot) return;

        const newName = prompt('输入新的时间点名称：', snapshot.name);
        if (newName && newName.trim()) {
            this.renameSnapshot(snapshotId, newName.trim());
        }
    }

    saveSnapshotPrompt() {
        const name = prompt('输入时间点名称：', `快照 ${this.snapshots.size + 1}`);
        if (name && name.trim()) {
            this.saveSnapshot(name.trim());
        }
    }

    // === 获取统计 === //
    getStats() {
        return {
            totalSnapshots: this.snapshots.size,
            currentSnapshotId: this.currentSnapshotId,
            currentSnapshotName: this.getCurrentSnapshotName(),
            isBrowseMode: this.isBrowseMode
        };
    }

    // === 浏览模式 === //

    // 进入浏览模式
    enterBrowseMode() {
        if (this.isBrowseMode) {
            console.log('Already in browse mode');
            return;
        }

        if (this.snapshots.size === 0) {
            if (typeof showBriefMessage === 'function') {
                showBriefMessage('⚠️ 暂无快照可浏览');
            }
            return;
        }

        console.log('Entering browse mode...');

        // 仅在首次进入时保存编辑态（使用深拷贝确保数据隔离）
        if (!this.savedEditState) {
            const snapshot = Snapshot.createFromCurrentState('_edit_backup_');
            // 深拷贝确保数据隔离，避免引用共享导致的串数据问题
            this.savedEditState = JSON.parse(JSON.stringify(snapshot.toJSON()));
            console.log('Edit state saved (deep copy):', this.savedEditState);
        }

        this.isBrowseMode = true;

        // 禁用编辑控件
        this._disableEditControls();

        // 更新 UI
        this._renderTimelineUI();
        this._renderBrowseModeBar();

        if (typeof showBriefMessage === 'function') {
            showBriefMessage('👁️ 已进入浏览模式，点击快照切换查看');
        }

        // 如果有当前快照，加载它
        if (this.currentSnapshotId && this.snapshots.has(this.currentSnapshotId)) {
            this.loadSnapshot(this.currentSnapshotId);
        } else {
            // 加载第一个快照
            const firstSnapshotId = this.snapshots.keys().next().value;
            if (firstSnapshotId) {
                this.loadSnapshot(firstSnapshotId);
            }
        }
    }

    // 退出浏览模式 (支持强制退出)
    exitBrowseMode(force = false) {
        if (!this.isBrowseMode && !force) {
            console.log('Not in browse mode');
            return;
        }

        console.log(`Exiting browse mode (force=${force})...`);

        // 恢复编辑态
        if (this.savedEditState) {
            console.log('Restoring edit state...');
            this._resetRuntimeState();

            try {
                this.savedEditState.layers.forEach(layerData => {
                    if (layerData.geojson && layerData.geojson.features) {
                        this._importGeoJSON(layerData.geojson);
                    }
                });

                if (this.savedEditState.viewState && typeof map !== 'undefined') {
                    map.setView(this.savedEditState.viewState.center, this.savedEditState.viewState.zoom);
                }

                // 恢复自定义组
                if (typeof customGroupManager !== 'undefined' && customGroupManager && this.savedEditState.customGroups) {
                    setTimeout(() => {
                        Object.values(this.savedEditState.customGroups).forEach(groupData => {
                            const group = CustomGroup.fromJSON(groupData);
                            customGroupManager.groups.set(group.groupId, group);
                            group.memberIds.forEach(id => {
                                if (!customGroupManager.markerToGroups.has(id)) {
                                    customGroupManager.markerToGroups.set(id, new Set());
                                }
                                customGroupManager.markerToGroups.get(id).add(group.groupId);
                            });
                        });
                        customGroupManager._renderGroupList();
                    }, 100);
                }

                this._refreshAllViews();
            } catch (e) {
                console.error('Error restoring edit state:', e);
                if (typeof showBriefMessage === 'function') {
                    showBriefMessage('⚠️ 恢复编辑态时发生错误，已重置为安全状态');
                }
            }
        } else {
            console.warn('No saved edit state found. Resetting to empty state.');
            // 即使没有保存的状态，也要清理当前快照的残留
            if (force) {
                this._resetRuntimeState();
                this._refreshAllViews();
            }
        }

        this.isBrowseMode = false;
        this.savedEditState = null;
        this.currentSnapshotId = null; // 退出后不选中任何快照

        // 启用编辑控件（这是最重要的步骤，保证不被锁定）
        this._enableEditControls();

        // 更新 UI
        this._renderTimelineUI();
        this._hideBrowseModeBar();

        if (typeof showBriefMessage === 'function') {
            showBriefMessage('✏️ 已退出浏览模式，返回编辑状态');
        }
    }

    // 应用当前浏览的快照到编辑态
    applyBrowsingSnapshot() {
        if (!this.isBrowseMode || !this.currentSnapshotId) {
            return;
        }

        const snapshot = this.snapshots.get(this.currentSnapshotId);
        if (!snapshot) return;

        if (confirm(`确定要将快照「${snapshot.name}」应用到当前编辑态吗？\n\n这将覆盖之前的编辑内容！`)) {
            console.log('Applying browsing snapshot to edit state...');

            // 清空保存的编辑态
            this.savedEditState = null;

            // 退出浏览模式但保留当前数据
            this.isBrowseMode = false;
            this._enableEditControls();
            this._renderTimelineUI();
            this._hideBrowseModeBar();

            if (typeof showBriefMessage === 'function') {
                showBriefMessage(`✅ 已应用快照「${snapshot.name}」`);
            }
        }
    }

    // 渲染浏览模式状态条（居中悬浮，紧凑设计）
    _renderBrowseModeBar() {
        let bar = document.getElementById('browseModeBar');
        if (!bar) {
            bar = document.createElement('div');
            bar.id = 'browseModeBar';
            bar.className = 'browse-mode-bar';
            document.body.insertBefore(bar, document.body.firstChild);
        }

        const currentSnapshot = this.getCurrentSnapshot();
        const snapshotName = currentSnapshot ? currentSnapshot.name : '未选择';

        // 紧凑布局：退出按钮 | 标签 | 快照名 | 应用按钮
        bar.innerHTML = `
            <button onclick="timelineManager.exitBrowseMode(true)" class="exit" title="退出浏览模式">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <span class="browse-mode-label">👁️ 只读浏览</span>
            <span class="browse-mode-snapshot">${snapshotName}</span>
            <button onclick="timelineManager.applyBrowsingSnapshot()" class="apply" title="应用到编辑态">
                <i class="fa-solid fa-check"></i> 应用
            </button>
        `;
        bar.style.display = 'flex';
    }

    _hideBrowseModeBar() {
        const bar = document.getElementById('browseModeBar');
        if (bar) {
            bar.style.display = 'none';
        }
    }

    _disableEditControls() {
        console.log('Disabling edit controls for browse mode...');

        // 1. 禁用绘制控制工具栏
        const drawControl = document.querySelector('.leaflet-draw');
        if (drawControl) {
            drawControl.style.opacity = '0.3';
            drawControl.style.pointerEvents = 'none';
        }

        // 2. 禁用导入/清空按钮
        const clearBtn = document.getElementById('clearAllBtn');
        if (clearBtn) clearBtn.disabled = true;

        const importBtn = document.querySelector('.import-btn, #importGeoJSONBtn');
        if (importBtn) importBtn.disabled = true;

        // 3. 禁用文件输入
        const fileInputs = document.querySelectorAll('#geojsonFileInput, #excelFileInput, #coordFileInput');
        fileInputs.forEach(input => {
            if (input) input.disabled = true;
        });

        // 4. 禁用右键菜单中的编辑操作（通过 body 类）
        document.body.classList.add('browse-mode-active');

        // 5. 关闭属性编辑器抽屉
        if (typeof closePropertyDrawer === 'function') {
            closePropertyDrawer();
        }

        // 6. 清空选择状态
        if (typeof selectionManager !== 'undefined' && selectionManager) {
            if (typeof selectionManager.clear === 'function') {
                selectionManager.clear();
            } else if (typeof selectionManager.deselect === 'function') {
                selectionManager.deselect();
            }
        }

        // NOTE: 移除重复的浏览模式遮罩，仅保留顶部操作条作为唯一状态入口
        // this._showBrowseModeOverlay();
    }

    _enableEditControls() {
        console.log('Enabling edit controls after browse mode...');

        // 1. 启用绘制控制工具栏
        const drawControl = document.querySelector('.leaflet-draw');
        if (drawControl) {
            drawControl.style.opacity = '1';
            drawControl.style.pointerEvents = 'auto';
        }

        // 2. 启用按钮
        const clearBtn = document.getElementById('clearAllBtn');
        if (clearBtn) clearBtn.disabled = false;

        const importBtn = document.querySelector('.import-btn, #importGeoJSONBtn');
        if (importBtn) importBtn.disabled = false;

        // 3. 启用文件输入
        const fileInputs = document.querySelectorAll('#geojsonFileInput, #excelFileInput, #coordFileInput');
        fileInputs.forEach(input => {
            if (input) input.disabled = false;
        });

        // 4. 移除浏览模式 body 类
        document.body.classList.remove('browse-mode-active');

        // 5. 隐藏浏览模式遮罩
        this._hideBrowseModeOverlay();

        // 6. 确保地图交互正常
        if (typeof map !== 'undefined') {
            map.dragging.enable();
            map.scrollWheelZoom.enable();
            map.doubleClickZoom.enable();
        }
    }

    // 显示浏览模式地图遮罩提示
    _showBrowseModeOverlay() {
        let overlay = document.getElementById('browseModeMapOverlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'browseModeMapOverlay';
            overlay.className = 'browse-mode-map-overlay';
            overlay.innerHTML = `
                <div class="browse-overlay-content">
                    <i class="fa-solid fa-eye"></i>
                    <span>浏览模式 - 只读</span>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        overlay.style.display = 'flex';
    }

    // 隐藏浏览模式地图遮罩提示
    _hideBrowseModeOverlay() {
        const overlay = document.getElementById('browseModeMapOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    }
}

// 全局暴露
window.Snapshot = Snapshot;
window.TimelineManager = TimelineManager;


// ========== dashboard-panel.js ==========
// ==== Dashboard Panel - 看板统计模块 ==== //
// 右下角隐藏按钮，右上角展开面板，显示图层/类型/样式统计

// ==== DashboardPanel 类 ==== //
class DashboardPanel {
    constructor() {
        this.isOpen = false;
        this._bindEvents();
    }

    _bindEvents() {
        // 打开按钮
        const openBtn = document.getElementById('openDashboardBtn');
        if (openBtn) {
            openBtn.addEventListener('click', () => this.open());
        }

        // 关闭按钮
        const closeBtn = document.getElementById('closeDashboardBtn');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => this.close());
        }
    }

    open() {
        const panel = document.getElementById('dashboardPanel');
        const btn = document.getElementById('openDashboardBtn');

        if (panel) {
            panel.classList.add('open');
            this.isOpen = true;
            this.update();
        }
        if (btn) {
            btn.style.display = 'none';
        }
    }

    close() {
        const panel = document.getElementById('dashboardPanel');
        const btn = document.getElementById('openDashboardBtn');

        if (panel) {
            panel.classList.remove('open');
            this.isOpen = false;
        }
        if (btn) {
            btn.style.display = 'flex';
        }
    }

    toggle() {
        if (this.isOpen) {
            this.close();
        } else {
            this.open();
        }
    }

    // === 统计更新 === //
    update() {
        if (!this.isOpen) return;

        const container = document.getElementById('dashboardContent');
        if (!container) return;

        // 收集统计数据
        const stats = this._collectStats();

        // 渲染 HTML
        container.innerHTML = this._renderStats(stats);
    }

    _collectStats() {
        const stats = {
            currentSnapshot: null,
            totalLayers: 0,
            visibleLayers: 0,
            totalMarkers: 0,
            layers: []
        };

        // 获取当前快照信息
        if (typeof timelineManager !== 'undefined' && timelineManager) {
            const snapshot = timelineManager.getCurrentSnapshot();
            if (snapshot) {
                stats.currentSnapshot = {
                    name: snapshot.name,
                    timestamp: snapshot.timestamp
                };
            }
        }

        // 收集所有标记
        const allMarkers = [];
        const processedMarkers = new Set();

        // 从 drawnItems 收集
        if (typeof drawnItems !== 'undefined') {
            drawnItems.eachLayer(layer => {
                if (layer instanceof L.Marker && !layer._isGroupMarker) {
                    if (!processedMarkers.has(layer)) {
                        processedMarkers.add(layer);
                        allMarkers.push(layer);
                    }
                }
            });
        }

        // 从 MarkerGroupManager 收集
        if (typeof markerGroupManager !== 'undefined' && markerGroupManager) {
            markerGroupManager.groups.forEach(group => {
                group.markers.forEach(marker => {
                    if (!processedMarkers.has(marker)) {
                        processedMarkers.add(marker);
                        allMarkers.push(marker);
                    }
                });
            });
        }

        stats.totalMarkers = allMarkers.length;

        // 按类型和样式分组统计
        const typeStyleMap = new Map();  // key: "类型|颜色|symbol" -> { count, type, color, symbol }

        allMarkers.forEach(marker => {
            const props = marker.feature?.properties || {};

            // 类型字段优先级：类型 → type → category
            const type = props.类型 || props.type || props.category || '未分类';
            const color = props['marker-color'] || '#4a90e2';
            const symbol = props['marker-symbol'] || 'default';

            const key = `${type}|${color}|${symbol}`;

            if (!typeStyleMap.has(key)) {
                typeStyleMap.set(key, {
                    type: type,
                    color: color,
                    symbol: symbol,
                    count: 0
                });
            }
            typeStyleMap.get(key).count++;
        });

        // 转换为数组并按数量排序
        const typeStats = Array.from(typeStyleMap.values())
            .sort((a, b) => b.count - a.count);

        // 主图层统计
        stats.layers.push({
            layerId: 'main',
            layerName: '主图层',
            visible: true,
            markerCount: allMarkers.length,
            typeStats: typeStats
        });

        stats.totalLayers = 1;
        stats.visibleLayers = 1;

        return stats;
    }

    _renderStats(stats) {
        let html = '';

        // 概览区域
        html += `
            <div class="dashboard-overview">
                <div class="overview-item">
                    <span class="overview-icon">📅</span>
                    <span class="overview-label">当前时间点</span>
                    <span class="overview-value">${stats.currentSnapshot ? stats.currentSnapshot.name : '未保存状态'}</span>
                </div>
                <div class="overview-item">
                    <span class="overview-icon">📍</span>
                    <span class="overview-label">总标记数</span>
                    <span class="overview-value">${stats.totalMarkers}</span>
                </div>
            </div>
        `;

        // 图层统计
        stats.layers.forEach(layer => {
            html += `
                <div class="dashboard-layer">
                    <div class="layer-header">
                        <span class="layer-name">${layer.layerName}</span>
                        <span class="layer-status ${layer.visible ? 'visible' : 'hidden'}">
                            ${layer.visible ? '显示中' : '已隐藏'}
                        </span>
                        <span class="layer-count">${layer.markerCount} 个</span>
                    </div>
                    <div class="layer-breakdown">
                        ${this._renderTypeStats(layer.typeStats)}
                    </div>
                </div>
            `;
        });

        if (stats.totalMarkers === 0) {
            html += '<div class="dashboard-empty">暂无标记数据</div>';
        }

        return html;
    }

    _renderTypeStats(typeStats) {
        if (!typeStats || typeStats.length === 0) {
            return '<div class="type-empty">暂无分类数据</div>';
        }

        let html = '';
        typeStats.forEach(stat => {
            const iconClass = this._getIconClass(stat.symbol);

            html += `
                <div class="type-stat-item" data-type="${stat.type}" data-color="${stat.color}">
                    <div class="stat-preview">
                        <span class="color-dot" style="background-color: ${stat.color}"></span>
                        <span class="symbol-icon"><i class="${iconClass}"></i></span>
                    </div>
                    <span class="stat-type">${stat.type}</span>
                    <span class="stat-count">${stat.count}</span>
                </div>
            `;
        });

        return html;
    }

    _getIconClass(symbol) {
        // 从 MARKER_ICONS 获取图标类名
        if (typeof MARKER_ICONS !== 'undefined' && MARKER_ICONS[symbol]) {
            return MARKER_ICONS[symbol].class;
        }
        return 'fa-solid fa-location-dot';
    }
}

// 全局更新函数
function updateDashboard() {
    if (typeof dashboardPanel !== 'undefined' && dashboardPanel) {
        dashboardPanel.update();
    }
}

// 全局暴露
window.DashboardPanel = DashboardPanel;
window.updateDashboard = updateDashboard;

// 初始化
let dashboardPanel = null;

document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        dashboardPanel = new DashboardPanel();
        window.dashboardPanel = dashboardPanel;
        console.log('DashboardPanel initialized');
    }, 700);
});

console.log('Dashboard Panel module loaded');


// ========== script.js ==========
// script.js - GeoJSON Map Editor with FontAwesome marker icons

// ==== Configuration ==== //
const AMAP_API_KEY = 'f9ef1f8a897389df48a43e18ac4660d8';
const AMAP_GEOCODE_URL = 'https://restapi.amap.com/v3/geocode/geo';

// ==== Initialize Map ==== //
const map = L.map('map', {
    zoomControl: false  // 禁用默认位置的缩放控件
}).setView([36.0671, 120.3826], 12); // 青岛市中心

// 添加缩放控件到左下角
L.control.zoom({
    position: 'bottomleft'
}).addTo(map);

// Base layers - expanded map options
const baseLayers = {
    osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19,
    }),
    satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; Esri',
        maxZoom: 19,
    }),
    dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; CartoDB',
        maxZoom: 19,
    }),
    light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; CartoDB',
        maxZoom: 19,
    }),
    terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenTopoMap',
        maxZoom: 17,
    }),
    stamen: L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
        attribution: '&copy; Stamen Design',
        maxZoom: 20,
    }),
    carto: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; CartoDB',
        maxZoom: 19,
    }),
};
baseLayers.osm.addTo(map);


// ==== FontAwesome Icon Marker System ==== //
// Extended marker icons configuration - 30+ icons
const MARKER_ICONS = {
    'default': { class: 'fa-solid fa-location-dot', label: '定位点' },
    'car': { class: 'fa-solid fa-car', label: '汽车' },
    'shop': { class: 'fa-solid fa-bag-shopping', label: '商店' },
    'fuel': { class: 'fa-solid fa-gas-pump', label: '加油站' },
    'warehouse': { class: 'fa-solid fa-warehouse', label: '仓库' },
    'home': { class: 'fa-solid fa-house', label: '房屋' },
    'building': { class: 'fa-solid fa-building', label: '建筑' },
    'hospital': { class: 'fa-solid fa-hospital', label: '医院' },
    'school': { class: 'fa-solid fa-school', label: '学校' },
    'restaurant': { class: 'fa-solid fa-utensils', label: '餐厅' },
    'coffee': { class: 'fa-solid fa-mug-hot', label: '咖啡' },
    'hotel': { class: 'fa-solid fa-hotel', label: '酒店' },
    'parking': { class: 'fa-solid fa-square-parking', label: '停车场' },
    'bank': { class: 'fa-solid fa-landmark', label: '银行' },
    'gym': { class: 'fa-solid fa-dumbbell', label: '健身房' },
    'park': { class: 'fa-solid fa-tree', label: '公园' },
    'beach': { class: 'fa-solid fa-umbrella-beach', label: '海滩' },
    'mountain': { class: 'fa-solid fa-mountain', label: '山峰' },
    'airport': { class: 'fa-solid fa-plane', label: '机场' },
    'train': { class: 'fa-solid fa-train', label: '火车站' },
    'bus': { class: 'fa-solid fa-bus', label: '公交站' },
    'ship': { class: 'fa-solid fa-ship', label: '港口' },
    'factory': { class: 'fa-solid fa-industry', label: '工厂' },
    'office': { class: 'fa-solid fa-briefcase', label: '办公室' },
    'church': { class: 'fa-solid fa-church', label: '教堂' },
    'museum': { class: 'fa-solid fa-landmark-dome', label: '博物馆' },
    'library': { class: 'fa-solid fa-book', label: '图书馆' },
    'pharmacy': { class: 'fa-solid fa-prescription-bottle-medical', label: '药店' },
    'police': { class: 'fa-solid fa-shield-halved', label: '警察局' },
    'fire': { class: 'fa-solid fa-fire-extinguisher', label: '消防站' },
    'star': { class: 'fa-solid fa-star', label: '收藏' },
    'heart': { class: 'fa-solid fa-heart', label: '喜爱' },
    'flag': { class: 'fa-solid fa-flag', label: '旗帜' },
    'pin': { class: 'fa-solid fa-thumbtack', label: '图钉' },
    'warning': { class: 'fa-solid fa-triangle-exclamation', label: '警告' },
    'info': { class: 'fa-solid fa-circle-info', label: '信息' },
};

// Extended marker colors configuration - 12 colors
const MARKER_COLORS = {
    'blue': { hex: '#4a90e2', label: '蓝色' },
    'red': { hex: '#e24a4a', label: '红色' },
    'green': { hex: '#4ae24a', label: '绿色' },
    'orange': { hex: '#e2a04a', label: '橙色' },
    'purple': { hex: '#9b4ae2', label: '紫色' },
    'pink': { hex: '#e24a9b', label: '粉色' },
    'teal': { hex: '#4ae2e2', label: '青色' },
    'yellow': { hex: '#e2e24a', label: '黄色' },
    'gray': { hex: '#6b6b6b', label: '灰色' },
    'brown': { hex: '#8b4513', label: '棕色' },
    'navy': { hex: '#2c3e50', label: '深蓝' },
    'lime': { hex: '#32cd32', label: '酸橙绿' },
};

// Legacy iconClassMap for backward compatibility
const iconClassMap = {};
Object.keys(MARKER_ICONS).forEach(key => {
    iconClassMap[key] = MARKER_ICONS[key].class;
});


// Create custom marker icon with FontAwesome
function createCustomMarkerIcon(color, symbol) {
    // Default to blue if color not provided or invalid
    if (!color || color.indexOf('#') !== 0) {
        color = '#4a90e2'; // default blue
    }

    // Get FontAwesome icon class
    const iconClass = iconClassMap[symbol] || iconClassMap['default'];

    // Create HTML with circular background and FontAwesome icon
    // Create HTML with circular background and FontAwesome icon
    const html = `
        <div class="custom-marker-wrapper">
            <div class="custom-marker-circle" style="background-color: ${color};">
                <i class="${iconClass}"></i>
            </div>
            <div class="custom-marker-tip" style="border-top-color: ${color};"></div>
        </div>
    `;

    return L.divIcon({
        html: html,
        className: 'custom-marker-icon',
        iconSize: [30, 42],
        iconAnchor: [15, 42],
        popupAnchor: [0, -42]
    });
}

// Determine icon based on feature properties
function getMarkerIcon(properties) {
    let color = '#4a90e2'; // default blue
    let symbol = 'default';

    if (properties) {
        // Read marker-color (hex color like #00AA00)
        if (properties['marker-color']) {
            color = properties['marker-color'];
            // If it's a named color, convert to hex
            if (color.indexOf('#') !== 0) {
                const colorMap = {
                    'blue': '#4a90e2',
                    'red': '#e74c3c',
                    'green': '#2ecc71',
                    'orange': '#f39c12',
                    'yellow': '#f1c40f',
                    'violet': '#9b59b6',
                    'purple': '#800080',
                    'grey': '#95a5a6',
                    'black': '#2c3e50'
                };
                color = colorMap[color.toLowerCase()] || '#4a90e2';
            }
        }

        // Read marker-symbol or type
        if (properties['marker-symbol']) {
            symbol = properties['marker-symbol'];
        } else if (properties.type) {
            const type = properties.type.toLowerCase();
            const symbolMap = {
                'shop': 'shop',
                'store': 'shop',
                '商店': 'shop',
                '快准服务站': 'shop',
                'warehouse': 'warehouse',
                'building': 'warehouse',
                '仓库': 'warehouse',
                '新康众服务站': 'warehouse',
                'fuel': 'fuel',
                'gas_station': 'fuel',
                '加油站': 'fuel',
                '汽服门店': 'fuel',
                'car': 'car',
                'vehicle': 'car',
                '汽车': 'car',
                '优配服务站': 'car'
            };

            if (symbolMap[type]) {
                symbol = symbolMap[type];
            } else {
                // Substring match
                for (const key in symbolMap) {
                    if (type.includes(key)) {
                        symbol = symbolMap[key];
                        break;
                    }
                }
            }
        }
    }

    return createCustomMarkerIcon(color, symbol);
}

// ==== Leaflet.draw Setup ==== //
const drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

// ==== Initialize Marker Group Manager ==== //
let markerGroupManager = null;
// 延迟初始化，确保所有依赖加载完成
setTimeout(() => {
    if (typeof MarkerGroupManager !== 'undefined') {
        markerGroupManager = new MarkerGroupManager(map, drawnItems);
        console.log('MarkerGroupManager initialized');
    }
}, 100);

// ==== Initialize Timeline Manager ==== //
let timelineManager = null;
setTimeout(() => {
    if (typeof TimelineManager !== 'undefined') {
        timelineManager = new TimelineManager();
        window.timelineManager = timelineManager; // Explicit global export
        console.log('TimelineManager initialized');
    }
}, 100);

L.drawLocal = {
    draw: {
        toolbar: {
            actions: { title: '取消绘制', text: '取消' },
            finish: { title: '完成绘制', text: '完成' },
            undo: { title: '删除最后一个点', text: '删除最后一个点' },
            buttons: {
                polyline: '绘制折线',
                polygon: '绘制多边形',
                rectangle: '绘制矩形',
                circle: '绘制圆形',
                marker: '添加标记',
                circlemarker: '添加圆形标记'
            }
        },
        handlers: {
            circle: { tooltip: { start: '点击并拖动绘制圆形' }, radius: '半径' },
            circlemarker: { tooltip: { start: '点击地图放置圆形标记' } },
            marker: { tooltip: { start: '点击地图放置标记' } },
            polygon: { tooltip: { start: '点击开始绘制多边形', cont: '点击继续绘制多边形', end: '点击第一个点完成多边形' } },
            polyline: { error: '<strong>错误:</strong> 线段不能交叉!', tooltip: { start: '点击开始绘制折线', cont: '点击继续绘制折线', end: '点击最后一个点完成折线' } },
            rectangle: { tooltip: { start: '点击并拖动绘制矩形' } },
            simpleshape: { tooltip: { end: '释放鼠标完成绘制' } }
        }
    },
    edit: {
        toolbar: {
            actions: { save: { title: '保存更改', text: '保存' }, cancel: { title: '取消编辑，放弃所有更改', text: '取消' }, clearAll: { title: '清除所有图层', text: '全部清除' } },
            buttons: { edit: '编辑图层', editDisabled: '没有可编辑的图层', remove: '删除图层', removeDisabled: '没有可删除的图层' }
        },
        handlers: { edit: { tooltip: { text: '拖动控制点或标记来编辑要素', subtext: '点击取消撤销更改' } }, remove: { tooltip: { text: '点击要删除的要素' } } }
    }
};

const drawControl = new L.Control.Draw({
    position: 'topleft',
    draw: {
        polyline: { shapeOptions: { color: '#00ff00', weight: 3 } },
        polygon: { allowIntersection: false, shapeOptions: { color: '#ff7800', fillOpacity: 0.3 } },
        rectangle: { shapeOptions: { color: '#ff7800', fillOpacity: 0.3 } },
        circle: { shapeOptions: { color: '#ff7800', fillOpacity: 0.2 } },
        marker: true,
        circlemarker: false
    },
    edit: { featureGroup: drawnItems, remove: true }
});
map.addControl(drawControl);

// ==== UI Elements ==== //
const baseMapSelect = document.getElementById('baseMapSelect');
const exportGeoJSONBtn = document.getElementById('exportGeoJSONBtn');
const geojsonFileInput = document.getElementById('geojsonFile');
const toggleEditorBtn = document.getElementById('toggleEditorBtn');
const editorPanel = document.getElementById('editorPanel');
const geojsonEditor = document.getElementById('geojsonEditor');
const applyEditorBtn = document.getElementById('applyEditorBtn');
const layerList = document.getElementById('layerList');
const clearAllBtn = document.getElementById('clearAllBtn');
const showLabelsCheck = document.getElementById('showLabelsCheck');
const markerIconSelect = document.getElementById('markerIconSelect');

// Save slot controls
const saveSlotSelect = document.getElementById('saveSlotSelect');
const saveSlotBtn = document.getElementById('saveSlotBtn');
const loadSlotBtn = document.getElementById('loadSlotBtn');

// Legacy UI elements
const addressFileInput = document.getElementById('addressFile');
const exportBtn = document.getElementById('exportBtn');
const coordFileInput = document.getElementById('coordFile');
const togglePickerBtn = document.getElementById('togglePickerBtn');
const pickedCoordsDiv = document.getElementById('pickedCoords');
const manualNoteInput = document.getElementById('manualNote');
const addManualMarkerBtn = document.getElementById('addManualMarkerBtn');
const searchAddressInput = document.getElementById('searchAddress');
const searchBtn = document.getElementById('searchBtn');
const gotoLatInput = document.getElementById('gotoLat');
const gotoLngInput = document.getElementById('gotoLng');
const gotoCoordBtn = document.getElementById('gotoCoordBtn');
const toggleLayerPanelBtn = document.getElementById('toggleLayerPanelBtn');

// Excel UI elements
const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
const excelFileInput = document.getElementById('excelFile');
const exportExcelBtn = document.getElementById('exportExcelBtn');

// Event Tracker UI elements
const eventTrackerPanel = document.getElementById('eventTrackerPanel');
const closeEventTrackerBtn = document.getElementById('closeEventTrackerBtn');
const eventTrackerFeatureName = document.getElementById('eventTrackerFeatureName');
const newTodoInput = document.getElementById('newTodoInput');
const addTodoBtn = document.getElementById('addTodoBtn');
const todoList = document.getElementById('todoList');
const eventNotes = document.getElementById('eventNotes');
const urlTitle = document.getElementById('urlTitle');
const urlAddress = document.getElementById('urlAddress');
const addUrlBtn = document.getElementById('addUrlBtn');
const urlList = document.getElementById('urlList');
const timelineDate = document.getElementById('timelineDate');
const timelineTitle = document.getElementById('timelineTitle');
const addTimelineBtn = document.getElementById('addTimelineBtn');
const timelineDisplay = document.getElementById('timelineDisplay');
const saveEventDataBtn = document.getElementById('saveEventDataBtn');

// ==== State Variables ==== //
let pickerMode = false;
let manualMarkerMode = false;
let layerCounter = 0;
let showLabels = false;
let currentMarkerColor = 'blue';
let contextMenuTarget = null;
let currentTrackedFeature = null; // Feature currently being tracked in event panel
let currentEditingEventId = null; // Currently editing event ID
let eventIdCounter = Date.now(); // Unique ID counter for events


// ==== Independent Event Storage System ==== //
const EVENTS_STORAGE_KEY = 'map_events_data';

// Generate unique event ID
function generateEventId() {
    return `evt_${eventIdCounter++}_${Math.random().toString(36).substr(2, 9)}`;
}

// Get all events from localStorage
function getAllEvents() {
    try {
        const data = localStorage.getItem(EVENTS_STORAGE_KEY);
        return data ? JSON.parse(data) : {};
    } catch (e) {
        console.error('Failed to load events:', e);
        return {};
    }
}

// Save all events to localStorage
function saveAllEvents(events) {
    try {
        localStorage.setItem(EVENTS_STORAGE_KEY, JSON.stringify(events));
        console.log('Events saved:', Object.keys(events).length);
    } catch (e) {
        console.error('Failed to save events:', e);
    }
}

// Get event data for a specific feature
function getEventData(eventId) {
    const events = getAllEvents();
    return events[eventId] || null;
}

// Set event data for a specific feature
function setEventData(eventId, data) {
    const events = getAllEvents();
    events[eventId] = data;
    saveAllEvents(events);
}

// Delete event data for a specific feature
function deleteEventData(eventId) {
    const events = getAllEvents();
    if (events[eventId]) {
        delete events[eventId];
        saveAllEvents(events);
    }
}

// Initialize event data structure
function initEventData() {
    return {
        todos: [],
        notes: '',
        urls: [],
        timeline: []
    };
}


// ==== Save Slot Management (Legacy - kept for compatibility) ==== //
function updateSlotOptions() {
    if (!saveSlotSelect) return; // Element removed, skip

    const slots = ['slot1', 'slot2', 'slot3', 'slot4', 'slot5'];
    slots.forEach((slotId, index) => {
        const meta = localStorage.getItem(`geojson_${slotId}_meta`);
        const option = saveSlotSelect.options[index];
        if (!option) return;

        if (meta) {
            try {
                const { timestamp } = JSON.parse(meta);
                const date = new Date(timestamp);
                const dateStr = `${date.getMonth() + 1}-${date.getDate()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                option.text = `存档 ${index + 1} (${dateStr})`;
            } catch (e) {
                option.text = `存档 ${index + 1} (已保存)`;
            }
        } else {
            option.text = `存档 ${index + 1} (空)`;
        }
    });
}

// Initialize slot options on page load
updateSlotOptions();


// ==== Helper Functions ==== //
function updateLayerList() {
    layerList.innerHTML = '';
    let index = 0;
    const processedLayers = new Set();

    // 处理单个图层的函数
    const processLayer = (layer) => {
        if (layer._isGroupMarker) return; // 跳过组合标记
        if (processedLayers.has(layer)) return;
        processedLayers.add(layer);

        const item = document.createElement('div');
        item.className = 'layer-item';
        item.dataset.layerId = L.stamp(layer);

        // 检查是否为当前选中
        if (typeof selectionManager !== 'undefined' && selectionManager.isSelected(layer)) {
            item.classList.add('selected');
        }

        // Determine type and icon
        let type, iconClass;
        if (layer instanceof L.Marker) {
            type = '标记';
            const symbol = layer.feature?.properties?.['marker-symbol'] || 'default';
            iconClass = MARKER_ICONS[symbol]?.class || MARKER_ICONS['default'].class;
        } else if (layer instanceof L.Circle) {
            type = '圆形';
            iconClass = 'fa-solid fa-circle';
        } else if (layer instanceof L.Rectangle) {
            type = '矩形';
            iconClass = 'fa-solid fa-square';
        } else if (layer instanceof L.Polygon) {
            type = '多边形';
            iconClass = 'fa-solid fa-draw-polygon';
        } else if (layer instanceof L.Polyline) {
            type = '折线';
            iconClass = 'fa-solid fa-route';
        } else {
            type = '图层';
            iconClass = 'fa-solid fa-layer-group';
        }

        const props = layer.feature?.properties || {};
        const name = props.名称 || props.name || layer.options.name || `${type} ${index + 1}`;
        const color = props['marker-color'] || '#4a90e2';

        // Get event count for markers
        const events = props.events || [];
        const eventBadge = layer instanceof L.Marker && events.length > 0
            ? `<span class="event-badge">${events.length}</span>`
            : '';

        item.innerHTML = `
            <button class="layer-btn-main" onclick="focusOnLayer(${L.stamp(layer)})" title="点击定位到此图层">
                <span class="layer-icon" style="color: ${color}"><i class="${iconClass}"></i></span>
                <span class="layer-name">${name}</span>
                ${eventBadge}
                <span class="layer-type">${type}</span>
            </button>
            <div class="layer-actions">
                <button class="layer-btn" onclick="toggleLayerVisibility(${L.stamp(layer)})" title="隐藏/显示"><i class="fa-solid fa-eye"></i></button>
                <button class="layer-btn" onclick="renameLayer(${L.stamp(layer)})" title="重命名"><i class="fa-solid fa-pen"></i></button>
                <button class="layer-btn delete" onclick="deleteLayer(${L.stamp(layer)})" title="删除"><i class="fa-solid fa-trash"></i></button>
            </div>
        `;
        layerList.appendChild(item);
        index++;
    };

    // 处理 drawnItems 中的图层
    drawnItems.eachLayer(processLayer);

    // 处理分组中的标记（可能不在 drawnItems 中）
    if (typeof markerGroupManager !== 'undefined' && markerGroupManager) {
        markerGroupManager.groups.forEach(group => {
            group.markers.forEach(processLayer);
        });
    }

    updateGeoJSONEditor();

    // 刷新统计信息
    if (typeof updateLayerStats === 'function') {
        updateLayerStats();
    }
}

// Focus map on a specific layer
function focusOnLayer(leafletId) {
    let layer = drawnItems.getLayer(leafletId);

    // 如果在 drawnItems 中找不到，尝试从 MarkerGroupManager 查找
    if (!layer && typeof markerGroupManager !== 'undefined' && markerGroupManager) {
        for (const [marker, group] of markerGroupManager.markerToGroup) {
            if (L.stamp(marker) === leafletId) {
                layer = marker;
                // 如果在收起的组中，先展开
                if (!group.isExpanded && group.getCount() > 1) {
                    markerGroupManager.expandGroup(group);
                }
                break;
            }
        }
    }

    if (!layer) return;

    // 使用 SelectionManager 统一管理选中状态
    if (typeof selectionManager !== 'undefined') {
        selectionManager.select(layer);
    }

    if (layer instanceof L.Marker) {
        map.setView(layer.getLatLng(), Math.max(map.getZoom(), 16));
        highlightMarker(layer);
        layer.openPopup();
        // 打开属性编辑器
        if (typeof openPropertyDrawer === 'function') {
            openPropertyDrawer(layer);
        }
    } else if (layer.getBounds) {
        map.fitBounds(layer.getBounds());
    }
}


function updateGeoJSONEditor() {
    const geo = drawnItems.toGeoJSON();
    geojsonEditor.value = JSON.stringify(geo, null, 2);
}

function exportGeoJSON() {
    // Collect all features including those in groups
    const features = [];
    const processedMarkers = new Set();

    // Helper to process a layer
    const processLayer = (layer) => {
        if (layer._isGroupMarker) return; // Skip group markers
        if (processedMarkers.has(layer)) return;
        processedMarkers.add(layer);

        const geoJSON = layer.toGeoJSON();

        // For markers, ensure we use original coordinates
        if (layer instanceof L.Marker) {
            const props = layer.feature?.properties || {};
            if (props._originalLat !== undefined && props._originalLng !== undefined) {
                geoJSON.geometry.coordinates = [props._originalLng, props._originalLat];
            }
        }

        features.push(geoJSON);
    };

    // Process layers in drawnItems
    drawnItems.eachLayer(processLayer);

    // Process markers in groups (which may not be in drawnItems when collapsed)
    if (markerGroupManager) {
        markerGroupManager.groups.forEach(group => {
            group.markers.forEach(processLayer);
        });
    }

    const geojson = {
        type: 'FeatureCollection',
        features: features
    };

    const data = JSON.stringify(geojson, null, 2);
    const uri = 'data:application/json;charset=utf-8,' + encodeURIComponent(data);
    const a = document.createElement('a');
    a.setAttribute('href', uri);
    a.setAttribute('download', 'map.geojson');
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function importGeoJSON(raw) {
    try {
        const geo = typeof raw === 'string' ? JSON.parse(raw) : raw;
        L.geoJSON(geo, {
            pointToLayer: (feature, latlng) => {
                // Check for multi-marker offset support
                const existingMarkers = findMarkersAtLocation(latlng);
                let finalLatlng = latlng;

                // If feature has offset info, use it
                if (feature.properties._offsetIndex !== undefined) {
                    const origLat = feature.properties._originalLat || latlng.lat;
                    const origLng = feature.properties._originalLng || latlng.lng;
                    const origLatlng = L.latLng(origLat, origLng);
                    finalLatlng = applySmartOffset(origLatlng, feature.properties._offsetIndex);
                } else if (existingMarkers.length > 0) {
                    // New import without offset info, calculate it
                    const offsetIndex = existingMarkers.length;
                    finalLatlng = applySmartOffset(latlng, offsetIndex);

                    // Store offset info
                    if (!feature.properties) feature.properties = {};
                    feature.properties._originalLat = latlng.lat;
                    feature.properties._originalLng = latlng.lng;
                    feature.properties._offsetIndex = offsetIndex;
                } else {
                    // First marker at this location
                    if (!feature.properties) feature.properties = {};
                    feature.properties._originalLat = latlng.lat;
                    feature.properties._originalLng = latlng.lng;
                    feature.properties._offsetIndex = 0;
                }

                const icon = getMarkerIcon(feature.properties);
                const marker = L.marker(finalLatlng, { icon });
                marker.feature = { properties: feature.properties || {} };
                bindMarkerContextMenu(marker);
                return marker;
            },
            style: feature => {
                const style = {};
                if (feature.properties) {
                    if (feature.properties.stroke) style.color = feature.properties.stroke;
                    if (feature.properties['stroke-width']) style.weight = feature.properties['stroke-width'];
                    if (feature.properties['stroke-opacity']) style.opacity = feature.properties['stroke-opacity'];
                    if (feature.properties.fill) style.fillColor = feature.properties.fill;
                    if (feature.properties['fill-opacity']) style.fillOpacity = feature.properties['fill-opacity'];
                    if (feature.properties.dashArray || feature.properties.style === 'dashed') style.dashArray = '10,10';
                }
                return style;
            },
            onEachFeature: (feature, layer) => {
                if (feature.properties && feature.properties.name) {
                    layer.options.name = feature.properties.name;
                }
                if (layer instanceof L.Circle && feature.properties) {
                    if (feature.properties.dashArray || feature.properties.style === 'dashed') {
                        layer.setStyle({ dashArray: '10,10', weight: 2 });
                    }
                }

                if (layer instanceof L.Marker) {
                    // Bind popup and context menu
                    bindMarkerPopup(layer);
                    bindMarkerContextMenu(layer);

                    // Register with MarkerGroupManager for grouping
                    if (markerGroupManager) {
                        markerGroupManager.addMarker(layer);
                    } else {
                        // Fallback if manager not ready
                        drawnItems.addLayer(layer);
                    }
                } else {
                    // Non-marker layers go directly to drawnItems
                    drawnItems.addLayer(layer);
                }
            }
        });
        updateLayerList();
        if (drawnItems.getLayers().length) map.fitBounds(drawnItems.getBounds());
    } catch (e) {
        alert('GeoJSON 解析错误：' + e.message);
    }
}

function updateLabels() {
    drawnItems.eachLayer(layer => {
        if (layer.getTooltip()) layer.unbindTooltip();
        if (showLabels && layer.options.name) {
            layer.bindTooltip(layer.options.name, { permanent: true, direction: 'center', className: 'layer-label' });
        }
    });
}

// ==== Unified Popup Binding ==== //
function bindMarkerPopup(layer) {
    if (!(layer instanceof L.Marker)) return;

    const latlng = layer.getLatLng();
    const props = layer.feature?.properties || {};
    const name = props.名称 || props.name || layer.options.name || '未命名标记';
    const type = props.类型 || props.type || '';
    const address = props.地址 || props.address || '';
    const events = props.events || [];

    // Build event list HTML (show up to 3 recent events)
    let eventListHtml = '';
    if (events.length > 0) {
        const recentEvents = events.slice(-3).reverse();
        eventListHtml = `<div class="popup-events">
            <div class="popup-events-header">📋 最近事件 (${events.length})</div>
            ${recentEvents.map(evt => `
                <div class="popup-event-item">
                    <span class="popup-event-date">${evt.created?.split('T')[0] || '无日期'}</span>
                    <span class="popup-event-name">${evt.eventName || '未命名事件'}</span>
                </div>
            `).join('')}
            ${events.length > 3 ? `<div class="popup-event-more">还有 ${events.length - 3} 个事件...</div>` : ''}
        </div>`;
    }

    const popupHtml = `<div class="marker-popup">
        <h3 style="margin: 0 0 8px 0; color: #4a90e2;">${name}</h3>
        <div style="font-size: 0.9rem; line-height: 1.4; margin-bottom: 10px;">
            ${type ? `<strong>类型:</strong> ${type}<br>` : ''}
            ${address ? `<strong>地址:</strong> ${address}<br>` : ''}
            <strong>经纬度:</strong> ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)} 
            <button onclick="navigator.clipboard.writeText('${latlng.lat},${latlng.lng}'); showBriefMessage('✅ 坐标已复制')" class="btn-copy" style="padding: 2px 6px; font-size: 0.8rem; margin-left: 5px; cursor: pointer;">复制</button>
        </div>
        ${eventListHtml}
    </div>`;

    layer.bindPopup(popupHtml, { maxWidth: 300 });
}

// ==== Context Menu Functions ==== //
function bindMarkerContextMenu(marker) {
    // 右键：显示上下文菜单并设置为选中标记
    marker.on('contextmenu', e => {
        L.DomEvent.stopPropagation(e);
        L.DomEvent.preventDefault(e); // 阻止原生地图右键

        contextMenuTarget = marker;
        selectedMarker = marker;  // 设置为选中标记

        const menu = document.getElementById('contextMenu');
        menu.style.left = e.originalEvent.pageX + 'px';
        menu.style.top = e.originalEvent.pageY + 'px';
        menu.style.display = 'block';
    });

    // 左键：高亮标记并设置为选中，Ctrl+左键打开属性抽屉
    marker.on('click', e => {
        // 检查是否处于多选模式
        if (typeof customGroupManager !== 'undefined' && customGroupManager && customGroupManager.selectionMode) {
            L.DomEvent.stopPropagation(e);
            customGroupManager.toggleMarkerSelection(marker);
            return;
        }

        // 使用 SelectionManager 统一管理选中状态
        if (typeof selectionManager !== 'undefined') {
            selectionManager.select(marker);
        }
        selectedMarker = marker;

        if (e.originalEvent.ctrlKey || e.originalEvent.metaKey) {
            // Ctrl+Click: 打开属性抽屉
            L.DomEvent.stopPropagation(e);
            openPropertyDrawer(marker);
        } else {
            // 普通点击: 高亮标记
            // 不调用 stopPropagation，让 Leaflet 默认的气泡弹窗逻辑生效
            highlightMarker(marker);
        }
    });

    // 双击：打开事件追踪器
    marker.on('dblclick', e => {
        L.DomEvent.stopPropagation(e);
        selectedMarker = marker;
        openEventTracker(marker);
    });
}

// 全局变量：当前选中的标记
let selectedMarker = null;

// Global variable to track highlighted marker
let currentHighlightedMarker = null;

// Highlight marker without opening drawer
function highlightMarker(marker) {
    // Remove previous highlight
    if (currentHighlightedMarker && currentHighlightedMarker !== marker) {
        removeMarkerHighlight(currentHighlightedMarker);
    }

    // Add highlight to current marker
    const icon = marker.getIcon();
    if (icon && icon.options && icon.options.html) {
        // Store original HTML if not already stored
        if (!marker._originalIconHtml) {
            marker._originalIconHtml = icon.options.html;
        }

        // Add highlight class
        const highlightedHtml = icon.options.html.replace(
            'class="marker-pin"',
            'class="marker-pin highlighted"'
        );

        marker.setIcon(L.divIcon({
            ...icon.options,
            html: highlightedHtml
        }));
    }

    currentHighlightedMarker = marker;

    // Auto-remove highlight after 3 seconds
    setTimeout(() => {
        if (currentHighlightedMarker === marker) {
            removeMarkerHighlight(marker);
            currentHighlightedMarker = null;
        }
    }, 3000);
}

function removeMarkerHighlight(marker) {
    if (marker._originalIconHtml) {
        const icon = marker.getIcon();
        marker.setIcon(L.divIcon({
            ...icon.options,
            html: marker._originalIconHtml
        }));
    }
}

function hideContextMenu() {
    const menu = document.getElementById('contextMenu');
    menu.style.display = 'none';
    contextMenuTarget = null;
}

function editMarkerProperties() {
    if (!contextMenuTarget) return;
    const newName = prompt('输入新名称：', contextMenuTarget.options.name || '');
    if (newName !== null) {
        contextMenuTarget.options.name = newName;
        if (!contextMenuTarget.feature) contextMenuTarget.feature = { properties: {} };
        contextMenuTarget.feature.properties.name = newName;
        updateLayerList();
        updateLabels();
    }
    hideContextMenu();
}

// ==== Icon Picker Modal Functions ==== //
let selectedColor = '#4a90e2';
let selectedIcon = 'default';
let iconPickerTarget = null;

function openIconPicker() {
    if (!contextMenuTarget) return;
    iconPickerTarget = contextMenuTarget;
    hideContextMenu();

    // Get current marker settings
    const props = iconPickerTarget.feature?.properties || {};
    selectedColor = props['marker-color'] || '#4a90e2';
    selectedIcon = props['marker-symbol'] || 'default';

    // Render color palette
    const colorPalette = document.getElementById('colorPalette');
    colorPalette.innerHTML = '';
    Object.entries(MARKER_COLORS).forEach(([key, config]) => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch' + (config.hex === selectedColor ? ' selected' : '');
        swatch.style.backgroundColor = config.hex;
        swatch.title = config.label;
        swatch.onclick = () => selectColor(key, config.hex);
        colorPalette.appendChild(swatch);
    });

    // Render icon grid
    const iconGrid = document.getElementById('iconGrid');
    iconGrid.innerHTML = '';
    Object.entries(MARKER_ICONS).forEach(([key, config]) => {
        const option = document.createElement('div');
        option.className = 'icon-option' + (key === selectedIcon ? ' selected' : '');
        option.title = config.label;
        option.innerHTML = `<i class="${config.class}"></i>`;
        option.onclick = () => selectIcon(key);
        iconGrid.appendChild(option);
    });

    // Update preview
    updateIconPreview();

    // Show modal
    document.getElementById('iconPickerModal').style.display = 'flex';
}

function selectColor(key, hex) {
    selectedColor = hex;
    document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    updateIconPreview();
}

function selectIcon(key) {
    selectedIcon = key;
    document.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    updateIconPreview();
}

function updateIconPreview() {
    const previewCircle = document.getElementById('previewCircle');
    const previewTip = document.getElementById('previewTip');
    const previewIcon = document.getElementById('previewIcon');
    const label = document.getElementById('selectedIconLabel');

    previewCircle.style.backgroundColor = selectedColor;
    previewTip.style.borderTopColor = selectedColor;
    previewIcon.className = MARKER_ICONS[selectedIcon]?.class || MARKER_ICONS['default'].class;
    label.textContent = MARKER_ICONS[selectedIcon]?.label || '定位点';
}

function closeIconPicker() {
    document.getElementById('iconPickerModal').style.display = 'none';
    iconPickerTarget = null;
}

function applyIconSelection() {
    if (!iconPickerTarget) return;

    const icon = createCustomMarkerIcon(selectedColor, selectedIcon);
    iconPickerTarget.setIcon(icon);

    if (!iconPickerTarget.feature) iconPickerTarget.feature = { properties: {} };
    iconPickerTarget.feature.properties['marker-color'] = selectedColor;
    iconPickerTarget.feature.properties['marker-symbol'] = selectedIcon;

    updateLayerList();
    closeIconPicker();
}

// Legacy function for backward compatibility
function changeMarkerIcon() {
    openIconPicker();
}


function deleteSelectedMarker() {
    if (!contextMenuTarget) return;
    drawnItems.removeLayer(contextMenuTarget);
    updateLayerList();
    hideContextMenu();
}

function openEventTrackerFromMenu(e) {
    if (e) L.DomEvent.stopPropagation(e);
    if (!contextMenuTarget) return;
    openEventTracker(contextMenuTarget);
    hideContextMenu();
}

// Open event tracker for a specific layer by ID (used in popup)
function openEventTrackerForLayerId(leafletId) {
    const layer = drawnItems.getLayer(leafletId);
    if (!layer) return;
    map.closePopup();
    openEventTracker(layer);
}

map.on('click', () => hideContextMenu());

// ==== Event Listeners ==== //
baseMapSelect.addEventListener('change', () => {
    const sel = baseMapSelect.value;
    Object.values(baseLayers).forEach(l => map.removeLayer(l));
    baseLayers[sel].addTo(map);
});

map.on(L.Draw.Event.CREATED, e => {
    const layer = e.layer;
    layer.options.name = `图层 ${++layerCounter}`;

    if (layer instanceof L.Marker) {
        const latlng = layer.getLatLng();

        // Store original coordinates for grouping
        layer.feature = {
            properties: {
                'marker-color': '#4a90e2',
                '_originalLat': latlng.lat,
                '_originalLng': latlng.lng,
                '_offsetIndex': 0
            }
        };

        const icon = createCustomMarkerIcon('#4a90e2', 'default');
        layer.setIcon(icon);
        bindMarkerPopup(layer);
        bindMarkerContextMenu(layer);

        // Register with MarkerGroupManager for grouping
        if (markerGroupManager) {
            markerGroupManager.addMarker(layer);
        } else {
            drawnItems.addLayer(layer);
        }
    } else {
        drawnItems.addLayer(layer);
    }

    updateLayerList();
    updateLabels();
});

map.on(L.Draw.Event.EDITED, () => updateLayerList());
map.on(L.Draw.Event.DELETED, () => updateLayerList());

exportGeoJSONBtn.addEventListener('click', exportGeoJSON);

// ==== Enhanced GeoJSON Import with Modal ==== //
let pendingImportData = null;

geojsonFileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        try {
            const geojsonStr = ev.target.result;
            const geojson = JSON.parse(geojsonStr);
            pendingImportData = geojsonStr;

            // Calculate geometry statistics
            const stats = { Point: 0, LineString: 0, Polygon: 0, Other: 0 };
            const features = geojson.features || [geojson];
            features.forEach(f => {
                const type = f.geometry?.type;
                if (type === 'Point' || type === 'MultiPoint') stats.Point++;
                else if (type === 'LineString' || type === 'MultiLineString') stats.LineString++;
                else if (type === 'Polygon' || type === 'MultiPolygon') stats.Polygon++;
                else stats.Other++;
            });

            // Render stats
            const statsDiv = document.getElementById('importStats');
            statsDiv.innerHTML = `
                <div class="stat-item">
                    <div class="stat-icon point"><i class="fa-solid fa-location-dot"></i></div>
                    <div class="stat-info"><div class="stat-count">${stats.Point}</div><div class="stat-label">点标记</div></div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon line"><i class="fa-solid fa-route"></i></div>
                    <div class="stat-info"><div class="stat-count">${stats.LineString}</div><div class="stat-label">线段</div></div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon polygon"><i class="fa-solid fa-draw-polygon"></i></div>
                    <div class="stat-info"><div class="stat-count">${stats.Polygon}</div><div class="stat-label">多边形</div></div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon other"><i class="fa-solid fa-shapes"></i></div>
                    <div class="stat-info"><div class="stat-count">${stats.Other}</div><div class="stat-label">其他</div></div>
                </div>
            `;

            // Show import modal
            document.getElementById('importModal').style.display = 'flex';
        } catch (e) {
            alert('GeoJSON 解析错误：' + e.message);
        }
    };
    reader.readAsText(file);
    // Reset file input for re-selection
    e.target.value = '';
});

function closeImportModal() {
    document.getElementById('importModal').style.display = 'none';
    pendingImportData = null;
}

function confirmImport() {
    console.log('confirmImport called');

    // 1. 读取待导入数据
    if (!pendingImportData) {
        console.warn('No pending import data');
        alert('没有待导入的数据，请先选择文件');
        return;
    }

    // 2. 读取导入模式
    const mode = document.querySelector('input[name="importMode"]:checked')?.value || 'replace';
    console.log('Import mode:', mode);

    try {
        // 3. 替换模式：先清空旧状态
        if (mode === 'replace') {
            console.log('Replace mode: clearing old state...');
            resetImportStateSafe();
        }

        // 4. 执行导入
        console.log('Importing GeoJSON...');
        importGeoJSON(pendingImportData);

        // 5. 刷新所有视图
        refreshAllViewsAfterImport();

        // 6. 关闭弹窗
        closeImportModal();

        // 7. 显示成功提示
        if (typeof showBriefMessage === 'function') {
            showBriefMessage(mode === 'replace' ? '✅ 已替换现有图层' : '✅ 已合并图层');
        }

        console.log('Import completed successfully');
    } catch (err) {
        console.error('Import failed:', err);
        alert('导入失败：' + err.message);
    }
}

// 安全版本的状态重置（替换模式专用）
function resetImportStateSafe() {
    console.log('resetImportStateSafe: Starting...');

    try {
        // 1. 清空 MarkerGroupManager
        if (typeof markerGroupManager !== 'undefined' && markerGroupManager) {
            console.log('Clearing MarkerGroupManager...');
            if (typeof markerGroupManager.clear === 'function') {
                markerGroupManager.clear();
            }
            if (markerGroupManager.coordIndex && typeof markerGroupManager.coordIndex.clear === 'function') {
                markerGroupManager.coordIndex.clear();
            }
            if (markerGroupManager.markerToGroup && typeof markerGroupManager.markerToGroup.clear === 'function') {
                markerGroupManager.markerToGroup.clear();
            }
            // 重置 groups Map
            if (markerGroupManager.groups && typeof markerGroupManager.groups.clear === 'function') {
                markerGroupManager.groups.clear();
            }
        }
    } catch (e) {
        console.warn('Error clearing MarkerGroupManager:', e);
    }

    try {
        // 2. 清空 drawnItems
        if (typeof drawnItems !== 'undefined' && drawnItems) {
            console.log('Clearing drawnItems...');
            drawnItems.clearLayers();
        }
    } catch (e) {
        console.warn('Error clearing drawnItems:', e);
    }

    try {
        // 3. 清空自定义组
        if (typeof customGroupManager !== 'undefined' && customGroupManager) {
            console.log('Clearing customGroupManager...');
            if (customGroupManager.groups && typeof customGroupManager.groups.clear === 'function') {
                customGroupManager.groups.clear();
            }
            if (customGroupManager.markerToGroups && typeof customGroupManager.markerToGroups.clear === 'function') {
                customGroupManager.markerToGroups.clear();
            }
            if (typeof customGroupManager._renderGroupList === 'function') {
                customGroupManager._renderGroupList();
            }
        }
    } catch (e) {
        console.warn('Error clearing customGroupManager:', e);
    }

    try {
        // 4. 清空 SelectionManager 状态
        if (typeof selectionManager !== 'undefined' && selectionManager) {
            console.log('Clearing selectionManager...');
            if (typeof selectionManager.clear === 'function') {
                selectionManager.clear();
            } else if (typeof selectionManager.deselect === 'function') {
                selectionManager.deselect();
            }
        }
    } catch (e) {
        console.warn('Error clearing selectionManager:', e);
    }

    try {
        // 5. 清空表格数据
        if (typeof featureTable !== 'undefined' && featureTable) {
            console.log('Clearing featureTable...');
            if (typeof featureTable.clearData === 'function') {
                featureTable.clearData();
            } else if (typeof featureTable.setData === 'function') {
                featureTable.setData([]);
            }
        }
    } catch (e) {
        console.warn('Error clearing featureTable:', e);
    }

    console.log('resetImportStateSafe: Complete');
}

// 保留原函数名兼容
function resetImportState() {
    resetImportStateSafe();
}

// 导入后刷新所有视图
function refreshAllViewsAfterImport() {
    setTimeout(() => {
        try {
            if (typeof updateLayerList === 'function') {
                updateLayerList();
            }
        } catch (e) { console.warn('updateLayerList error:', e); }

        try {
            if (typeof updateFeatureTable === 'function') {
                updateFeatureTable();
            }
        } catch (e) { console.warn('updateFeatureTable error:', e); }

        try {
            if (typeof updateDashboard === 'function') {
                updateDashboard();
            }
        } catch (e) { console.warn('updateDashboard error:', e); }

        try {
            if (typeof updateLayerStats === 'function') {
                updateLayerStats();
            }
        } catch (e) { console.warn('updateLayerStats error:', e); }

        try {
            if (typeof updateLayerDetailsPanel === 'function') {
                updateLayerDetailsPanel();
            }
        } catch (e) { console.warn('updateLayerDetailsPanel error:', e); }
    }, 100);
}

// 全局暴露导入相关函数（确保 onclick 可调用）
window.confirmImport = confirmImport;
window.closeImportModal = closeImportModal;
window.resetImportState = resetImportState;
window.resetImportStateSafe = resetImportStateSafe;
window.refreshAllViewsAfterImport = refreshAllViewsAfterImport;

// ==== Share Feature ==== //
let currentShareCanvas = null;

// Share button event listener
const shareBtn = document.getElementById('shareBtn');
if (shareBtn) {
    shareBtn.addEventListener('click', openShareModal);
}

async function openShareModal() {
    const modal = document.getElementById('shareModal');
    const loading = document.getElementById('sharePreviewLoading');
    const previewImg = document.getElementById('sharePreviewImage');
    const status = document.getElementById('shareStatus');

    // Reset state
    loading.style.display = 'flex';
    previewImg.style.display = 'none';
    status.style.display = 'none';
    currentShareCanvas = null;

    // Show modal
    modal.style.display = 'flex';

    try {
        // Capture map screenshot
        const mapElement = document.getElementById('map');
        currentShareCanvas = await html2canvas(mapElement, {
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#1a1a1a',
            scale: 2 // Higher quality
        });

        // Show preview
        previewImg.src = currentShareCanvas.toDataURL('image/png');
        loading.style.display = 'none';
        previewImg.style.display = 'block';
    } catch (e) {
        console.error('Screenshot failed:', e);
        showShareStatus('截图生成失败: ' + e.message, 'error');
        loading.style.display = 'none';
    }
}

function closeShareModal() {
    document.getElementById('shareModal').style.display = 'none';
    currentShareCanvas = null;
}

function showShareStatus(message, type) {
    const status = document.getElementById('shareStatus');
    status.textContent = message;
    status.className = 'share-status ' + type;
    status.style.display = 'block';

    // Auto hide after 3 seconds
    setTimeout(() => {
        status.style.display = 'none';
    }, 3000);
}

function downloadMapImage() {
    if (!currentShareCanvas) {
        showShareStatus('请先等待截图生成完成', 'error');
        return;
    }

    const link = document.createElement('a');
    link.download = `map_${new Date().toISOString().slice(0, 10)}.png`;
    link.href = currentShareCanvas.toDataURL('image/png');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showShareStatus('✅ 图片已下载', 'success');
}

async function copyMapImage() {
    if (!currentShareCanvas) {
        showShareStatus('请先等待截图生成完成', 'error');
        return;
    }

    try {
        // Convert canvas to blob
        const blob = await new Promise(resolve => currentShareCanvas.toBlob(resolve, 'image/png'));

        // Copy to clipboard
        await navigator.clipboard.write([
            new ClipboardItem({ 'image/png': blob })
        ]);

        showShareStatus('✅ 图片已复制到剪贴板', 'success');
    } catch (e) {
        console.error('Copy failed:', e);
        showShareStatus('复制失败，请尝试下载图片', 'error');
    }
}

function copyShareLink() {
    try {
        // Generate shareable link with GeoJSON data
        const geojsonData = JSON.stringify(drawnItems.toGeoJSON());
        const center = map.getCenter();
        const zoom = map.getZoom();

        // Create URL with encoded data
        const baseUrl = window.location.origin + window.location.pathname;
        const params = new URLSearchParams();
        params.set('lat', center.lat.toFixed(6));
        params.set('lng', center.lng.toFixed(6));
        params.set('zoom', zoom);

        // Compress and encode GeoJSON (for small datasets)
        if (geojsonData.length < 2000) {
            params.set('data', btoa(encodeURIComponent(geojsonData)));
        }

        const shareUrl = baseUrl + '?' + params.toString();

        navigator.clipboard.writeText(shareUrl);
        showShareStatus('✅ 链接已复制到剪贴板', 'success');
    } catch (e) {
        console.error('Copy link failed:', e);
        showShareStatus('复制链接失败', 'error');
    }
}

// Load shared data from URL on page load
function loadFromShareUrl() {
    const params = new URLSearchParams(window.location.search);
    const lat = parseFloat(params.get('lat'));
    const lng = parseFloat(params.get('lng'));
    const zoom = parseInt(params.get('zoom'));
    const data = params.get('data');

    if (!isNaN(lat) && !isNaN(lng) && !isNaN(zoom)) {
        map.setView([lat, lng], zoom);
    }

    if (data) {
        try {
            const geojsonStr = decodeURIComponent(atob(data));
            importGeoJSON(geojsonStr);
        } catch (e) {
            console.error('Failed to load shared data:', e);
        }
    }
}

// Call on page load
setTimeout(loadFromShareUrl, 500);

toggleEditorBtn.addEventListener('click', () => {
    if (editorPanel.style.display === 'none') {
        editorPanel.style.display = 'flex';
        toggleEditorBtn.textContent = '隐藏代码编辑器';
        updateGeoJSONEditor();
    } else {
        editorPanel.style.display = 'none';
        toggleEditorBtn.textContent = '显示代码编辑器';
    }
});

// ==== Toolbar Toggle ==== //
const toggleToolbarBtn = document.getElementById('toggleToolbarBtn');
const controlsPanel = document.getElementById('controls');

if (toggleToolbarBtn && controlsPanel) {
    toggleToolbarBtn.addEventListener('click', () => {
        controlsPanel.classList.toggle('collapsed');

        // 同步 body 状态类（用于全局 CSS 选择器）
        document.body.classList.toggle('ui-collapsed', controlsPanel.classList.contains('collapsed'));

        // Invalidate map size after animation
        setTimeout(() => map.invalidateSize(), 350);
    });
}


applyEditorBtn.addEventListener('click', () => {
    drawnItems.clearLayers();
    importGeoJSON(geojsonEditor.value);
});

clearAllBtn.addEventListener('click', () => {
    // 检查是否有数据可清空
    let hasData = false;
    if (typeof drawnItems !== 'undefined') {
        drawnItems.eachLayer(() => { hasData = true; });
    }
    if (typeof markerGroupManager !== 'undefined' && markerGroupManager && markerGroupManager.groups.size > 0) {
        hasData = true;
    }

    if (!hasData) {
        alert('当前没有可清空的数据');
        return;
    }

    if (confirm('⚠️ 确定要清空所有图层吗？\n\n此操作将删除所有标记，无法撤销！')) {
        // 清空 MarkerGroupManager
        if (typeof markerGroupManager !== 'undefined' && markerGroupManager) {
            markerGroupManager.clear();
        }

        // 清空 drawnItems
        drawnItems.clearLayers();

        // 清空自定义组
        if (typeof customGroupManager !== 'undefined' && customGroupManager) {
            customGroupManager.groups.clear();
            customGroupManager.markerToGroups.clear();
            customGroupManager._renderGroupList();
        }

        // 刷新所有视图
        updateLayerList();

        if (typeof updateFeatureTable === 'function') {
            updateFeatureTable();
        }
        if (typeof updateDashboard === 'function') {
            updateDashboard();
        }
        if (typeof updateLayerStats === 'function') {
            updateLayerStats();
        }

        // 更新图层详情面板
        updateLayerDetailsPanel(null);

        if (typeof showBriefMessage === 'function') {
            showBriefMessage('✅ 已清空所有图层');
        }
    }
});

showLabelsCheck.addEventListener('change', e => {
    showLabels = e.target.checked;
    updateLabels();
});

markerIconSelect.addEventListener('change', e => {
    currentMarkerColor = e.target.value;
});

// Save Slot Event Listeners (Legacy - elements may be removed)
if (saveSlotBtn && saveSlotSelect) {
    saveSlotBtn.addEventListener('click', () => {
        const slot = saveSlotSelect.value;
        const content = geojsonEditor.value;
        const meta = {
            timestamp: Date.now(),
            size: content.length
        };
        localStorage.setItem(`geojson_${slot}`, content);
        localStorage.setItem(`geojson_${slot}_meta`, JSON.stringify(meta));
        updateSlotOptions();
        console.log('已保存到存档');
    });
}

if (loadSlotBtn && saveSlotSelect) {
    loadSlotBtn.addEventListener('click', () => {
        const slot = saveSlotSelect.value;
        const content = localStorage.getItem(`geojson_${slot}`);
        if (content) {
            geojsonEditor.value = content;
        } else {
            console.log('存档为空');
        }
    });
}


// ---- Legacy Features ---- //
exportBtn.addEventListener('click', () => {
    const rows = [];
    drawnItems.eachLayer(l => {
        if (l instanceof L.Marker) {
            const ll = l.getLatLng();
            rows.push(`${ll.lat},${ll.lng} `);
        }
    });
    const csv = 'data:text/csv;charset=utf-8,latitude,longitude\n' + rows.join('\n');
    const a = document.createElement('a');
    a.setAttribute('href', encodeURI(csv));
    a.setAttribute('download', 'coordinates.csv');
    document.body.appendChild(a);
    a.click();
});

// ==== Excel Functions ==== //

// Download Excel Template
downloadTemplateBtn.addEventListener('click', () => {
    const templateData = [
        {
            '经度 (Longitude)': 120.38,
            '纬度 (Latitude)': 36.07,
            '名称 (Name)': '示例标记',
            '类型 (Type)': 'shop',
            '地址 (Address)': '山东省青岛市市南区',
            '标记颜色 (marker-color)': '#4a90e2',
            '标记符号 (marker-symbol)': 'shop'
        }
    ];

    const ws = XLSX.utils.json_to_sheet(templateData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '标记数据');
    XLSX.writeFile(wb, '地图标记导入模板.xlsx');
});

// Export to Excel with all fields
exportExcelBtn.addEventListener('click', () => {
    const data = [];
    drawnItems.eachLayer(l => {
        if (l instanceof L.Marker) {
            const ll = l.getLatLng();
            const props = l.feature?.properties || {};
            data.push({
                '经度 (Longitude)': ll.lng,
                '纬度 (Latitude)': ll.lat,
                '名称 (Name)': props.name || '',
                '类型 (Type)': props.type || '',
                '地址 (Address)': props.address || '',
                '标记颜色 (marker-color)': props['marker-color'] || '#4a90e2',
                '标记符号 (marker-symbol)': props['marker-symbol'] || 'default'
            });
        }
    });

    if (data.length === 0) {
        alert('没有标记可导出');
        return;
    }

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '标记数据');
    XLSX.writeFile(wb, '地图标记数据.xlsx');
});

// Import from Excel
excelFileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
        try {
            const data = new Uint8Array(ev.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(firstSheet);

            let addedCount = 0;
            rows.forEach(row => {
                // Support multiple column name formats
                const lng = row['经度 (Longitude)'] || row['Longitude'] || row['lng'] || row['经度'];
                const lat = row['纬度 (Latitude)'] || row['Latitude'] || row['lat'] || row['纬度'];

                if (!lng || !lat || isNaN(parseFloat(lng)) || isNaN(parseFloat(lat))) {
                    return;
                }

                const properties = {
                    name: row['名称 (Name)'] || row['Name'] || row['name'] || row['名称'] || '未命名',
                    type: row['类型 (Type)'] || row['Type'] || row['type'] || row['类型'] || '',
                    address: row['地址 (Address)'] || row['Address'] || row['address'] || row['地址'] || '',
                    'marker-color': row['标记颜色 (marker-color)'] || row['marker-color'] || row['color'] || '#4a90e2',
                    'marker-symbol': row['标记符号 (marker-symbol)'] || row['marker-symbol'] || row['symbol'] || 'default'
                };

                const icon = getMarkerIcon(properties);
                const marker = L.marker([parseFloat(lat), parseFloat(lng)], { icon });
                marker.feature = { properties };

                bindMarkerPopup(marker);
                bindMarkerContextMenu(marker);
                drawnItems.addLayer(marker);
                addedCount++;
            });

            if (addedCount > 0) {
                updateLayerList();
                map.fitBounds(drawnItems.getBounds());
                alert(`成功导入 ${addedCount} 个标记`);
            } else {
                alert('未找到有效的坐标数据');
            }
        } catch (err) {
            console.error(err);
            alert('Excel 文件解析失败：' + err.message);
        }
    };
    reader.readAsArrayBuffer(file);
});

// Enhanced Coord Import with PapaParse and Type Detection
coordFileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;

    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
            const rows = results.data;
            let addedCount = 0;

            rows.forEach(row => {
                let lat, lng;

                const latKeys = ['纬度', 'Latitude', 'lat', 'latitude', '纬度 (Latitude)'];
                const lngKeys = ['经度', 'Longitude', 'lng', 'longitude', '经度 (Longitude)'];

                for (const key of latKeys) {
                    if (row[key]) { lat = parseFloat(row[key]); break; }
                }
                for (const key of lngKeys) {
                    if (row[key]) { lng = parseFloat(row[key]); break; }
                }

                if (!isNaN(lat) && !isNaN(lng)) {
                    const name = row['门店'] || row['name'] || row['Name'] || row['名称'] || '未命名';
                    const type = row['类型'] || row['type'] || row['Type'] || '';
                    const address = row['地址'] || row['address'] || row['Address'] || '';

                    const properties = {
                        name: name,
                        type: type,
                        address: address
                    };

                    const icon = getMarkerIcon(properties);
                    const marker = L.marker([lat, lng], { icon: icon });

                    marker.feature = { properties: properties };

                    bindMarkerPopup(marker);

                    bindMarkerContextMenu(marker);
                    drawnItems.addLayer(marker);
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                updateLayerList();
                map.fitBounds(drawnItems.getBounds());
                alert(`成功导入 ${addedCount} 个标记`);
            } else {
                alert('未找到有效的坐标数据，请检查 CSV 文件格式');
            }
        },
        error: function (err) {
            alert('CSV 解析失败: ' + err.message);
        }
    });
});

if (addressFileInput) {
    addressFileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async ev => {
            const rows = Papa.parse(ev.target.result, { header: true }).data;
            for (const row of rows) {
                const address = row.address || row.Address || row.地址;
                if (!address) continue;
                try {
                    const resp = await fetch(`${AMAP_GEOCODE_URL}?key=${AMAP_API_KEY}&address=${encodeURIComponent(address)}`);
                    const data = await resp.json();
                    if (data.geocodes && data.geocodes.length) {
                        const [lng, lat] = data.geocodes[0].location.split(',');
                        const icon = createCustomMarkerIcon('#4a90e2', 'default');
                        const marker = L.marker([parseFloat(lat), parseFloat(lng)], { icon });
                        marker.feature = { properties: { name: address } };
                        bindMarkerContextMenu(marker);
                        drawnItems.addLayer(marker);
                    }
                } catch (err) {
                    console.error(err);
                }
            }
            updateLayerList();
            if (drawnItems.getLayers().length) map.fitBounds(drawnItems.getBounds());
        };
        reader.readAsText(file);
    });
}


togglePickerBtn.addEventListener('click', () => {
    pickerMode = !pickerMode;
    togglePickerBtn.textContent = pickerMode ? '关闭坐标拾取' : '启用坐标拾取';
    pickedCoordsDiv.textContent = pickerMode ? '点击地图拾取坐标...' : '';
    map.getContainer().style.cursor = pickerMode ? 'crosshair' : '';
});

addManualMarkerBtn.addEventListener('click', () => {
    manualMarkerMode = !manualMarkerMode;
    addManualMarkerBtn.textContent = manualMarkerMode ? '取消添加' : '点击地图添加';
    map.getContainer().style.cursor = manualMarkerMode ? 'crosshair' : '';
});

// Layer panel toggle
toggleLayerPanelBtn.addEventListener('click', toggleLayerPanel);

function toggleLayerPanel() {
    const panel = document.getElementById('layerPanel');
    const btn = document.getElementById('toggleLayerPanelBtn');

    if (panel) {
        panel.classList.toggle('open');

        if (btn) {
            const isOpen = panel.classList.contains('open');
            btn.innerHTML = isOpen
                ? '<i class="fa-solid fa-layer-group"></i> 隐藏图层面板'
                : '<i class="fa-solid fa-layer-group"></i> 显示图层面板';
        }
    }
}
window.toggleLayerPanel = toggleLayerPanel;

// 图层分组折叠切换
function toggleLayerSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        section.classList.toggle('collapsed');
    }
}
window.toggleLayerSection = toggleLayerSection;

// 图层搜索过滤
function filterLayers(query) {
    const layerList = document.getElementById('layerList');
    const clearBtn = document.querySelector('.btn-clear-search');

    if (!layerList) return;

    const items = layerList.querySelectorAll('.layer-item');
    const lowerQuery = query.toLowerCase().trim();

    // 显示/隐藏清除按钮
    if (clearBtn) {
        clearBtn.style.display = lowerQuery ? 'block' : 'none';
    }

    if (!lowerQuery) {
        // 清空搜索时显示所有
        items.forEach(item => item.style.display = '');
        return;
    }

    items.forEach(item => {
        const name = item.querySelector('.layer-name')?.textContent?.toLowerCase() || '';
        const type = item.querySelector('.layer-type')?.textContent?.toLowerCase() || '';
        const matches = name.includes(lowerQuery) || type.includes(lowerQuery);
        item.style.display = matches ? '' : 'none';
    });
}
window.filterLayers = filterLayers;

// 清除图层搜索
function clearLayerSearch() {
    const input = document.getElementById('layerSearchInput');
    const clearBtn = document.querySelector('.btn-clear-search');

    if (input) {
        input.value = '';
        filterLayers('');
    }
    if (clearBtn) {
        clearBtn.style.display = 'none';
    }
}
window.clearLayerSearch = clearLayerSearch;


searchBtn.addEventListener('click', async () => {
    const addr = searchAddressInput.value.trim();
    if (!addr) { alert('请输入地址'); return; }
    try {
        const resp = await fetch(`${AMAP_GEOCODE_URL}?key=${AMAP_API_KEY}&address=${encodeURIComponent(addr)}`);
        const data = await resp.json();
        if (data.geocodes && data.geocodes.length) {
            const [lng, lat] = data.geocodes[0].location.split(',');
            const latN = parseFloat(lat), lngN = parseFloat(lng);
            map.setView([latN, lngN], 15);
            const icon = createCustomMarkerIcon('#4a90e2', 'default');
            const marker = L.marker([latN, lngN], { icon });
            marker.feature = { properties: { name: addr } };
            bindMarkerContextMenu(marker);
            drawnItems.addLayer(marker);
            updateLayerList();
        } else {
            alert('未找到该地址');
        }
    } catch (e) {
        console.error(e);
        alert('搜索失败');
    }
});

gotoCoordBtn.addEventListener('click', () => {
    const lat = parseFloat(gotoLatInput.value);
    const lng = parseFloat(gotoLngInput.value);
    if (isNaN(lat) || isNaN(lng)) { alert('请输入有效坐标'); return; }
    map.setView([lat, lng], 15);
    const icon = createCustomMarkerIcon('#4a90e2', 'default');
    const marker = L.marker([lat, lng], { icon });
    marker.feature = { properties: { name: `坐标: ${lat.toFixed(6)}, ${lng.toFixed(6)} ` } };
    bindMarkerContextMenu(marker);
    drawnItems.addLayer(marker);
    updateLayerList();
});

map.on('click', e => {
    if (pickerMode) {
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);
        pickedCoordsDiv.textContent = `纬度: ${lat}, 经度: ${lng} `;
        if (navigator.clipboard) navigator.clipboard.writeText(`${lat},${lng} `);
        return;
    }
    if (manualMarkerMode) {
        const note = manualNoteInput.value.trim() || '无备注';
        const icon = createCustomMarkerIcon('#4a90e2', 'default');
        const marker = L.marker(e.latlng, { icon });
        marker.feature = { properties: { name: note } };
        bindMarkerContextMenu(marker);
        drawnItems.addLayer(marker);
        manualNoteInput.value = '';
        manualMarkerMode = false;
        addManualMarkerBtn.textContent = '点击地图添加';
        map.getContainer().style.cursor = '';
        updateLayerList();
        return;
    }
});

// ==== Global Functions for Layer Management ==== //
window.toggleLayerVisibility = function (id) {
    drawnItems.eachLayer(l => {
        if (l._leaflet_id === id) {
            if (map.hasLayer(l)) map.removeLayer(l); else map.addLayer(l);
        }
    });
};
window.renameLayer = function (id) {
    drawnItems.eachLayer(l => {
        if (l._leaflet_id === id) {
            const newName = prompt('输入新名称：', l.options.name || '');
            if (newName !== null) {
                l.options.name = newName;
                if (!l.feature) l.feature = { properties: {} };
                l.feature.properties.name = newName;
                updateLayerList();
                updateLabels();
            }
        }
    });
};
window.deleteLayer = function (id) {
    drawnItems.eachLayer(l => {
        if (l._leaflet_id === id) {
            drawnItems.removeLayer(l);
            updateLayerList();
        }
    });
};

// ==== Expose Context Menu Functions ==== //
window.editMarkerProperties = editMarkerProperties;
window.changeMarkerIcon = changeMarkerIcon;
window.deleteSelectedMarker = deleteSelectedMarker;
window.openEventTrackerFromMenu = openEventTrackerFromMenu;

// ==== Global Event Tracker Functions (for onclick) ==== //
window.closeEventTracker = function () {
    console.log('closeEventTracker called');
    if (currentTrackedFeature && currentTrackedFeature._eventId) {
        const eventData = currentTrackedFeature._currentEventData || initEventData();
        eventData.notes = eventNotes.value;
        setEventData(currentTrackedFeature._eventId, eventData);
        console.log('Event data auto-saved on close');
    }
    eventTrackerPanel.style.display = 'none';
    currentTrackedFeature = null;
    alert('面板已关闭');
};

window.saveEventData = function () {
    console.log('saveEventData called');
    if (!currentTrackedFeature) {
        alert('没有选中的图层');
        return;
    }
    const eventData = currentTrackedFeature._currentEventData || initEventData();
    eventData.notes = eventNotes.value;
    setEventData(currentTrackedFeature._eventId, eventData);
    alert('✅ 事件数据已保存！');
};


// ==== Event Tracker System (Multi-Event Support) ==== //

// Get all events for a marker (from feature properties)
function getMarkerEvents(feature) {
    if (!feature) return [];
    // Ensure feature structure exists
    if (!feature.feature) {
        feature.feature = { type: 'Feature', properties: {}, geometry: null };
    }
    if (!feature.feature.properties) {
        feature.feature.properties = {};
    }
    return feature.feature.properties.events || [];
}

// Save all events for a marker (to feature properties)
function saveMarkerEvents(feature, events) {
    if (!feature) return;
    // Ensure feature structure exists
    if (!feature.feature) {
        feature.feature = { type: 'Feature', properties: {}, geometry: null };
    }
    if (!feature.feature.properties) {
        feature.feature.properties = {};
    }
    feature.feature.properties.events = events;

    // Update GeoJSON editor to reflect changes
    updateGeoJSONEditor();
    console.log('Events saved to feature:', events.length);
}

// Open event tracker for a feature - shows event list
function openEventTracker(feature) {
    currentTrackedFeature = feature;
    currentEditingEventId = null;

    // Load data into UI
    const props = feature.feature?.properties || {};
    const featureName = props.名称 || props.name || feature.options?.name || '未命名特征';
    eventTrackerFeatureName.textContent = `📍 ${featureName}`;

    // Show list view, hide edit view
    showEventList();

    // Show panel
    eventTrackerPanel.style.display = 'flex';
    console.log('Event tracker opened');
}


// Show event list view
function showEventList() {
    document.getElementById('eventListView').style.display = 'flex';
    document.getElementById('eventEditView').style.display = 'none';

    renderEventList();
}

// Render the event list
function renderEventList() {
    const container = document.getElementById('eventListContainer');
    if (!currentTrackedFeature) return;

    const events = getMarkerEvents(currentTrackedFeature);

    if (events.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <p>📋 暂无事件</p>
                <p>点击下方按钮添加第一个事件</p>
            </div>
        `;
        return;
    }

    // Sort by date (newest first)
    const sortedEvents = [...events].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

    container.innerHTML = sortedEvents.map(event => `
        <div class="event-card" onclick="editEvent('${event.id}')">
            <div class="event-card-info">
                <div class="event-card-date">${formatEventDate(event.createdAt)}</div>
                <div class="event-card-name">${event.name || '未命名事件'}</div>
            </div>
            <div class="event-card-actions">
                <button class="btn-edit" onclick="event.stopPropagation(); editEvent('${event.id}')">编辑</button>
                <button class="btn-delete" onclick="event.stopPropagation(); deleteEvent('${event.id}')">删除</button>
            </div>
        </div>
    `).join('');
}

// Format event date for display
function formatEventDate(dateString) {
    if (!dateString) return '未知日期';
    const d = new Date(dateString);
    return d.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    }).replace(/\//g, '-');
}

// Create new event
function createNewEvent() {
    if (!currentTrackedFeature) return;

    const newEvent = {
        id: generateEventId(),
        name: '',
        createdAt: new Date().toISOString(),
        todos: [],
        notes: '',
        urls: [],
        timeline: []
    };

    // Add to events list
    const events = getMarkerEvents(currentTrackedFeature);
    events.push(newEvent);
    saveMarkerEvents(currentTrackedFeature, events);

    // Open edit view
    editEvent(newEvent.id);

}

// Edit an event
function editEvent(eventId) {
    if (!currentTrackedFeature) return;

    currentEditingEventId = eventId;
    const events = getMarkerEvents(currentTrackedFeature);
    const event = events.find(e => e.id === eventId);

    if (!event) {
        alert('事件未找到');
        return;
    }

    // Store current event data
    currentTrackedFeature._currentEventData = event;

    // Switch to edit view
    document.getElementById('eventListView').style.display = 'none';
    document.getElementById('eventEditView').style.display = 'flex';

    // Load event data into form
    document.getElementById('currentEventName').value = event.name || '';
    eventNotes.value = event.notes || '';
    renderTodoList(event.todos || []);
    renderUrlList(event.urls || []);
    renderTimeline(event.timeline || []);
    renderAttachmentList(event.attachments || []);
}


// Delete an event
function deleteEvent(eventId) {
    if (!currentTrackedFeature) return;

    if (!confirm('确定删除此事件？')) return;

    const events = getMarkerEvents(currentTrackedFeature);
    const index = events.findIndex(e => e.id === eventId);

    if (index !== -1) {
        events.splice(index, 1);
        saveMarkerEvents(currentTrackedFeature, events);
        renderEventList();
    }

}

// Save current event
function saveCurrentEvent() {
    if (!currentTrackedFeature || !currentEditingEventId) {
        console.log('没有正在编辑的事件');
        return;
    }

    const events = getMarkerEvents(currentTrackedFeature);
    const eventIndex = events.findIndex(e => e.id === currentEditingEventId);

    if (eventIndex === -1) {
        console.log('事件未找到');
        return;
    }

    // Update event data
    events[eventIndex].name = document.getElementById('currentEventName').value || '未命名事件';
    events[eventIndex].notes = eventNotes.value;
    events[eventIndex].todos = currentTrackedFeature._currentEventData?.todos || [];
    events[eventIndex].urls = currentTrackedFeature._currentEventData?.urls || [];
    events[eventIndex].timeline = currentTrackedFeature._currentEventData?.timeline || [];
    events[eventIndex].attachments = currentTrackedFeature._currentEventData?.attachments || [];

    saveMarkerEvents(currentTrackedFeature, events);


    // Visual feedback without blocking alert

    const btn = document.getElementById('saveEventDataBtn');
    if (btn) {
        const originalText = btn.textContent;
        btn.textContent = '✅ 已保存';
        btn.style.background = '#2ecc71';
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '';
        }, 1500);
    }
    console.log('事件已保存');
}


// Make functions globally accessible
window.createNewEvent = createNewEvent;
window.editEvent = editEvent;
window.deleteEvent = deleteEvent;
window.showEventList = showEventList;
window.saveCurrentEvent = saveCurrentEvent;

// Wrapper functions for onclick buttons
window.addTodoItemClick = function () { addTodoItem(); };
window.addUrlItemClick = function () { addUrlItem(); };
window.addTimelineEventClick = function () { addTimelineEvent(); };

// ==== Event Archive System ==== //

// Save events to a slot (includes marker info)
function saveEventSlot() {
    const slotSelect = document.getElementById('eventSlotSelect');
    if (!slotSelect) return;

    const slotKey = slotSelect.value;
    const eventArchive = [];

    // Iterate through all markers and collect events
    drawnItems.eachLayer(layer => {
        const events = getMarkerEvents(layer);
        if (events && events.length > 0) {
            // Get layer position
            let coords = null;
            if (layer.getLatLng) {
                const ll = layer.getLatLng();
                coords = { lat: ll.lat, lng: ll.lng };
            } else if (layer.getBounds) {
                const center = layer.getBounds().getCenter();
                coords = { lat: center.lat, lng: center.lng };
            }

            // Get layer name
            const name = layer.options?.name || layer.feature?.properties?.name || '未命名';

            eventArchive.push({
                name: name,
                coords: coords,
                events: events
            });
        }
    });

    if (eventArchive.length === 0) {
        console.log('没有事件需要保存');
        return;
    }

    localStorage.setItem(slotKey, JSON.stringify(eventArchive));

    // Visual feedback
    const btn = document.getElementById('saveEventSlotBtn');
    if (btn) {
        const originalText = btn.textContent;
        btn.textContent = '✅ 已保存';
        setTimeout(() => { btn.textContent = originalText; }, 1500);
    }
    console.log(`事件存档已保存到 ${slotKey}:`, eventArchive.length, '个标记');
}

// Load events from a slot
function loadEventSlot() {
    const slotSelect = document.getElementById('eventSlotSelect');
    if (!slotSelect) return;

    const slotKey = slotSelect.value;
    const data = localStorage.getItem(slotKey);

    if (!data) {
        console.log('该存档槽为空');
        return;
    }

    const eventArchive = JSON.parse(data);
    let matchCount = 0;

    eventArchive.forEach(archive => {
        // Try to find matching layer by name + coords
        let matchedLayer = null;

        drawnItems.eachLayer(layer => {
            if (matchedLayer) return;

            const layerName = layer.options?.name || layer.feature?.properties?.name || '未命名';

            // Match by name first
            if (layerName === archive.name) {
                // Verify by coordinates proximity
                let layerCoords = null;
                if (layer.getLatLng) {
                    const ll = layer.getLatLng();
                    layerCoords = { lat: ll.lat, lng: ll.lng };
                } else if (layer.getBounds) {
                    const center = layer.getBounds().getCenter();
                    layerCoords = { lat: center.lat, lng: center.lng };
                }

                if (layerCoords && archive.coords) {
                    const dist = Math.sqrt(
                        Math.pow(layerCoords.lat - archive.coords.lat, 2) +
                        Math.pow(layerCoords.lng - archive.coords.lng, 2)
                    );
                    if (dist < 0.001) { // ~100m tolerance
                        matchedLayer = layer;
                    }
                }
            }
        });

        if (matchedLayer) {
            // Restore events to matched layer
            saveMarkerEvents(matchedLayer, archive.events);
            matchCount++;
        }
    });

    // Visual feedback
    const btn = document.getElementById('loadEventSlotBtn');
    if (btn) {
        const originalText = btn.textContent;
        btn.textContent = `✅ 已加载 ${mathCount}`;
        setTimeout(() => { btn.textContent = originalText; }, 1500);
    }
    console.log(`从 ${slotKey} 加载事件:`, matchCount, '/', eventArchive.length, '匹配');
}

window.saveEventSlot = saveEventSlot;
window.loadEventSlot = loadEventSlot;

// ==== Complete Archive System (Simplified) ==== //

// Save complete archive (layers + events as GeoJSON)
function saveCompleteSlot() {
    const slotSelect = document.getElementById('completeSlotSelect');
    if (!slotSelect) return;

    const slotKey = slotSelect.value;

    // Export current layers as GeoJSON with events in properties
    const geojson = {
        type: 'FeatureCollection',
        features: []
    };

    drawnItems.eachLayer(layer => {
        if (layer.toGeoJSON) {
            const feature = layer.toGeoJSON();
            // Events are already in feature.properties.events (from saveMarkerEvents)
            geojson.features.push(feature);
        }
    });

    localStorage.setItem(slotKey, JSON.stringify(geojson));

    // Visual feedback
    const btn = document.getElementById('saveCompleteBtn');
    if (btn) {
        const originalText = btn.textContent;
        btn.textContent = '✅ 已保存';
        setTimeout(() => { btn.textContent = originalText; }, 1500);
    }
    console.log(`完整存档已保存到 ${slotKey}:`, geojson.features.length, '个图层');
}

// Load complete archive
function loadCompleteSlot() {
    const slotSelect = document.getElementById('completeSlotSelect');
    if (!slotSelect) return;

    const slotKey = slotSelect.value;
    const data = localStorage.getItem(slotKey);

    if (!data) {
        console.log('该存档槽为空');
        return;
    }

    // Clear current layers
    drawnItems.clearLayers();

    // Import GeoJSON (events are in properties.events)
    importGeoJSON(data);

    // Visual feedback
    const btn = document.getElementById('loadCompleteBtn');
    if (btn) {
        const originalText = btn.textContent;
        btn.textContent = '✅ 已读取';
        setTimeout(() => { btn.textContent = originalText; }, 1500);
    }
    console.log(`从 ${slotKey} 读取完整存档`);
}

window.saveCompleteSlot = saveCompleteSlot;
window.loadCompleteSlot = loadCompleteSlot;

// ==== Unlimited Named Archive System ==== //
const ARCHIVE_LIST_KEY = 'archive_list';
let currentArchiveId = null;

// Get archive list
function getArchiveList() {
    const data = localStorage.getItem(ARCHIVE_LIST_KEY);
    return data ? JSON.parse(data) : [];
}

// Save archive list
function saveArchiveList(list) {
    localStorage.setItem(ARCHIVE_LIST_KEY, JSON.stringify(list));
}

// Render archive list UI
function renderArchiveList() {
    const container = document.getElementById('archiveList');
    if (!container) return;

    const archives = getArchiveList();

    if (archives.length === 0) {
        container.innerHTML = '<p style="color:#666;font-size:0.8rem;text-align:center;">暂无存档</p>';
        return;
    }

    container.innerHTML = archives.map(arc => `
        <div class="archive-item">
            <span class="archive-item-name">📁 ${arc.name}</span>
            <span class="archive-item-date">${arc.created}</span>
            <div class="archive-item-actions">
                <button class="load-btn" onclick="loadArchive('${arc.id}')">读取</button>
                <button class="delete-btn" onclick="deleteArchive('${arc.id}')">删除</button>
            </div>
        </div>
    `).join('');
}

// Create new archive
function createArchive() {
    const nameInput = document.getElementById('newArchiveName');
    const name = nameInput?.value.trim();

    if (!name) {
        nameInput?.focus();
        return;
    }

    const id = 'arc_' + Date.now();
    const created = new Date().toLocaleDateString('zh-CN');

    // Save archive data
    const geojson = {
        type: 'FeatureCollection',
        features: []
    };
    drawnItems.eachLayer(layer => {
        if (layer.toGeoJSON) {
            geojson.features.push(layer.toGeoJSON());
        }
    });
    localStorage.setItem(id, JSON.stringify(geojson));

    // Update archive list
    const list = getArchiveList();
    list.unshift({ id, name, created });
    saveArchiveList(list);

    // Clear input and refresh
    nameInput.value = '';
    renderArchiveList();

    // Set as current
    currentArchiveId = id;
    updateCurrentArchiveInfo(name);

    console.log('创建存档:', name);
}

// Load archive
function loadArchive(id) {
    const data = localStorage.getItem(id);
    if (!data) {
        console.log('存档不存在');
        return;
    }

    drawnItems.clearLayers();
    importGeoJSON(data);

    // Update current archive
    const list = getArchiveList();
    const arc = list.find(a => a.id === id);
    currentArchiveId = id;
    updateCurrentArchiveInfo(arc?.name || '未知');

    console.log('加载存档:', arc?.name);
}

// Delete archive
function deleteArchive(id) {
    if (!confirm('确定删除此存档？')) return;

    localStorage.removeItem(id);

    const list = getArchiveList().filter(a => a.id !== id);
    saveArchiveList(list);

    if (currentArchiveId === id) {
        currentArchiveId = null;
        document.getElementById('currentArchiveInfo').style.display = 'none';
    }

    renderArchiveList();
}

// Save to current archive
function saveCurrentArchive() {
    if (!currentArchiveId) return;

    const geojson = {
        type: 'FeatureCollection',
        features: []
    };
    drawnItems.eachLayer(layer => {
        if (layer.toGeoJSON) {
            geojson.features.push(layer.toGeoJSON());
        }
    });
    localStorage.setItem(currentArchiveId, JSON.stringify(geojson));

    // Visual feedback
    const btn = document.querySelector('#currentArchiveInfo button');
    if (btn) {
        const originalText = btn.textContent;
        btn.textContent = '✅ 已保存';
        setTimeout(() => { btn.textContent = originalText; }, 1500);
    }
}

// Update current archive info display
function updateCurrentArchiveInfo(name) {
    const info = document.getElementById('currentArchiveInfo');
    const nameEl = document.getElementById('currentArchiveName');
    if (info && nameEl) {
        nameEl.textContent = name;
        info.style.display = 'flex';
    }
}

// Initialize archive list on page load
setTimeout(renderArchiveList, 100);

window.createArchive = createArchive;
window.loadArchive = loadArchive;
window.deleteArchive = deleteArchive;
window.saveCurrentArchive = saveCurrentArchive;

// ==== Attachment System ==== //
const MAX_ATTACHMENT_SIZE = 500 * 1024; // 500KB

// Upload attachment
function uploadAttachment() {
    const input = document.getElementById('attachmentInput');
    if (!input?.files?.length) return;

    const file = input.files[0];

    if (file.size > MAX_ATTACHMENT_SIZE) {
        console.log('文件太大，最大支持500KB');
        input.value = '';
        return;
    }

    if (!currentTrackedFeature || !currentEditingEventId) {
        console.log('请先选择一个事件');
        input.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
        const attachment = {
            id: 'att_' + Date.now(),
            name: file.name,
            type: file.type,
            size: file.size,
            data: e.target.result
        };

        const eventData = currentTrackedFeature._currentEventData;
        if (!eventData.attachments) eventData.attachments = [];
        eventData.attachments.push(attachment);

        renderAttachmentList(eventData.attachments);
        input.value = '';

        console.log('附件已上传:', file.name);
    };
    reader.readAsDataURL(file);
}

// Render attachment list
function renderAttachmentList(attachments) {
    const container = document.getElementById('attachmentList');
    if (!container) return;

    if (!attachments || attachments.length === 0) {
        container.innerHTML = '';
        return;
    }

    container.innerHTML = attachments.map((att, index) => {
        const icon = getAttachmentIcon(att.type);
        const size = formatFileSize(att.size);
        return `
            <div class="attachment-item">
                <div class="attachment-item-info">
                    <span class="attachment-item-icon">${icon}</span>
                    <span class="attachment-item-name">${att.name}</span>
                    <span class="attachment-item-size">(${size})</span>
                </div>
                <div class="attachment-item-actions">
                    <button onclick="downloadAttachment(${index})">下载</button>
                    <button class="delete-btn" onclick="deleteAttachment(${index})">删除</button>
                </div>
            </div>
        `;
    }).join('');
}

// Get icon for attachment type
function getAttachmentIcon(type) {
    if (type.startsWith('image/')) return '🖼️';
    if (type === 'application/pdf') return '📄';
    if (type.includes('word')) return '📝';
    if (type.includes('excel') || type.includes('spreadsheet')) return '📊';
    return '📎';
}

// Format file size
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + 'B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
    return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
}

// Download attachment
function downloadAttachment(index) {
    const eventData = currentTrackedFeature?._currentEventData;
    if (!eventData?.attachments?.[index]) return;

    const att = eventData.attachments[index];
    const link = document.createElement('a');
    link.href = att.data;
    link.download = att.name;
    link.click();
}

// Delete attachment
function deleteAttachment(index) {
    const eventData = currentTrackedFeature?._currentEventData;
    if (!eventData?.attachments) return;

    eventData.attachments.splice(index, 1);
    renderAttachmentList(eventData.attachments);
}

window.uploadAttachment = uploadAttachment;
window.downloadAttachment = downloadAttachment;
window.deleteAttachment = deleteAttachment;

// ==== Code Editor Archive System ==== //
const CODE_ARCHIVE_LIST_KEY = 'code_archive_list';
let currentCodeArchiveId = null;

function getCodeArchiveList() {
    const data = localStorage.getItem(CODE_ARCHIVE_LIST_KEY);
    return data ? JSON.parse(data) : [];
}

function saveCodeArchiveList(list) {
    localStorage.setItem(CODE_ARCHIVE_LIST_KEY, JSON.stringify(list));
}

function renderCodeArchiveList() {
    const container = document.getElementById('codeArchiveList');
    if (!container) return;

    const archives = getCodeArchiveList();

    if (archives.length === 0) {
        container.innerHTML = '<p style="color:#666;font-size:0.8rem;text-align:center;">暂无代码存档</p>';
        return;
    }

    container.innerHTML = archives.map(arc => `
        <div class="archive-item">
            <span class="archive-item-name">📝 ${arc.name}</span>
            <span class="archive-item-date">${arc.created}</span>
            <div class="archive-item-actions">
                <button class="load-btn" onclick="loadCodeArchive('${arc.id}')">读取</button>
                <button class="delete-btn" onclick="deleteCodeArchive('${arc.id}')">删除</button>
            </div>
        </div>
    `).join('');
}

function createCodeArchive() {
    const nameInput = document.getElementById('newCodeArchiveName');
    const name = nameInput?.value.trim();

    if (!name) {
        nameInput?.focus();
        return;
    }

    const id = 'code_arc_' + Date.now();
    const created = new Date().toLocaleDateString('zh-CN');

    // Save current editor content
    const content = geojsonEditor?.value || '';
    localStorage.setItem(id, content);

    const list = getCodeArchiveList();
    list.unshift({ id, name, created });
    saveCodeArchiveList(list);

    nameInput.value = '';
    renderCodeArchiveList();

    currentCodeArchiveId = id;
    updateCurrentCodeArchiveInfo(name);

    console.log('创建代码存档:', name);
}

function loadCodeArchive(id) {
    const data = localStorage.getItem(id);
    if (data === null) {
        console.log('代码存档不存在');
        return;
    }

    if (geojsonEditor) {
        geojsonEditor.value = data;
    }

    const list = getCodeArchiveList();
    const arc = list.find(a => a.id === id);
    currentCodeArchiveId = id;
    updateCurrentCodeArchiveInfo(arc?.name || '未知');

    console.log('加载代码存档:', arc?.name);
}

function deleteCodeArchive(id) {
    if (!confirm('确定删除此代码存档？')) return;

    localStorage.removeItem(id);

    const list = getCodeArchiveList().filter(a => a.id !== id);
    saveCodeArchiveList(list);

    if (currentCodeArchiveId === id) {
        currentCodeArchiveId = null;
        const info = document.getElementById('currentCodeArchiveInfo');
        if (info) info.style.display = 'none';
    }

    renderCodeArchiveList();
}

function saveCurrentCodeArchive() {
    if (!currentCodeArchiveId) return;

    const content = geojsonEditor?.value || '';
    localStorage.setItem(currentCodeArchiveId, content);

    const btn = document.querySelector('#currentCodeArchiveInfo button');
    if (btn) {
        const originalText = btn.textContent;
        btn.textContent = '✅ 已保存';
        setTimeout(() => { btn.textContent = originalText; }, 1500);
    }
}

function updateCurrentCodeArchiveInfo(name) {
    const info = document.getElementById('currentCodeArchiveInfo');
    const nameEl = document.getElementById('currentCodeArchiveName');
    if (info && nameEl) {
        nameEl.textContent = name;
        info.style.display = 'flex';
    }
}

setTimeout(renderCodeArchiveList, 100);

window.createCodeArchive = createCodeArchive;
window.loadCodeArchive = loadCodeArchive;
window.deleteCodeArchive = deleteCodeArchive;
window.saveCurrentCodeArchive = saveCurrentCodeArchive;


// Close event tracker
if (closeEventTrackerBtn) {
    closeEventTrackerBtn.addEventListener('click', () => {
        // Auto-save before closing
        if (currentTrackedFeature && currentTrackedFeature._eventId) {
            const eventData = currentTrackedFeature._currentEventData || initEventData();
            eventData.notes = eventNotes.value;
            setEventData(currentTrackedFeature._eventId, eventData);
            console.log('Event data auto-saved on close');
        }
        eventTrackerPanel.style.display = 'none';
        currentTrackedFeature = null;
    });
} else {
    console.error('closeEventTrackerBtn not found!');
}

// Todo List Functions
function renderTodoList(todos) {
    todoList.innerHTML = '';
    todos.forEach((todo, index) => {
        const todoItem = document.createElement('div');
        todoItem.className = 'todo-item';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = todo.completed;
        checkbox.addEventListener('change', () => toggleTodoItem(index));

        const text = document.createElement('span');
        text.className = `todo-item-text${todo.completed ? ' completed' : ''}`;
        text.textContent = todo.text;

        const time = document.createElement('span');
        time.className = 'todo-item-time';
        const date = new Date(todo.created);
        time.textContent = `${date.getMonth() + 1}/${date.getDate()}`;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'todo-item-delete';
        deleteBtn.textContent = '删除';
        deleteBtn.addEventListener('click', () => deleteTodoItem(index));

        todoItem.appendChild(checkbox);
        todoItem.appendChild(text);
        todoItem.appendChild(time);
        todoItem.appendChild(deleteBtn);
        todoList.appendChild(todoItem);
    });
}

function addTodoItem() {
    if (!currentTrackedFeature) return;
    const text = newTodoInput.value.trim();
    if (!text) return;

    const eventData = currentTrackedFeature._currentEventData;
    if (!eventData.todos) eventData.todos = [];

    eventData.todos.push({
        id: Date.now(),
        text: text,
        completed: false,
        created: Date.now()
    });

    // Save to localStorage immediately
    setEventData(currentTrackedFeature._eventId, eventData);
    renderTodoList(eventData.todos);
    newTodoInput.value = '';
}

function toggleTodoItem(index) {
    if (!currentTrackedFeature) return;
    const eventData = currentTrackedFeature._currentEventData;
    eventData.todos[index].completed = !eventData.todos[index].completed;
    setEventData(currentTrackedFeature._eventId, eventData);
    renderTodoList(eventData.todos);
}

function deleteTodoItem(index) {
    if (!currentTrackedFeature) return;
    const eventData = currentTrackedFeature._currentEventData;
    eventData.todos.splice(index, 1);
    setEventData(currentTrackedFeature._eventId, eventData);
    renderTodoList(eventData.todos);
}



if (addTodoBtn) {
    addTodoBtn.addEventListener('click', addTodoItem);
} else {
    console.error('addTodoBtn not found!');
}

if (newTodoInput) {
    newTodoInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addTodoItem();
    });
}


// URL Functions
function renderUrlList(urls) {
    urlList.innerHTML = '';
    urls.forEach((urlItem, index) => {
        const item = document.createElement('div');
        item.className = 'url-item';

        const link = document.createElement('a');
        link.href = urlItem.url;
        link.target = '_blank';
        link.textContent = urlItem.title || urlItem.url;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'url-item-delete';
        deleteBtn.textContent = '删除';
        deleteBtn.addEventListener('click'

            , () => deleteUrlItem(index));

        item.appendChild(link);
        item.appendChild(deleteBtn);
        urlList.appendChild(item);
    });
}

function addUrlItem() {
    if (!currentTrackedFeature) return;
    const title = urlTitle.value.trim();
    const url = urlAddress.value.trim();

    if (!url) {
        return;
    }


    const eventData = currentTrackedFeature._currentEventData;
    if (!eventData.urls) eventData.urls = [];

    eventData.urls.push({
        title: title || url,
        url: url,
        added: Date.now()
    });

    setEventData(currentTrackedFeature._eventId, eventData);
    renderUrlList(eventData.urls);
    urlTitle.value = '';
    urlAddress.value = '';
}

function deleteUrlItem(index) {
    if (!currentTrackedFeature) return;
    const eventData = currentTrackedFeature._currentEventData;
    eventData.urls.splice(index, 1);
    setEventData(currentTrackedFeature._eventId, eventData);
    renderUrlList(eventData.urls);
}



if (addUrlBtn) {
    addUrlBtn.addEventListener('click', addUrlItem);
} else {
    console.error('addUrlBtn not found!');
}


// Timeline Functions
function renderTimeline(events) {
    timelineDisplay.innerHTML = '';

    // Sort events by date (newest first)
    const sortedEvents = [...events].sort((a, b) => new Date(b.date) - new Date(a.date));

    sortedEvents.forEach((event, index) => {
        const eventEl = document.createElement('div');
        eventEl.className = 'timeline-event';

        const date = document.createElement('div');
        date.className = 'timeline-event-date';
        const d = new Date(event.date);
        const dateStr = d.toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        date.textContent = dateStr.replace(/\//g, '-');

        const title = document.createElement('div');
        title.className = 'timeline-event-title';
        title.textContent = event.title;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'timeline-event-delete';
        deleteBtn.textContent = '删除';
        deleteBtn.addEventListener('click', () => deleteTimelineEvent(events.findIndex(e => e.id === event.id)));

        eventEl.appendChild(date);
        eventEl.appendChild(title);
        if (event.description) {
            const desc = document.createElement('div');
            desc.className = 'timeline-event-description';
            desc.textContent = event.description;
            eventEl.appendChild(desc);
        }
        eventEl.appendChild(deleteBtn);

        timelineDisplay.appendChild(eventEl);
    });
}

function addTimelineEvent() {
    if (!currentTrackedFeature) return;
    const date = timelineDate.value;
    const title = timelineTitle.value.trim();

    if (!date || !title) {
        return;
    }


    const eventData = currentTrackedFeature._currentEventData;
    if (!eventData.timeline) eventData.timeline = [];

    eventData.timeline.push({
        id: Date.now(),
        date: date,
        title: title,
        description: '',
        type: 'event'
    });

    setEventData(currentTrackedFeature._eventId, eventData);
    renderTimeline(eventData.timeline);
    timelineDate.value = '';
    timelineTitle.value = '';
}

function deleteTimelineEvent(index) {
    if (!currentTrackedFeature) return;
    const eventData = currentTrackedFeature._currentEventData;
    eventData.timeline.splice(index, 1);
    setEventData(currentTrackedFeature._eventId, eventData);
    renderTimeline(eventData.timeline);
}


if (addTimelineBtn) {
    addTimelineBtn.addEventListener('click', addTimelineEvent);
} else {
    console.error('addTimelineBtn not found!');
}


// Save event data button
if (saveEventDataBtn) {
    saveEventDataBtn.addEventListener('click', () => {
        if (!currentTrackedFeature) {
            alert('没有选中的图层');
            return;
        }

        const eventData = currentTrackedFeature._currentEventData;
        eventData.notes = eventNotes.value;
        setEventData(currentTrackedFeature._eventId, eventData);

        alert('✅ 事件数据已保存到本地存储！\n\n数据与图层分开存储，刷新页面后重新打开事件追踪器即可查看。');
    });
} else {
    console.error('saveEventDataBtn not found!');
}


// Add click handler to features to open event tracker
map.on('click', (e) => {
    // Check if click is on a layer
    let clickedLayer = null;
    drawnItems.eachLayer(layer => {
        if (layer instanceof L.Marker) {
            const latlng = layer.getLatLng();
            const distance = map.distance(e.latlng, latlng);
            if (distance < 50) { // 50 meters threshold
                clickedLayer = layer;
            }
        } else if (layer instanceof L.Polygon || layer instanceof L.Polyline || layer instanceof L.Circle) {
            // Check if click is inside polygon/circle
            try {
                if (layer.getBounds && layer.getBounds().contains(e.latlng)) {
                    clickedLayer = layer;
                }
            } catch (err) {
                // Ignore bounds errors
            }
        }
    });

    // If shift key is pressed and a layer is clicked, open event tracker
    if (e.originalEvent.shiftKey && clickedLayer) {
        e.originalEvent.preventDefault();
        openEventTracker(clickedLayer);
    }
});

// ==== Debug: Verify Event Tracker Elements ==== //
console.log('=== Event Tracker Elements Debug ===');
console.log('eventTrackerPanel:', eventTrackerPanel ? 'FOUND' : 'NOT FOUND');
console.log('closeEventTrackerBtn:', closeEventTrackerBtn ? 'FOUND' : 'NOT FOUND');
console.log('saveEventDataBtn:', saveEventDataBtn ? 'FOUND' : 'NOT FOUND');
console.log('addTodoBtn:', addTodoBtn ? 'FOUND' : 'NOT FOUND');
console.log('addUrlBtn:', addUrlBtn ? 'FOUND' : 'NOT FOUND');
console.log('addTimelineBtn:', addTimelineBtn ? 'FOUND' : 'NOT FOUND');
console.log('===================================');

// ==== CRITICAL: Define Global Functions at End of Script ==== //
function closeEventTracker() {
    console.log('closeEventTracker() called!');
    try {
        // Auto-save current event if editing
        if (currentTrackedFeature && currentEditingEventId) {
            const events = getMarkerEvents(currentTrackedFeature);
            const eventIndex = events.findIndex(e => e.id === currentEditingEventId);
            if (eventIndex !== -1 && currentTrackedFeature._currentEventData) {
                events[eventIndex].name = document.getElementById('currentEventName')?.value || '未命名事件';
                events[eventIndex].notes = eventNotes?.value || '';
                events[eventIndex].todos = currentTrackedFeature._currentEventData.todos || [];
                events[eventIndex].urls = currentTrackedFeature._currentEventData.urls || [];
                events[eventIndex].timeline = currentTrackedFeature._currentEventData.timeline || [];
                saveMarkerEvents(currentTrackedFeature, events);
            }
        }
        document.getElementById('eventTrackerPanel').style.display = 'none';
        currentTrackedFeature = null;
        currentEditingEventId = null;
    } catch (e) {
        console.error('Error closing:', e);
    }
}

// Make sure functions are globally accessible
window.closeEventTracker = closeEventTracker;

console.log('Global functions defined:', typeof closeEventTracker, typeof saveCurrentEvent);

// ==== Initialize SelectionManager Listener for Layer Panel ==== //
setTimeout(() => {
    if (typeof selectionManager !== 'undefined') {
        selectionManager.onSelectionChange((event) => {
            // 更新图层面板中的选中高亮
            const layerItems = document.querySelectorAll('.layer-item');
            layerItems.forEach(item => {
                item.classList.remove('selected');
                if (event.current && item.dataset.layerId === String(L.stamp(event.current))) {
                    item.classList.add('selected');
                }
            });
        });
        console.log('SelectionManager layer panel listener registered');
    }

    // 初始化统计刷新
    if (typeof initLayerStatsRefresh === 'function') {
        initLayerStatsRefresh();
    }
}, 500);

// ==== Accordion Toggle Functions ==== //
function toggleAccordion(sectionId) {
    const section = document.getElementById(`accordion-${sectionId}`);
    if (section) {
        section.classList.toggle('collapsed');
    }

    // 如果切换离开历史 Accordion 且在浏览模式，自动退出
    if (sectionId !== 'history' && typeof exitHistoryBrowseModeSafe === 'function') {
        exitHistoryBrowseModeSafe();
    }
}

function expandAccordion(sectionId) {
    const controls = document.getElementById('controls');

    // 先展开面板
    if (controls && controls.classList.contains('collapsed')) {
        controls.classList.remove('collapsed');
        // 同步 body 类
        document.body.classList.remove('ui-collapsed');
    }

    // 如果展开的不是历史 Accordion，且当前在浏览模式，先退出
    if (sectionId !== 'history' && typeof exitHistoryBrowseModeSafe === 'function') {
        exitHistoryBrowseModeSafe();
    }

    // 展开对应 accordion
    const section = document.getElementById(`accordion-${sectionId}`);
    if (section) {
        section.classList.remove('collapsed');
    }
}

// 保留旧函数兼容
function toggleMapHistory() {
    toggleAccordion('history');
}

window.toggleAccordion = toggleAccordion;
window.expandAccordion = expandAccordion;
window.toggleMapHistory = toggleMapHistory;

// ==== Unified Tools Menu ==== //
function toggleToolsMenu() {
    const menu = document.getElementById('toolsMenu');
    const fab = document.getElementById('toolsFabBtn');

    if (menu && fab) {
        const isOpen = menu.classList.contains('open');
        if (isOpen) {
            menu.classList.remove('open');
            fab.classList.remove('active');
        } else {
            menu.classList.add('open');
            fab.classList.add('active');
        }
    }
}

function closeToolsMenu() {
    const menu = document.getElementById('toolsMenu');
    const fab = document.getElementById('toolsFabBtn');

    if (menu) menu.classList.remove('open');
    if (fab) fab.classList.remove('active');
}

window.toggleToolsMenu = toggleToolsMenu;
window.closeToolsMenu = closeToolsMenu;

// 点击其他地方关闭工具菜单
document.addEventListener('click', (e) => {
    const container = document.querySelector('.tools-fab-container');
    if (container && !container.contains(e.target)) {
        closeToolsMenu();
    }
});

// ==== Layer Details Panel - 图层详情面板 ==== //
function updateLayerDetailsPanel(selectedLayer = null) {
    const container = document.getElementById('layerDetailsContent');
    if (!container) return;

    // 收集所有标记
    const allMarkers = [];
    const processedMarkers = new Set();

    if (typeof drawnItems !== 'undefined') {
        drawnItems.eachLayer(layer => {
            if (layer instanceof L.Marker && !layer._isGroupMarker) {
                if (!processedMarkers.has(layer)) {
                    processedMarkers.add(layer);
                    allMarkers.push(layer);
                }
            }
        });
    }

    if (typeof markerGroupManager !== 'undefined' && markerGroupManager) {
        markerGroupManager.groups.forEach(group => {
            group.markers.forEach(marker => {
                if (!processedMarkers.has(marker)) {
                    processedMarkers.add(marker);
                    allMarkers.push(marker);
                }
            });
        });
    }

    if (allMarkers.length === 0) {
        container.innerHTML = '<div class="no-selection">暂无图层数据</div>';
        return;
    }

    // 统计类型和样式分布
    const styleStats = new Map();
    allMarkers.forEach(marker => {
        const props = marker.feature?.properties || {};
        const type = props.类型 || props.type || props.category || '未分类';
        const color = props['marker-color'] || '#4a90e2';
        const symbol = props['marker-symbol'] || 'default';

        const key = `${type}|${color}|${symbol}`;
        if (!styleStats.has(key)) {
            styleStats.set(key, { type, color, symbol, count: 0 });
        }
        styleStats.get(key).count++;
    });

    // 按数量排序
    const sortedStats = Array.from(styleStats.values())
        .sort((a, b) => b.count - a.count);

    // 计算同坐标组数
    let groupCount = 0;
    if (typeof markerGroupManager !== 'undefined' && markerGroupManager) {
        markerGroupManager.groups.forEach(group => {
            if (group.getCount() > 1) groupCount++;
        });
    }

    // 生成 HTML - 搜索栏
    let html = `
        <div class="layer-search-bar">
            <input type="text" id="layerSearchInput" placeholder="搜索名称/类型/地址..." oninput="filterLayerMarkers(this.value)">
            <button onclick="clearLayerSearch()" title="清除搜索"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="search-results-container" id="searchResultsContainer" style="display:none;"></div>
        
        <div class="layer-detail-row">
            <span class="detail-label">图层类型</span>
            <span class="detail-value">Point (标记)</span>
        </div>
        <div class="layer-detail-row">
            <span class="detail-label">标记数量</span>
            <span class="detail-value">${allMarkers.length} 个</span>
        </div>
        ${groupCount > 0 ? `
        <div class="layer-detail-row">
            <span class="detail-label">同坐标组</span>
            <span class="detail-value">${groupCount} 组</span>
        </div>
        ` : ''}
        
        <div class="style-distribution">
            <div class="distribution-title">样式分布 (${sortedStats.length} 种)</div>
            <div class="style-distribution-scroll">
    `;

    // 最多显示 10 个类型（可滚动）
    const displayStats = sortedStats.slice(0, 10);
    displayStats.forEach(stat => {
        const iconClass = getIconClass(stat.symbol);
        html += `
            <div class="style-stat-item">
                <span class="style-color" style="background-color: ${stat.color}"></span>
                <span class="style-icon"><i class="${iconClass}"></i></span>
                <span class="style-type">${stat.type}</span>
                <span class="style-count">${stat.count}</span>
            </div>
        `;
    });

    if (sortedStats.length > 10) {
        html += `<div class="style-more">还有 ${sortedStats.length - 10} 种类型...</div>`;
    }

    html += `</div></div>`;

    // 快捷操作
    html += `
        <div class="layer-quick-actions">
            <button onclick="exportCurrentLayerGeoJSON()" title="导出为 GeoJSON">
                <i class="fa-solid fa-download"></i> 导出
            </button>
        </div>
    `;

    container.innerHTML = html;

    // 保存标记列表供搜索使用
    window._layerDetailsMarkers = allMarkers;
}

// 图层搜索功能
function filterLayerMarkers(query) {
    const resultsContainer = document.getElementById('searchResultsContainer');
    if (!resultsContainer || !window._layerDetailsMarkers) return;

    if (!query || query.trim().length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }

    const lowerQuery = query.toLowerCase().trim();
    const matches = [];

    window._layerDetailsMarkers.forEach(marker => {
        const props = marker.feature?.properties || {};
        const name = (props.名称 || props.name || '').toLowerCase();
        const type = (props.类型 || props.type || '').toLowerCase();
        const address = (props.地址 || props.address || '').toLowerCase();

        if (name.includes(lowerQuery) || type.includes(lowerQuery) || address.includes(lowerQuery)) {
            matches.push({
                marker,
                name: props.名称 || props.name || '未命名',
                type: props.类型 || props.type || '',
                address: props.地址 || props.address || ''
            });
        }
    });

    if (matches.length === 0) {
        resultsContainer.innerHTML = '<div class="no-results">无匹配结果</div>';
        resultsContainer.style.display = 'block';
        return;
    }

    // 最多显示 5 个结果
    const displayMatches = matches.slice(0, 5);
    let html = '';
    displayMatches.forEach((match, index) => {
        html += `
            <div class="search-result-item" onclick="locateSearchResult(${index})">
                <span class="result-name">${match.name}</span>
                <span class="result-type">${match.type}</span>
            </div>
        `;
    });

    if (matches.length > 5) {
        html += `<div class="result-more">还有 ${matches.length - 5} 个结果...</div>`;
    }

    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';

    // 保存匹配结果供定位使用
    window._searchResults = matches;
}

function locateSearchResult(index) {
    if (!window._searchResults || !window._searchResults[index]) return;

    const marker = window._searchResults[index].marker;
    if (typeof locateMarkerOnMap === 'function') {
        locateMarkerOnMap(marker);
    }

    // 隐藏搜索结果
    const resultsContainer = document.getElementById('searchResultsContainer');
    if (resultsContainer) resultsContainer.style.display = 'none';
}

function clearLayerSearch() {
    const input = document.getElementById('layerSearchInput');
    const resultsContainer = document.getElementById('searchResultsContainer');

    if (input) input.value = '';
    if (resultsContainer) resultsContainer.style.display = 'none';
    window._searchResults = null;
}

window.filterLayerMarkers = filterLayerMarkers;
window.locateSearchResult = locateSearchResult;
window.clearLayerSearch = clearLayerSearch;

function getIconClass(symbol) {
    if (typeof MARKER_ICONS !== 'undefined' && MARKER_ICONS[symbol]) {
        return MARKER_ICONS[symbol].class;
    }
    return 'fa-solid fa-location-dot';
}

function exportCurrentLayerGeoJSON() {
    if (typeof exportGeoJSON === 'function') {
        exportGeoJSON();
    } else {
        // 备用导出逻辑
        const geoJSON = { type: 'FeatureCollection', features: [] };
        if (typeof drawnItems !== 'undefined') {
            drawnItems.eachLayer(layer => {
                if (layer.toGeoJSON) {
                    geoJSON.features.push(layer.toGeoJSON());
                }
            });
        }
        const blob = new Blob([JSON.stringify(geoJSON, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'layer_export.geojson';
        a.click();
        URL.revokeObjectURL(url);
    }
}

window.updateLayerDetailsPanel = updateLayerDetailsPanel;
window.exportCurrentLayerGeoJSON = exportCurrentLayerGeoJSON;

// 初始化时调用
setTimeout(() => {
    updateLayerDetailsPanel();
}, 800);

// ==== Clear All Layers ==== //
function clearAllLayers() {
    // 检查是否在浏览模式
    if (typeof timelineManager !== 'undefined' && timelineManager && timelineManager.isBrowseMode) {
        if (typeof showBriefMessage === 'function') {
            showBriefMessage('⚠️ 浏览模式下无法清空图层，请先退出');
        }
        return;
    }

    if (!confirm('确定要清空所有图层吗？此操作不可撤销。')) {
        return;
    }

    // 清空 MarkerGroupManager
    if (typeof markerGroupManager !== 'undefined' && markerGroupManager) {
        markerGroupManager.clear();
    }

    // 清空 drawnItems
    if (typeof drawnItems !== 'undefined') {
        drawnItems.clearLayers();
    }

    // 清空自定义组
    if (typeof customGroupManager !== 'undefined' && customGroupManager) {
        customGroupManager.groups.clear();
        customGroupManager.markerToGroups.clear();
        customGroupManager._renderGroupList();
    }

    // 清空选择
    if (typeof selectionManager !== 'undefined' && selectionManager) {
        selectionManager.clear();
    }

    // 刷新所有视图
    updateLayerList();

    if (typeof updateFeatureTable === 'function') {
        updateFeatureTable();
    }

    if (typeof updateDashboard === 'function') {
        updateDashboard();
    }

    if (typeof updateLayerStats === 'function') {
        updateLayerStats();
    }

    if (typeof updateGeoJSONEditor === 'function') {
        updateGeoJSONEditor();
    }

    if (typeof showBriefMessage === 'function') {
        showBriefMessage('🗑️ 已清空所有图层');
    }

    console.log('All layers cleared');
}

window.clearAllLayers = clearAllLayers;

// ==== Tools Menu Toggle ==== //
function toggleToolsMenu() {
    const menu = document.getElementById('toolsMenu');
    if (menu) {
        menu.classList.toggle('open');
    }
}

function closeToolsMenu() {
    const menu = document.getElementById('toolsMenu');
    if (menu) {
        menu.classList.remove('open');
    }
}

window.toggleToolsMenu = toggleToolsMenu;
window.closeToolsMenu = closeToolsMenu;

// 点击外部关闭工具菜单
document.addEventListener('click', (e) => {
    const container = document.querySelector('.tools-fab-container');
    if (container && !container.contains(e.target)) {
        closeToolsMenu();
    }
});

// ==== UI Collapsed State Management ==== //
function updateUICollapsedState() {
    const controls = document.getElementById('controls');
    if (controls && controls.classList.contains('collapsed')) {
        document.body.classList.add('ui-collapsed');
    } else {
        document.body.classList.remove('ui-collapsed');
    }
}

// 监听折叠按钮点击
document.addEventListener('DOMContentLoaded', () => {
    const toggleBtn = document.getElementById('toggleToolbarBtn');
    if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
            const controls = document.getElementById('controls');
            if (controls) {
                controls.classList.toggle('collapsed');
                updateUICollapsedState();
            }
        });
    }
});


// ========== property-editor.js ==========
// ==== Multi-Marker Smart Offset System ==== //
const OFFSET_DISTANCE = 0.0001; // ~10 meters at equator

// Find all markers at the same location
function findMarkersAtLocation(latlng, epsilon = 0.000001) {
    const markers = [];
    drawnItems.eachLayer(layer => {
        if (layer instanceof L.Marker) {
            const markerLatlng = layer.getLatLng();
            // Check original coordinates if available
            const origLat = layer.feature?.properties?._originalLat || markerLatlng.lat;
            const origLng = layer.feature?.properties?._originalLng || markerLatlng.lng;

            const dist = Math.sqrt(
                Math.pow(origLat - latlng.lat, 2) +
                Math.pow(origLng - latlng.lng, 2)
            );
            if (dist < epsilon) {
                markers.push(layer);
            }
        }
    });
    return markers;
}

// Apply circular offset to marker
function applySmartOffset(originalLatlng, offsetIndex) {
    if (offsetIndex === 0) {
        return originalLatlng;
    }
    const angle = (offsetIndex * 360 / 6) * (Math.PI / 180); // 6-point circle
    const offsetLat = originalLatlng.lat + (OFFSET_DISTANCE * Math.cos(angle));
    const offsetLng = originalLatlng.lng + (OFFSET_DISTANCE * Math.sin(angle));
    return L.latLng(offsetLat, offsetLng);
}

// ==== Property Drawer System ==== //
let currentEditingMarker = null;

// Open property drawer (replaces openPropertyEditor)
function openPropertyDrawer(marker) {
    if (!marker) {
        marker = selectedMarker || contextMenuTarget;
    }

    if (!marker) {
        console.warn('No marker to edit');
        return;
    }

    if (!(marker instanceof L.Marker)) {
        alert('属性编辑器仅支持标记');
        return;
    }

    currentEditingMarker = marker;

    // Ensure feature structure exists
    if (!marker.feature) {
        marker.feature = { type: 'Feature', properties: {}, geometry: {} };
    }
    if (!marker.feature.properties) {
        marker.feature.properties = {};
    }

    const props = marker.feature.properties;
    const latlng = marker.getLatLng();

    // Populate basic fields
    document.getElementById('propName').value = props.名称 || props.name || marker.options.name || '';
    document.getElementById('propType').value = props.类型 || props.type || '';
    document.getElementById('propAddress').value = props.地址 || props.address || '';

    // Display coordinates
    document.getElementById('propLat').textContent = latlng.lat.toFixed(6);
    document.getElementById('propLng').textContent = latlng.lng.toFixed(6);

    // Update icon preview
    updateIconPreviewInDrawer(props);

    // Render custom properties
    renderCustomProperties(props);

    // Show drawer with animation
    const drawer = document.getElementById('propertyDrawer');
    drawer.style.display = 'block';
    setTimeout(() => {
        drawer.classList.add('active');
    }, 10);

    // Hide context menu if open
    hideContextMenu();
}

// Alias for compatibility
window.openPropertyEditor = openPropertyDrawer;

function closePropertyDrawer() {
    const drawer = document.getElementById('propertyDrawer');
    drawer.classList.remove('active');
    setTimeout(() => {
        drawer.style.display = 'none';
        currentEditingMarker = null;
    }, 300);
}

function updateIconPreviewInDrawer(props) {
    const previewDiv = document.getElementById('currentIconPreview');
    const color = props['marker-color'] || '#4a90e2';
    const iconSymbol = props['marker-symbol'] || 'default';

    const iconConfig = MARKER_ICONS[iconSymbol] || MARKER_ICONS['default'];
    const iconClass = iconConfig.class;

    previewDiv.innerHTML = `
        <div class="preview-marker" style="background:${color};">
            <i class="${iconClass}"></i>
        </div>
    `;
}

function renderCustomProperties(props) {
    const container = document.getElementById('customPropertyList');

    // 判断是否为内部技术字段
    const isInternalField = (key) => {
        return key.startsWith('_') ||        // _originalLat, _originalLng, _offsetIndex
            key.startsWith('marker-') ||   // marker-color, marker-symbol, marker-size
            key === 'events';              // events 字段
    };

    // 基础字段（已在专门区域显示，不重复显示在自定义属性中）
    const basicDisplayedFields = ['name', 'type', 'address'];

    // 过滤规则：只排除内部技术字段和已经在基础信息区显示的字段
    // 所有其他字段（包括中文字段）都应该显示
    const customProps = Object.entries(props).filter(([key]) =>
        !isInternalField(key) && !basicDisplayedFields.includes(key)
    );

    if (customProps.length === 0) {
        container.innerHTML = '<p style="color:#666;font-size:0.85rem;text-align:center;padding:10px 0;">暂无自定义属性</p>';
        return;
    }

    container.innerHTML = customProps.map(([key, value]) => {
        const safeKey = key.replace(/'/g, "\\'");
        const safeValue = String(value || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        return `
            <div class="custom-prop-item">
                <span>${key}</span>
                <input type="text" value="${safeValue}" 
                       onchange="updateCustomPropertyValue('${safeKey}', this.value)" />
                <button onclick="deleteCustomProperty('${safeKey}')">删除</button>
            </div>
        `;
    }).join('');
}

function updateCustomPropertyValue(key, value) {
    if (currentEditingMarker && currentEditingMarker.feature) {
        currentEditingMarker.feature.properties[key] = value;
    }
}

function addCustomProperty() {
    if (!currentEditingMarker) return;

    const keyInput = document.getElementById('newPropKey');
    const valueInput = document.getElementById('newPropValue');
    const key = keyInput.value.trim();
    const value = valueInput.value.trim();

    if (!key) {
        keyInput.focus();
        return;
    }

    if (!currentEditingMarker.feature) {
        currentEditingMarker.feature = { type: 'Feature', properties: {}, geometry: {} };
    }
    if (!currentEditingMarker.feature.properties) {
        currentEditingMarker.feature.properties = {};
    }

    currentEditingMarker.feature.properties[key] = value;

    // Re-render
    renderCustomProperties(currentEditingMarker.feature.properties);

    // Clear inputs
    keyInput.value = '';
    valueInput.value = '';
}

function deleteCustomProperty(key) {
    if (!confirm(`确定删除属性 "${key}"？`)) return;

    if (currentEditingMarker && currentEditingMarker.feature && currentEditingMarker.feature.properties) {
        delete currentEditingMarker.feature.properties[key];
        renderCustomProperties(currentEditingMarker.feature.properties);
    }
}

function savePropertyChanges() {
    if (!currentEditingMarker) return;

    if (!currentEditingMarker.feature) {
        currentEditingMarker.feature = { type: 'Feature', properties: {}, geometry: {} };
    }
    if (!currentEditingMarker.feature.properties) {
        currentEditingMarker.feature.properties = {};
    }

    const props = currentEditingMarker.feature.properties;
    const nameVal = document.getElementById('propName').value.trim();
    const typeVal = document.getElementById('propType').value.trim();
    const addrVal = document.getElementById('propAddress').value.trim();

    // 优先保存回原始存在的字段
    if (props.名称 !== undefined) props.名称 = nameVal;
    else props.name = nameVal;

    if (props.类型 !== undefined) props.类型 = typeVal;
    else props.type = typeVal;

    if (props.地址 !== undefined) props.地址 = addrVal;
    else props.address = addrVal;

    // Update marker name in options
    currentEditingMarker.options.name = nameVal || '标记';

    // Refresh Popup if it's open
    if (typeof bindMarkerPopup === 'function') {
        bindMarkerPopup(currentEditingMarker);
    }

    // Refresh UI
    updateLayerList();
    updateGeoJSONEditor();
    closePropertyDrawer();

    // Show success message briefly
    showBriefMessage('✅ 属性已保存');
}

function showBriefMessage(msg) {
    const existingMsg = document.getElementById('_briefMsg');
    if (existingMsg) existingMsg.remove();

    const div = document.createElement('div');
    div.id = '_briefMsg';
    div.textContent = msg;
    div.style.cssText = `
        position: fixed;
        top: 20px;
        right: 420px;
        background: #4a90e2;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 10001;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease;
    `;
    document.body.appendChild(div);
    setTimeout(() => {
        div.style.opacity = '0';
        div.style.transition = 'opacity 0.3s';
        setTimeout(() => div.remove(), 300);
    }, 2000);
}

// Quick action functions
function copyCurrentCoordinates() {
    if (!currentEditingMarker) return;
    const latlng = currentEditingMarker.getLatLng();
    const text = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
    navigator.clipboard.writeText(text);
    showBriefMessage('📋 坐标已复制');
}

function changeIconFromDrawer() {
    if (!currentEditingMarker) return;
    contextMenuTarget = currentEditingMarker;
    openIconPicker();
}

function openEventTrackerFromDrawer() {
    if (!currentEditingMarker) return;
    closePropertyDrawer();
    setTimeout(() => {
        openEventTracker(currentEditingMarker);
    }, 350);
}

function deleteMarkerFromDrawer() {
    if (!currentEditingMarker) return;
    if (!confirm('确定删除此标记？')) return;

    drawnItems.removeLayer(currentEditingMarker);
    updateLayerList();
    updateGeoJSONEditor();
    closePropertyDrawer();
    showBriefMessage('🗑️ 标记已删除');
}

// Override closePropertyEditor for compatibility
window.closePropertyEditor = closePropertyDrawer;

// Make functions globally accessible
window.openPropertyDrawer = openPropertyDrawer;
window.closePropertyDrawer = closePropertyDrawer;
window.addCustomProperty = addCustomProperty;
window.deleteCustomProperty = deleteCustomProperty;
window.updateCustomPropertyValue = updateCustomPropertyValue;
window.savePropertyChanges = savePropertyChanges;
window.copyCurrentCoordinates = copyCurrentCoordinates;
window.changeIconFromDrawer = changeIconFromDrawer;
window.openEventTrackerFromDrawer = openEventTrackerFromDrawer;
window.deleteMarkerFromDrawer = deleteMarkerFromDrawer;

console.log('Property drawer system initialized');


// ========== table-view.js ==========
// ==== Table View Module (Tabulator.js) ==== //
let featureTable = null;
let isTableInitialized = false;

// 初始化表格
function initFeatureTable() {
    if (isTableInitialized) return;

    featureTable = new Tabulator("#featureTable", {
        height: "100%",
        layout: "fitDataStretch",
        virtualDom: true,              // 启用虚拟滚动
        virtualDomBuffer: 300,         // 缓冲行数
        placeholder: "暂无数据，请先在地图上添加标记",
        columns: getTableColumns(),
        rowClick: onTableRowClick,
        cellEdited: onCellEdited,
        initialSort: [{ column: "_id", dir: "asc" }],
        selectable: 1,                 // 启用单行选择
    });

    isTableInitialized = true;

    // 注册 SelectionManager 监听器（从地图/图层面板选中时同步到表格）
    if (typeof selectionManager !== 'undefined') {
        selectionManager.onSelectionChange((event) => {
            if (event.current && featureTable) {
                selectTableRowByLayer(event.current);
            }
        });
    }

    console.log('Feature table initialized');
}

// 根据图层选中表格行并滚动到可见区域
function selectTableRowByLayer(layer) {
    if (!featureTable) return;

    const layerId = L.stamp(layer);
    const rows = featureTable.getRows();

    for (const row of rows) {
        const rowData = row.getData();
        if (rowData._id === layerId || rowData._layer === layer) {
            // 取消其他选择
            featureTable.deselectRow();
            // 选中该行
            row.select();
            // 滚动到该行
            row.scrollTo();
            console.log('Table row selected:', rowData.name);
            break;
        }
    }
}

// 获取列定义
function getTableColumns() {
    return [
        {
            title: "ID",
            field: "_id",
            width: 80,
            frozen: true,
            headerFilter: "input",
            headerFilterPlaceholder: "搜索ID",
        },
        {
            title: "名称",
            field: "name",
            editor: "input",
            headerFilter: "input",
            headerFilterPlaceholder: "搜索名称",
        },
        {
            title: "类型",
            field: "type",
            editor: "input",
            headerFilter: "input",
            headerFilterPlaceholder: "搜索类型",
        },
        {
            title: "地址",
            field: "address",
            editor: "input",
            minWidth: 200,
        },
        {
            title: "经度",
            field: "lng",
            formatter: (cell) => cell.getValue() ? cell.getValue().toFixed(6) : '-',
            sorter: "number",
            width: 110,
        },
        {
            title: "纬度",
            field: "lat",
            formatter: (cell) => cell.getValue() ? cell.getValue().toFixed(6) : '-',
            sorter: "number",
            width: 110,
        },
        {
            title: "原始经度",
            field: "_originalLng",
            formatter: (cell) => {
                const val = cell.getValue();
                return val !== undefined ? val.toFixed(6) : '-';
            },
            width: 110,
            visible: false,  // 默认隐藏
        },
        {
            title: "原始纬度",
            field: "_originalLat",
            formatter: (cell) => {
                const val = cell.getValue();
                return val !== undefined ? val.toFixed(6) : '-';
            },
            width: 110,
            visible: false,  // 默认隐藏
        },
        {
            title: "偏移索引",
            field: "_offsetIndex",
            width: 90,
            visible: false,  // 默认隐藏
        },
        // 定位按钮列
        {
            title: "操作",
            field: "_actions",
            width: 80,
            frozen: true,
            hozAlign: "center",
            headerSort: false,
            formatter: function (cell, formatterParams, onRendered) {
                return '<button class="table-locate-btn" title="定位到地图"><i class="fa-solid fa-location-crosshairs"></i></button>';
            },
            cellClick: function (e, cell) {
                e.stopPropagation();  // 阻止冒泡到行点击
                const rowData = cell.getRow().getData();
                locateMarkerOnMap(rowData._layer);
            }
        },
    ];
}

// 从地图提取数据（包括分组中的标记）
function getTableData() {
    const data = [];
    const processedMarkers = new Set();

    // Helper function to process a marker
    const processMarker = (layer) => {
        if (!(layer instanceof L.Marker) || layer._isGroupMarker) return;
        if (processedMarkers.has(layer)) return;
        processedMarkers.add(layer);

        const props = layer.feature?.properties || {};
        const latlng = layer.getLatLng();

        const rowData = {
            _id: L.stamp(layer),
            _layer: layer,  // 保存图层引用
            name: props.名称 || props.name || layer.options.name || '',
            type: props.类型 || props.type || '',
            address: props.地址 || props.address || '',
            lat: latlng.lat,
            lng: latlng.lng,
            _originalLat: props._originalLat,
            _originalLng: props._originalLng,
            _offsetIndex: props._offsetIndex,
        };

        // 添加自定义属性
        const customProps = getCustomProperties(props);
        Object.assign(rowData, customProps);

        data.push(rowData);
    };

    // 首先从 drawnItems 获取
    if (typeof drawnItems !== 'undefined') {
        drawnItems.eachLayer(processMarker);
    }

    // 然后从 MarkerGroupManager 获取分组中的标记
    if (typeof markerGroupManager !== 'undefined' && markerGroupManager) {
        markerGroupManager.groups.forEach(group => {
            group.markers.forEach(processMarker);
        });
    }

    return data;
}

// 提取自定义属性（排除内部技术字段）
function getCustomProperties(props) {
    // 判断是否为内部技术字段
    const isInternalField = (key) => {
        return key.startsWith('_') ||        // _originalLat, _originalLng, _offsetIndex
            key.startsWith('marker-') ||   // marker-color, marker-symbol, marker-size
            key === 'events';              // events 字段
    };

    // 已在表格基础列中显示的字段
    const basicDisplayedFields = ['name', 'type', 'address', 'lat', 'lng'];

    const custom = {};

    for (const [key, value] of Object.entries(props)) {
        // 只过滤内部字段和已显示的基础字段
        if (!isInternalField(key) && !basicDisplayedFields.includes(key)) {
            custom[key] = value;
        }
    }

    return custom;
}

// 更新表格数据与列结构
function updateFeatureTable() {
    if (!featureTable) {
        console.warn('Table not initialized');
        return;
    }

    const data = getTableData();

    // 动态提取所有唯一的自定义属性键
    const allKeys = new Set();
    data.forEach(row => {
        Object.keys(row).forEach(key => {
            if (!key.startsWith('_') &&
                !['name', 'type', 'address', 'lat', 'lng', '_layer'].includes(key)) {
                allKeys.add(key);
            }
        });
    });

    // 基础列
    const columns = getTableColumns();

    // 追加动态列
    allKeys.forEach(key => {
        columns.push({
            title: key,
            field: key,
            editor: "input",
            headerFilter: "input",
            minWidth: 100,
            sorter: "string"
        });
    });

    // 更新列定义和数据
    featureTable.setColumns(columns);
    featureTable.setData(data);

    console.log(`Table updated with ${data.length} rows and ${columns.length} columns`);
}

// 表格行点击事件（只做选中，不做定位）
function onTableRowClick(e, row) {
    const data = row.getData();
    const layer = data._layer;

    if (!layer) {
        console.warn('Layer not found for row');
        return;
    }

    // 使用 SelectionManager 统一管理选中状态
    if (typeof selectionManager !== 'undefined') {
        selectionManager.select(layer);
    }

    console.log('Table row selected:', data.name);
}

// 定位标记到地图（由定位按钮触发）
function locateMarkerOnMap(layer) {
    if (!layer) {
        console.warn('Layer not found for locate');
        return;
    }

    // 如果标记属于某个组，先展开该组
    if (typeof markerGroupManager !== 'undefined' && markerGroupManager) {
        markerGroupManager.expandGroupForMarker(layer);
    }

    // 地图定位到该标记
    const latlng = layer.getLatLng();
    if (typeof map !== 'undefined') {
        map.flyTo(latlng, Math.max(map.getZoom(), 16), {
            animate: true,
            duration: 0.5
        });
    }

    // 使用 SelectionManager 统一管理选中状态
    if (typeof selectionManager !== 'undefined') {
        selectionManager.select(layer);
    }

    // 高亮标记
    if (typeof highlightMarker === 'function') {
        highlightMarker(layer);
    }

    // 获取名称显示提示
    const props = layer.feature?.properties || {};
    const name = props.名称 || props.name || '标记';
    if (typeof showBriefMessage === 'function') {
        showBriefMessage(`📍 已定位到: ${name}`);
    }

    console.log('Marker located on map:', name);
}

// 全局暴露
window.locateMarkerOnMap = locateMarkerOnMap;

// 单元格编辑回写
function onCellEdited(cell) {
    const field = cell.getField();
    const value = cell.getValue();
    const rowData = cell.getRow().getData();
    const layer = rowData._layer;

    if (!layer || !layer.feature) {
        console.warn('Cannot update layer properties');
        return;
    }

    // 回写到 feature properties
    if (field === 'name') {
        layer.feature.properties.name = value;
        layer.options.name = value;
    } else if (field === 'type' || field === 'address') {
        layer.feature.properties[field] = value;
    } else {
        // 自定义字段
        layer.feature.properties[field] = value;
    }

    // 更新其他视图
    if (typeof updateLayerList === 'function') {
        updateLayerList();
    }
    if (typeof updateGeoJSONEditor === 'function') {
        updateGeoJSONEditor();
    }

    console.log(`Cell edited: ${field} = ${value}`);
}

// 地图标记选中同步到表格
function syncMapToTable(layer) {
    if (!featureTable) return;

    const id = layer._leaflet_id;

    // 取消所有选中
    featureTable.deselectRow();

    // 选中对应行
    const row = featureTable.getRow(id);
    if (row) {
        row.select();
        row.scrollTo();
    }
}

// 切换表格显示/隐藏
function toggleTableView() {
    const panel = document.getElementById('tableViewPanel');
    const isOpen = panel.classList.contains('open');

    if (!isOpen) {
        // 展开表格
        panel.classList.add('open');

        // 初始化（如果是第一次）
        if (!isTableInitialized) {
            initFeatureTable();
        }

        // 更新数据
        updateFeatureTable();

        // 触发地图重绘以适应新布局
        setTimeout(() => {
            if (typeof map !== 'undefined') {
                map.invalidateSize();
            }
        }, 350);
    } else {
        // 收起表格
        panel.classList.remove('open');

        // 触发地图重绘
        setTimeout(() => {
            if (typeof map !== 'undefined') {
                map.invalidateSize();
            }
        }, 350);
    }
}

// 关闭表格
function closeTableView() {
    const panel = document.getElementById('tableViewPanel');
    panel.classList.remove('open');

    // 触发地图重绘
    setTimeout(() => {
        if (typeof map !== 'undefined') {
            map.invalidateSize();
        }
    }, 350);
}

// 全局暴露函数
window.initFeatureTable = initFeatureTable;
window.updateFeatureTable = updateFeatureTable;
window.syncMapToTable = syncMapToTable;
window.toggleTableView = toggleTableView;
window.closeTableView = closeTableView;

// DOM 加载完成后绑定事件
document.addEventListener('DOMContentLoaded', () => {
    // 切换按钮
    const toggleBtn = document.getElementById('toggleTableBtn');
    if (toggleBtn) {
        toggleBtn.addEventListener('click', toggleTableView);
    }

    // 关闭按钮
    const closeBtn = document.getElementById('closeTableBtn');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeTableView);
    }

    // 刷新按钮
    const refreshBtn = document.getElementById('refreshTableBtn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
            updateFeatureTable();
            showBriefMessage('✅ 表格已刷新');
        });
    }

    // 拖拽调整高度
    initTableDragResize();

    console.log('Table view module loaded');
});

// ==== Table Drag Resize ==== //
function initTableDragResize() {
    const handle = document.getElementById('tableDragHandle');
    const panel = document.getElementById('tableViewPanel');

    if (!handle || !panel) return;

    let isDragging = false;
    let startY = 0;
    let startHeight = 0;
    const minHeight = 200;
    const maxHeight = window.innerHeight * 0.7;

    handle.addEventListener('mousedown', (e) => {
        isDragging = true;
        startY = e.clientY;
        startHeight = panel.offsetHeight;
        document.body.style.cursor = 'ns-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;

        const deltaY = startY - e.clientY;
        let newHeight = startHeight + deltaY;

        // 限制高度范围
        newHeight = Math.max(minHeight, Math.min(maxHeight, newHeight));

        panel.style.height = newHeight + 'px';
    });

    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';

            // 刷新地图尺寸
            if (typeof map !== 'undefined') {
                map.invalidateSize();
            }

            // 刷新表格
            if (featureTable) {
                featureTable.redraw();
            }
        }
    });
}

window.initTableDragResize = initTableDragResize;

</script>
</body>

</html>