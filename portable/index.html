<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoJSON 地图编辑器 - Portable</title>

    <!-- ============================================
         外部 CDN 依赖（联网时自动加载）
         如需离线使用，请将这些库下载到 assets/ 目录
         ============================================ -->
    <!-- FontAwesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <!-- Leaflet.draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"
        crossorigin="" />
    <!-- Tabulator CSS (dark theme) -->
    <link href="https://unpkg.com/tabulator-tables@5.5/dist/css/tabulator_midnight.min.css" rel="stylesheet">

    <!-- ============================================
         本地样式（已复制到 css/ 目录）
         ============================================ -->
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/table-view-styles.css" />

    <!-- html2canvas for screenshot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>
    <!-- 左侧悬浮控制面板 -->
    <div id="controls" class="panel">
        <div class="panel-header">
            <h2>地图控制</h2>
            <button id="toggleToolbarBtn" class="btn-toggle-toolbar" title="收起/展开">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
        </div>

        <!-- Dock 模式图标列表 -->
        <div class="dock-icons">
            <div class="dock-icon" data-tooltip="搜索定位" onclick="expandAccordion('search')">
                <i class="fa-solid fa-magnifying-glass"></i>
            </div>
            <div class="dock-icon" data-tooltip="数据导入导出" onclick="expandAccordion('data')">
                <i class="fa-solid fa-file-import"></i>
            </div>
            <div class="dock-icon" data-tooltip="图层面板" onclick="toggleLayerPanel()">
                <i class="fa-solid fa-layer-group"></i>
            </div>
            <div class="dock-icon" data-tooltip="历史地图" onclick="expandAccordion('history')">
                <i class="fa-solid fa-clock-rotate-left"></i>
            </div>
            <div class="dock-icon" data-tooltip="高级工具" onclick="expandAccordion('tools')">
                <i class="fa-solid fa-wrench"></i>
            </div>
        </div>

        <div class="panel-content">
            <!-- 搜索定位 Accordion -->
            <div class="accordion-section open" id="accordion-search">
                <div class="accordion-header" onclick="toggleAccordion('search')">
                    <h3><i class="fa-solid fa-magnifying-glass"></i> 搜索定位</h3>
                    <span class="collapse-icon"><i class="fa-solid fa-chevron-down"></i></span>
                </div>
                <div class="accordion-content">
                    <div class="control-group">
                        <label for="searchAddress">地址搜索</label>
                        <div class="input-row">
                            <input type="text" id="searchAddress" placeholder="输入地址..." />
                            <button id="searchBtn" class="btn-primary"><i class="fa-solid fa-search"></i></button>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>坐标定位</label>
                        <div class="coord-row">
                            <input type="number" id="gotoLat" placeholder="纬度" step="any" />
                            <input type="number" id="gotoLng" placeholder="经度" step="any" />
                            <button id="gotoCoordBtn" class="btn-secondary">
                                <i class="fa-solid fa-location-crosshairs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 数据导入导出 Accordion -->
            <div class="accordion-section collapsed" id="accordion-data">
                <div class="accordion-header" onclick="toggleAccordion('data')">
                    <h3><i class="fa-solid fa-file-import"></i> 数据导入导出</h3>
                    <span class="collapse-icon"><i class="fa-solid fa-chevron-down"></i></span>
                </div>
                <div class="accordion-content">
                    <!-- GeoJSON 导入 -->
                    <div class="control-group">
                        <label>导入 GeoJSON</label>
                        <input type="file" id="geojsonFileInput" accept=".geojson,.json" />
                    </div>
                    <!-- Excel 导入导出 -->
                    <div class="control-group">
                        <label>Excel 导入导出</label>
                        <div class="button-row">
                            <button id="exportExcelBtn" class="btn-secondary">
                                <i class="fa-solid fa-file-excel"></i> 导出Excel
                            </button>
                            <button id="downloadTemplateBtn" class="btn-secondary">
                                <i class="fa-solid fa-download"></i> 模板
                            </button>
                        </div>
                        <input type="file" id="excelFile" accept=".xlsx,.xls" style="margin-top: 8px;" />
                    </div>
                    <!-- CSV 导入 -->
                    <div class="control-group">
                        <label>导入 CSV</label>
                        <input type="file" id="coordFileInput" accept=".csv,.txt" />
                    </div>
                    <!-- 导出按钮 -->
                    <div class="control-group">
                        <label>导出 CSV</label>
                        <button id="exportCSVBtn" class="btn-secondary full-width">
                            <i class="fa-solid fa-file-csv"></i> 导出 CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- 历史地图（默认折叠） -->
            <div class="accordion-section collapsed" id="accordion-history">
                <div class="accordion-header" onclick="toggleAccordion('history')">
                    <h3><i class="fa-solid fa-clock-rotate-left"></i> 历史地图</h3>
                    <div class="accordion-header-actions">
                        <button onclick="event.stopPropagation(); timelineManager && timelineManager.enterBrowseMode()"
                            title="浏览模式" class="btn-icon">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                        <button
                            onclick="event.stopPropagation(); timelineManager && timelineManager.saveSnapshotPrompt()"
                            title="保存快照" class="btn-icon">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                        <span class="collapse-icon"><i class="fa-solid fa-chevron-down"></i></span>
                    </div>
                </div>
                <div class="accordion-content">
                    <div id="timelineList" class="timeline-list">
                        <div class="timeline-empty">暂无历史记录</div>
                    </div>
                </div>
            </div>

            <!-- 高级工具（默认折叠） -->
            <div class="accordion-section collapsed" id="accordion-tools">
                <div class="accordion-header" onclick="toggleAccordion('tools')">
                    <h3><i class="fa-solid fa-wrench"></i> 高级工具</h3>
                    <span class="collapse-icon"><i class="fa-solid fa-chevron-down"></i></span>
                </div>
                <div class="accordion-content">
                    <div class="control-group">
                        <button id="togglePickerBtn" class="btn-secondary full-width">
                            <i class="fa-solid fa-crosshairs"></i> 启用坐标拾取
                        </button>
                    </div>
                    <div class="control-group" id="pickedCoordsDiv" style="display:none;"></div>
                    <div class="control-group">
                        <button id="addManualMarkerBtn" class="btn-secondary full-width">
                            <i class="fa-solid fa-location-dot"></i> 点击地图添加
                        </button>
                    </div>
                    <div class="control-group">
                        <button id="toggleLayerPanelBtn" class="btn-secondary" onclick="toggleLayerPanel()">
                            <i class="fa-solid fa-layer-group"></i> 显示图层面板
                        </button>
                    </div>
                    <div class="control-group">
                        <label for="markerIconSelect">标记图标样式</label>
                        <select id="markerIconSelect">
                            <option value="default">默认图标</option>
                            <option value="star">星形</option>
                            <option value="flag">旗帜</option>
                            <option value="building">建筑</option>
                            <option value="gas-pump">加油站</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>标记标签</label>
                        <div class="checkbox-row">
                            <input type="checkbox" id="showLabelsCheckbox">
                            <label for="showLabelsCheckbox">显示名称标签</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 右侧图层面板 -->
    <div id="layerPanel" class="floating-panel layer-panel">
        <!-- 固定头部 -->
        <div class="layer-panel-header">
            <div class="layer-panel-title">
                <h2><i class="fa-solid fa-layer-group"></i> 图层管理</h2>
                <button id="closeLayerPanelBtn" class="btn-icon" onclick="toggleLayerPanel()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <!-- 搜索栏 -->
            <div class="layer-search-container">
                <input type="text" id="layerSearchInput" placeholder="搜索图层..." oninput="filterLayerMarkers(this.value)">
                <button class="btn-icon" onclick="clearLayerSearch()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>

        <!-- 可滚动内容 -->
        <div class="layer-panel-content">
            <!-- 图层列表 -->
            <div class="layer-section open" id="layerListSection">
                <div class="layer-section-header" onclick="toggleLayerSection('layerListSection')">
                    <span><i class="fa-solid fa-list"></i> 图层列表</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
                <div class="layer-section-content">
                    <div id="layerList" class="layer-list"></div>
                    <!-- 搜索结果 -->
                    <div id="searchResultsContainer" class="search-results-container" style="display: none;">
                        <div class="search-results-header">
                            <span id="searchResultsCount">搜索结果</span>
                        </div>
                        <div id="searchResultsList" class="search-results-list"></div>
                    </div>
                </div>
            </div>

            <!-- 图层详情 -->
            <div class="layer-section collapsed" id="layerDetailsSection">
                <div class="layer-section-header" onclick="toggleLayerSection('layerDetailsSection')">
                    <span><i class="fa-solid fa-info-circle"></i> 图层详情</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
                <div class="layer-section-content">
                    <div id="layerDetails" class="layer-details">
                        <p class="no-selection">点击图层查看详情</p>
                    </div>
                </div>
            </div>

            <!-- 统计汇总 -->
            <div class="layer-section collapsed" id="layerStatsSection">
                <div class="layer-section-header" onclick="toggleLayerSection('layerStatsSection')">
                    <span><i class="fa-solid fa-chart-pie"></i> 统计汇总</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
                <div class="layer-section-content">
                    <div id="layerStats" class="layer-stats"></div>
                </div>
            </div>
        </div>

        <!-- 底部操作按钮 -->
        <div class="layer-panel-footer">
            <button class="btn-secondary" onclick="exportCurrentLayerGeoJSON()">
                <i class="fa-solid fa-download"></i> 导出 GeoJSON
            </button>
        </div>
    </div>

    <!-- 地图容器 -->
    <div id="map"></div>

    <!-- 事件追踪器面板 -->
    <div id="eventTrackerPanel" class="event-tracker-panel">
        <div class="event-tracker-header">
            <h3><i class="fa-solid fa-timeline"></i> 事件追踪器</h3>
            <button class="btn-icon" onclick="closeEventTracker()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="event-tracker-content">
            <div id="eventTrackerMarkerInfo" class="event-tracker-marker-info"></div>
            <div id="eventList" class="event-list"></div>
            <div class="event-tracker-actions">
                <button id="addEventBtn" class="btn-primary">
                    <i class="fa-solid fa-plus"></i> 添加事件
                </button>
            </div>
        </div>
    </div>

    <!-- 右键菜单 -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" onclick="editMarkerProperties()">
            <i class="fa-solid fa-pen"></i> 编辑属性
        </div>
        <div class="context-menu-item" onclick="openEventTracker()">
            <i class="fa-solid fa-timeline"></i> 事件追踪
        </div>
        <div class="context-menu-item" onclick="changeMarkerIcon()">
            <i class="fa-solid fa-icons"></i> 更换图标
        </div>
        <div class="context-menu-item" onclick="deleteMarker()">
            <i class="fa-solid fa-trash"></i> 删除标记
        </div>
    </div>

    <!-- 图标选择器 Modal -->
    <div id="iconPickerModal" class="modal-overlay">
        <div class="modal-content icon-picker-modal">
            <div class="modal-header">
                <h3>选择图标</h3>
                <button class="btn-icon" onclick="closeIconPicker()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="iconGrid" class="icon-grid"></div>
            </div>
        </div>
    </div>

    <!-- 分享功能 Modal -->
    <div id="shareModal" class="modal-overlay">
        <div class="modal-content share-modal">
            <div class="modal-header">
                <h3><i class="fa-solid fa-share-nodes"></i> 分享地图</h3>
                <button class="btn-icon" onclick="closeShareModal()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="share-options">
                    <button class="share-option" onclick="shareAsImage()">
                        <i class="fa-solid fa-image"></i>
                        <span>保存为图片</span>
                    </button>
                    <button class="share-option" onclick="shareAsGeoJSON()">
                        <i class="fa-solid fa-code"></i>
                        <span>导出 GeoJSON</span>
                    </button>
                    <button class="share-option" onclick="copyShareLink()">
                        <i class="fa-solid fa-link"></i>
                        <span>复制链接</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- GeoJSON 导入对话框 -->
    <div id="geojsonImportModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fa-solid fa-file-import"></i> 导入 GeoJSON</h3>
                <button class="btn-icon" onclick="closeGeoJSONImportModal()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>检测到现有数据。请选择导入方式：</p>
                <div class="import-options">
                    <button class="import-option" id="importMergeBtn">
                        <i class="fa-solid fa-object-group"></i>
                        <span>合并</span>
                        <small>保留现有数据并添加新数据</small>
                    </button>
                    <button class="import-option" id="importReplaceBtn">
                        <i class="fa-solid fa-rotate"></i>
                        <span>替换</span>
                        <small>清空现有数据后导入</small>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- GeoJSON 代码编辑器模态框 -->
    <div id="geojsonEditorModal" class="modal-overlay">
        <div class="modal-content geojson-editor-modal">
            <div class="modal-header">
                <h3><i class="fa-solid fa-code"></i> GeoJSON 编辑器</h3>
                <div class="modal-header-actions">
                    <button class="btn-secondary" onclick="copyGeoJSONToClipboard()">
                        <i class="fa-solid fa-copy"></i> 复制
                    </button>
                    <button class="btn-primary" onclick="applyGeoJSONFromEditor()">
                        <i class="fa-solid fa-check"></i> 应用
                    </button>
                    <button class="btn-icon" onclick="closeGeoJSONEditorModal()">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <textarea id="geojsonEditorTextarea" spellcheck="false"></textarea>
                <div id="geojsonEditorError" class="editor-error"></div>
            </div>
        </div>
    </div>

    <!-- 表格视图面板 -->
    <div id="tableViewPanel" class="table-view-panel">
        <div id="tableDragHandle" class="table-drag-handle">
            <i class="fa-solid fa-grip-lines"></i>
        </div>
        <div class="table-header">
            <div class="table-title">
                <i class="fa-solid fa-table"></i> 数据表格
            </div>
            <div class="table-actions">
                <button id="refreshTableBtn" class="btn-icon" title="刷新表格">
                    <i class="fa-solid fa-rotate"></i>
                </button>
                <button id="closeTableBtn" class="btn-icon" title="关闭表格">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>
        <div class="table-container">
            <div id="featureTable"></div>
        </div>
    </div>

    <!-- 右下角工具入口 -->
    <div class="tools-fab-container">
        <button class="tools-fab" onclick="toggleToolsMenu()" title="工具菜单">
            <i class="fa-solid fa-toolbox"></i>
        </button>
        <div id="toolsMenu" class="tools-menu">
            <button class="tools-menu-item" onclick="toggleTableView(); closeToolsMenu();">
                <i class="fa-solid fa-table"></i> 表格视图
            </button>
            <button class="tools-menu-item" onclick="toggleDashboard(); closeToolsMenu();">
                <i class="fa-solid fa-chart-pie"></i> 看板统计
            </button>
            <button class="tools-menu-item" onclick="openGeoJSONEditorModal(); closeToolsMenu();">
                <i class="fa-solid fa-code"></i> 代码编辑
            </button>
        </div>
    </div>

    <!-- 看板面板 -->
    <div id="dashboardPanel" class="dashboard-panel">
        <div class="dashboard-header">
            <h3><i class="fa-solid fa-chart-pie"></i> 数据看板</h3>
            <button class="btn-icon" onclick="closeDashboard()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div id="dashboardContent" class="dashboard-content"></div>
    </div>

    <!-- 属性编辑器抽屉 -->
    <div id="propertyDrawer" class="property-drawer">
        <div class="property-drawer-header">
            <h3><i class="fa-solid fa-pen-to-square"></i> 属性编辑</h3>
            <button class="btn-icon" onclick="closePropertyDrawer()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div id="propertyContent" class="property-drawer-content"></div>
    </div>

    <!-- ============================================
         外部 CDN JavaScript 依赖
         ============================================ -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <!-- Leaflet.draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" crossorigin=""></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"
        crossorigin="anonymous"></script>
    <!-- SheetJS for Excel support -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Tabulator JS -->
    <script src="https://unpkg.com/tabulator-tables@5.5/dist/js/tabulator.min.js"></script>

    <!-- ============================================
         本地脚本（按依赖顺序加载）
         加载顺序说明：
         0. api-hooks.js - API 挂接点（后端集成入口）
         1. marker-group.js - 组合标记管理
         2. selection-manager.js - 选中状态管理（单例）
         3. layer-stats.js - 图层统计
         4. custom-group-manager.js - 自定义组管理
         5. timeline-manager.js - 历史快照管理
         6. dashboard-panel.js - 看板面板
         7. script.js - 主逻辑（依赖上述所有模块）
         8. property-editor.js - 属性编辑器
         9. table-view.js - 表格视图
         ============================================ -->
    <script src="js/api-hooks.js"></script>
    <script src="js/marker-group.js"></script>
    <script src="js/selection-manager.js"></script>
    <script src="js/layer-stats.js"></script>
    <script src="js/custom-group-manager.js"></script>
    <script src="js/timeline-manager.js"></script>
    <script src="js/dashboard-panel.js"></script>
    <script src="js/script.js"></script>
    <script src="js/property-editor.js"></script>
    <script src="js/table-view.js"></script>
</body>

</html>